0001   0000             ;---------------------------------------
0002   0000             ; CLI (Command Line Interface) Plugin
0003   0000             ; (C) breeze/fishbone crew 2012
0004   0000             ;---------------------------------------
0005   0000             
0006   0000                     DEVICE ZXSPECTRUM128
0007   0000             
0008   0000             		org	#be00
0009   BE00 20          edit256		ds	128," "				; 128 bytes ascii
0010   BE80 5F          		ds	128,defaultCol			; 128 bytes colors
0011   BF00             		
0012   BF00             		org	#bf00
0013   BF00             
0014   BF00 20          bufer256	ds	128," "				; 128 bytes ascii
0015   BF80 5F          		ds	128,defaultCol			; 128 bytes colors
0016   C000             
0017   C000             		org	#6000
0018   6000             
0019   6000             termWidth	equ	80
0020   6000             termHeight	equ	30
0021   6000             defaultCol	equ	%01011111
0022   6000             cursorType	equ	"_"
0023   6000             iBufferSize	equ	255
0024   6000             historySize	equ	10
0025   6000             eBufferSize	equ	iBufferSize
0026   6000             bufferAddr	equ	#0000
0027   6000             pathStrSize	equ	255*4
0028   6000             
0029   6000             colorDir	equ	15				; white
0030   6000             colorFile	equ	8				; silver
0031   6000             colorRO		equ	1				; navy
0032   6000             colorHidden	equ	13				; teal
0033   6000             colorSystem	equ	2				; amiga pink
0034   6000             colorArch	equ	3				; dark violet
0035   6000             
0036   6000             colorError	equ	10				; red
0037   6000             colorWarning	equ	14				; yellow
0038   6000             colorOk		equ	12				; lime
0039   6000             colorInfo	equ	13				; teal
0040   6000             	
0041   6000             cliTxtPages	equ	5				; size Buffer for cli print (5 pages)
0042   6000             cliTxtBegin	equ	#20				; start page
0043   6000             
0044   6000             scopeBinAddr	equ	#c000				; /bin list address start
0045   6000             scopeBinBank	equ	#03				; /bin application list
0046   6000             
0047   6000             palAddr		equ	#fc00				; palette file load address
0048   6000             palBank		equ	#03				; palette file load memory bank
0049   6000             
0050   6000             gPalAddr	equ	#fe00				; graphics palette file load address
0051   6000             gPalBank	equ	#03				; graphics palette file load memory bank
0052   6000             
0053   6000             appAddr		equ	#c000				; application load address
0054   6000             appBank		equ	#04				; application load memory bank
0055   6000             
0056   6000             tmpAddr		equ	#c000				; temp buffer load address
0057   6000             tmpBank		equ	#07				; temp buffer load bank
0058   6000             
0059   6000             sprAddr		equ	#c000				; sprites load address
0060   6000             sprBank		equ	#08				; sprites load memory bank
0061   6000             
0062   6000             		include "wcKernel.h.asm"
0001+  6000             ;---------------------------------------
0002+  6000             ; WildCommander API Header
0003+  6000             ;---------------------------------------
0004+  6000             _WCINT		equ	#5BFF	; адрес обработки int wild commander
0005+  6000             
0006+  6000             _PAGE0		equ	#6000	; номер страницы подключенной с адреса #0000-#3fff
0007+  6000             _PAGE1		equ	#6001	; номер страницы подключенной с адреса #4000-#7fff
0008+  6000             _PAGE2		equ	#6002	; номер страницы подключенной с адреса #8000-#dfff
0009+  6000             _PAGE3		equ	#6003	; номер страницы подключенной с адреса #c000-#ffff
0010+  6000             
0011+  6000             _TMN		equ	#6009	; синхра. переменная-таймер, инкрементится по инту
0012+  6000             
0013+  6000             _MNGC_PL	equ	#00	; включение страницы на #C000 (из выделенного блока)
0014+  6000             				; нумерация совпадает с использующейся в +36
0015+  6000             				; i:A' - номер страницы (от 0)
0016+  6000             				;   #FF - страница с фонтом (1го текстового экрана)
0017+  6000             				;   #FE - первый текстовый экран (в нём панели)
0018+  6000             
0019+  6000             _PRWOW		equ	#01	; вывод окна на экран
0020+  6000             				; i:IX - адрес по которому лежит структура окна (SOW)
0021+  6000             
0022+  6000             _RRESB		equ	#02	; cтирание окна (восстановление информации)
0023+  6000             				; i:IX - SOW
0024+  6000             
0025+  6000             _PRSRW		equ	#03	; печать строки в окне
0026+  6000             				; i:IX - SOW
0027+  6000             				;   HL - Text addres (должен быть в #8000-#BFFF!)
0028+  6000             				;   D - Y
0029+  6000             				;   E - X
0030+  6000             				;   BC - Lenght
0031+  6000             
0032+  6000             _PRIAT		equ	#04	; выставление цвета (вызывается сразу после PRSRW)
0033+  6000             				; i:PRSRW - выставленные координаты и длина
0034+  6000             				;   A' - цвет
0035+  6000             
0036+  6000             _GADRW		equ	#05	; получение адреса в окне
0037+  6000             				; i:IX - SOW
0038+  6000             				;   D - Y
0039+  6000             				;   E - X
0040+  6000             				; o:HL - Address
0041+  6000             
0042+  6000             _CURSOR		equ	#06	; печать курсора
0043+  6000             				; i:IX - SOW
0044+  6000             
0045+  6000             _CURSER		equ	#07	; стирание курсора (восстановление цвета)
0046+  6000             				; i:IX - SOW
0047+  6000             
0048+  6000             _YN		equ	#08	; меню ok/cancel
0049+  6000             				; i:A'
0050+  6000             				;   #01 - инициализация (вычисляет координаты)
0051+  6000             				;   #00 - обработка нажатий (вызывать раз в фрейм)
0052+  6000             				;   #FF - выход
0053+  6000             				; o:NZ - выбран CANCEL
0054+  6000             				;   Z - выбран OK
0055+  6000             
0056+  6000             _ISTR		equ	#09	; редактирование строки
0057+  6000             				; i:A'
0058+  6000             				;   #FF - инициализация (рисует курсор)
0059+  6000             				; i:HL - адрес строки
0060+  6000             				;   DE - CURMAX+CURNOW (длина строки + начальная позиция курсора в ней)
0061+  6000             				;   #00 - опрос клавиатуры
0062+  6000             				;         >опрашивает LF,RG,BackSpace
0063+  6000             				;         >собственно редактируется строка
0064+  6000             				;         >нужно вызывать каждый фрейм
0065+  6000             				;   #01 - выход (стирает курсор)
0066+  6000             
0067+  6000             _NORK		equ	#0a	; перевод байта в HEX (текстовый формат)
0068+  6000             				; i:HL - Text Address
0069+  6000             				;   A - Value
0070+  6000             ;		equ	#0b
0071+  6000             ;		equ	#0c
0072+  6000             
0073+  6000             _DMAPL		equ	#0d	; работа с DMA
0074+  6000             				; i: A' - тип операции
0075+  6000             				; #00 - инит S и D (BHL - Source, CDE - Destination)
0076+  6000             				; #01 - инит S (BHL)
0077+  6000             				; #02 - инит D (CDE)
0078+  6000             				; #03 - инит S с пагой из окна (HL, B - 0-3 [номер окна])
0079+  6000             				; #04 - инит D с пагой из окна (HL, B - 0-3 [номер окна])
0080+  6000             				; #05 - выставление DMA_T (B - кол-во бёрстов)
0081+  6000             				; #06 - выставление DMA_N (B - размер бёрста)
0082+  6000             				;
0083+  6000             				; #FD - запуск без ожидания завершения (o:NZ - DMA занята)
0084+  6000             				; #FE - запуск с ожиданием завершения (o:NZ - DMA занята)
0085+  6000             				; #FF - ожидание готовности дма
0086+  6000             				;
0087+  6000             				; в функциях #00-#02 формат B/C следующий:
0088+  6000             				; 			 [7]:%1 - выбор страницы из блока выделенного плагину (0-5)
0089+  6000             				; 			     %0 - выбор страницы из видео буферов (0-31)
0090+  6000             				;			 [6-0]:номер страницы
0091+  6000             
0092+  6000             _TURBOPL	equ	#0e	; i:B - выбор Z80/AY
0093+  6000             				;   #00 - меняется частота Z80
0094+  6000             				; i:C - %00 - 3.5 MHz
0095+  6000             				;   %01 - 7 MHz
0096+  6000             				;   %10 - 14 MHz
0097+  6000             				;   %11 - 28 MHz (в данный момент 14MHz)
0098+  6000             				;   #01 - меняется частота AY
0099+  6000             				; i:C - %00 - 1.75 MHz
0100+  6000             				;   %01 - 1.7733 MHz
0101+  6000             				;   %10 - 3.5 MHz
0102+  6000             				;   %11 - 3.546 MHz
0103+  6000             
0104+  6000             _GEDPL		equ	#0f	; восстановление паллитры, всех оффсетов и txt режима
0105+  6000             				; ! обязательно вызывать при запуске плагина!
0106+  6000             				; (включает основной txt экран)
0107+  6000             				; i:none
0108+  6000             
0109+  6000             ; работа с файлами:
0110+  6000             ;---------------------------------------
0111+  6000             _LOAD512	equ	#30	; потоковая загрузка файла
0112+  6000             				; i:HL - Address
0113+  6000             				;   B - Blocks (512b)
0114+  6000             				; o:HL - New Value
0115+  6000             
0116+  6000             _SAVE512	equ	#31	; потоковая запись файла
0117+  6000             				; i:HL - Address
0118+  6000             				;   B - Blocks (512b)
0119+  6000             				; o:HL - New Value
0120+  6000             
0121+  6000             _GIPAGPL	equ	#32	; позиционировать на начало файла
0122+  6000             				; (сразу после запуска плагина — уже вызвана)
0123+  6000             
0124+  6000             _TENTRY		equ	#33	; получить ENTRY(32) из коммандера
0125+  6000             				; (структура как в каталоге FAT32)
0126+  6000             				; i:DE - Address
0127+  6000             				; o:DE(32) - ENTRY
0128+  6000             
0129+  6000             _CHTOSEP	equ	#34	; разложение цепочки активного файла в сектора
0130+  6000             				; i:DE - BUFFER (куда кидать номера секторов)
0131+  6000             				;   BC - BUFFER END (=BUFFER+BUFFERlenght)
0132+  6000             
0133+  6000             _TENTRYN	equ	#35	; reserved ???
0134+  6000             
0135+  6000             _TMRKDFL	equ	#36	; получить заголовок маркированного файла
0136+  6000             				; i:HL - File number (1-2047)
0137+  6000             				;   DE - Address (32byte buffer) [#8000-#BFFF!]
0138+  6000             				;   (if HL=0; o:BC - count of marked files)
0139+  6000             				; o:NZ - File not found or other error
0140+  6000             				;   Z - Buffer updated
0141+  6000             				;   >так же делается позиционированиена на начало этого файла!!!
0142+  6000             				;   >соотв. функции LOAD512/SAVE512 будут читать/писать этот файл от начала.
0143+  6000             
0144+  6000             _TMRKNXT	equ	#37	; reserved ???
0145+  6000             
0146+  6000             ;		equ	#38	; reserved ???
0147+  6000             
0148+  6000             _STREAM		equ	#39	; работа с потоками
0149+  6000             				; i:D - номер потока (0/1)
0150+  6000             				;   B - устройство: 0-SD(ZC)
0151+  6000             				;	1-Nemo IDE Master
0152+  6000             				;	2-Nemo IDE Slave
0153+  6000             				;   C - раздел (не учитывается)
0154+  6000             				;   BC=#FFFF: включает поток из D (не возвращает флагов)
0155+  6000             				;	      иначе создает/пересоздает поток.
0156+  6000             				; o:NZ - устройство или раздел не найдены
0157+  6000             				;   Z - можно начинать работать с потоком
0158+  6000             
0159+  6000             _MKFILE		equ	#3a	; создание файла в активном каталоге
0160+  6000             				; i:DE(12) - name(8)+ext(3)+flag(1)
0161+  6000             				;   HL(4) - File Size
0162+  6000             				; o:NZ - Operation failed
0163+  6000             				;   A - type of error (in next versions!)
0164+  6000             				;   Z - File created
0165+  6000             				;   ENTRY(32) [use TENTRY]
0166+  6000             
0167+  6000             _FENTRY		equ	#3b	; поиск файла/каталога в активной директории
0168+  6000             				; i:HL - flag(1),name(1-12),#00
0169+  6000             				; 		 flag:#00 - file
0170+  6000             				;		      #10 - dir
0171+  6000             				;		 name:"NAME.TXT","DIR"...
0172+  6000             				; o: Z - entry not found
0173+  6000             				;    NZ - CALL GFILE/GDIR for activating file/dir
0174+  6000             				;    [DE,HL] - file length
0175+  6000             
0176+  6000             _LOAD256	equ	#3c	; reserved ???
0177+  6000             _LOADNONE	equ	#3d	; reserved ???
0178+  6000             
0179+  6000             _GFILE		equ	#3e	; выставить указатель на начало найденного файла
0180+  6000             				; (вызывается после FENTRY!)
0181+  6000             
0182+  6000             _GDIR		equ	#3f	; сделать найденный каталог активным
0183+  6000             				; (вызывается после FENTRY!)
0184+  6000             
0185+  6000             ; работа с режимами графики
0186+  6000             ;---------------------------------------
0187+  6000             _MNGV_PL	equ	#40	; включение видео страницы
0188+  6000             				; i:A' - номер видео страницы
0189+  6000             				;   #00 - основной экран (тхт)
0190+  6000             				;   >паллитра выставляется автоматом
0191+  6000             				;   >как и все режимы и смещения
0192+  6000             				;   #01 - 1й видео буфер (16 страниц)
0193+  6000             				;   #02 - 2й видео буфер (16 страниц)
0194+  6000             
0195+  6000             _MNGCVPL	equ	#41	; включение страницы из видео буферов
0196+  6000             				; i:A' - номер страницы
0197+  6000             				;   #00-#0F - страницы из 1го видео буфера
0198+  6000             				;   #10-#1F - страницы из 2го видео буфера
0199+  6000             
0200+  6000             _GVmod		equ	#42	; включение видео режима (разрешение+тип)
0201+  6000             				; i:A' - видео режим
0202+  6000             				;   [7-6]: %00 - 256x192
0203+  6000             				;          %01 - 320x200
0204+  6000             				;          %10 - 320x240
0205+  6000             				;          %11 - 360x288
0206+  6000             				;   [5-2]: %0000
0207+  6000             				;   [1-0]: %00 - ZX
0208+  6000             				;          %01 - 16c
0209+  6000             				;          %10 - 256c
0210+  6000             				;          %11 - txt
0211+  6000             
0212+  6000             _GYoff		equ	#43	; выставление смещения экрана по Y
0213+  6000             				; i:HL - Y (0-511)
0214+  6000             
0215+  6000             _GXoff		equ	#44	; выставление смещения экрана по X
0216+  6000             				; i:HL - X (0-511)
0217+  6000             
0218+  6000             ; некоторые коды клавиатуры
0219+  6000             ;---------------------------------------
0220+  6000             _SPKE		equ	#10	; (SPACE)
0221+  6000             _UPPP		equ	#11	; (UP Arrow)
0222+  6000             _DWWW		equ	#12	; (Down Arrow)
0223+  6000             _LFFF		equ	#13	; (Left Arrow)
0224+  6000             _RGGG		equ	#14	; (Right Arrow)
0225+  6000             _TABK		equ	#15	; (Tab)
0226+  6000             _ENKE		equ	#16	; (Enter)
0227+  6000             _ESC		equ	#17	;
0228+  6000             _BSPC		equ	#18	; (Backspace)
0229+  6000             _PGU		equ	#19	; (pgUP)
0230+  6000             _PGD		equ	#1A	; (pgDN)
0231+  6000             _HOME		equ	#1B	;
0232+  6000             _END		equ	#1C	;
0233+  6000             _F1		equ	#1D	;
0234+  6000             _F2		equ	#1E	;
0235+  6000             _F3		equ	#1F	;
0236+  6000             _F4		equ	#20	;
0237+  6000             _F5		equ	#21	;
0238+  6000             _F6		equ	#22	;
0239+  6000             _F7		equ	#23	;
0240+  6000             _F8		equ	#24	;
0241+  6000             _F9		equ	#25	;
0242+  6000             _F10		equ	#26	;
0243+  6000             _ALT		equ	#27	;
0244+  6000             _SHIFT		equ	#28	;
0245+  6000             _CTRL		equ	#29	;
0246+  6000             _KBSCN		equ	#2A	; опрос клавиш
0247+  6000               				; i:A' - обработчик
0248+  6000             				;   #00 - учитывает SHIFT (TAI1/TAI2)
0249+  6000             				;   #01 - всегда выдает код из TAI1
0250+  6000             				; o: NZ: A - TAI1/TAI2 (see PS2P.ASM)
0251+  6000             				;     Z: A=#00 - unknown key
0252+  6000             				; 	 A=#FF - buffer end
0253+  6000             ;		equ	#2b
0254+  6000             _CAPS		equ	#2c	; (Caps Lock)
0255+  6000             _ANYK		equ	#2d	; any key
0256+  6000             _USPO		equ	#2e	; pause for keyboard ready (recomended for NUSP)
0257+  6000             _NUSP		equ	#2f	; waiting for any key
0258+  6000             
0063   6000             		include "tsConf.h.asm"
0001+  6000             ;---------------------------------------
0002+  6000             ; TS-Labs Configuration API Header
0003+  6000             ;---------------------------------------
0004+  6000             TSConfig	equ	#06af		; TSConfig*!- TS Engine Config
0005+  6000             
0006+  6000             Border		equ	#0faf		; Border
0007+  6000             
0008+  6000             FMAddr		equ	#15af		; FMaps Addr (?)
0009+  6000             
0010+  6000             TMPage		equ	#16af		; TMPage*!  - Tile Map Page
0011+  6000             T0GPage		equ	#17af		; T0GPage*! - Tile 0 Graphics Page
0012+  6000             T1GPage		equ	#18af		; T1GPage*! - Tile 1 Graphics Page
0013+  6000             SGPage		equ	#19af		; SGPage*!  - Sprite Graphics Page
0014+  6000             
0015+  6000             RAMPage0	equ	#10AF		; #0000-#3FFF
0016+  6000             RAMPage1	equ	#11AF		; #4000-#7FFF
0017+  6000             RAMPage2	equ	#12AF		; #8000-#BFFF 
0018+  6000             RAMPage3	equ	#13AF		; #С000-#FFFF
0019+  6000             
0064   6000             
0065   6000             		include "pluginHead.asm"
0001+  6000             ;---------------------------------------
0002+  6000             ; Wild Commander plugin header
0003+  6000             ;---------------------------------------
0004+  6000             		org	#6000
0005+  6000             startCode
0006+  6000             		; Заголовок (Описатель) плагина
0007+  6000 00          		ds	16					; +00 reserved
0008+  6010             		db	"WildCommanderMDL"			; +16 WildCommanderMDL
0008+  6010 57696C64436F6D6D616E6465724D444C
0009+  6020 02          		db	#02					; +32 Версия формата
0010+  6021 00          		db 	#00					; +33 reserved
0011+  6022 09          		db	#09					; +34 Количество страниц
0012+  6023 00          		db	#00					; +35 номер страницы, которая будет включаться в #8000!
0013+  6024             
0014+  6024             ;		dw	#00, #01				; +36 +0 - Номер страницы +1 - Размер блока (512b)
0015+  6024 00 1F       		db	#00, (pluginEnd - pluginStart) / 512 + 1
0016+  6026 00 00       		db	#00,#00
0017+  6028 00 00       		db	#00,#00
0018+  602A 00 00       		db	#00,#00
0019+  602C 00 00       		db	#00,#00
0020+  602E 00 00       		db	#00,#00
0021+  6030             
0022+  6030 00          		ds	16					; +48 - reserved
0023+  6040             
0024+  6040             								; +64 блок расширений:
0025+  6040 53 48 20    		db	"SH "					; "SH " - shell script
0026+  6043 20 20 20    		db	"   "					; "   " - CLi application
0027+  6046 00          		ds	30*3					;
0028+  60A0 00          		db	#00					; +160 #00
0029+  60A1             
0030+  60A1 FF FF 00 00 		dw	#ffff, #0000				; +161 максимальный размер файла (определяет, какие файлы не нужно передавать)
0031+  60A5             
0032+  60A5             								; +165 Имя плагина
0033+  60A5             		;    	 ********************************
0034+  60A5             		db	"Command Line Interface          "
0034+  60A5 436F6D6D616E64204C696E6520496E7465726661636520202020202020202020
0035+  60C5             
0036+  60C5 03          		db		#03				; +197 Тип условий при которых должен вызываться плагин:
0037+  60C6             								; 	   #00 - только по расширению
0038+  60C6             								; 	   #01 - сразу после загрузки плагина
0039+  60C6             								; 	   #02 - по таймеру скринсейвера
0040+  60C6             								; 	   #03 - из меню запуска
0041+  60C6 00          		db		#00				; +198 reserved
0042+  60C7             
0066   60C7             		include "cli.asm"
0001+  60C7             ;---------------------------------------
0002+  60C7             ; Main loop file
0003+  60C7             ;---------------------------------------
0004+  60C7             		org	#6200
0005+  6200             		DISP	#8000
0006+  8000             
0007+  8000             ; Начало основного кода плагина
0008+  8000             
0009+  8000             pluginStart	include "api.h.asm"
0001++ 8000             ;---------------------------------------
0002++ 8000             ; CLi (Command Line Interface) API Header
0003++ 8000             ;---------------------------------------
0004++ 8000             deviceSDZC	equ	#00			; SD-Card Z-Controller (SDZC)
0005++ 8000             deviceNemoM	equ	#01			; Nemo IDE Master
0006++ 8000             deviceNemoS	equ	#02			; Nemo IDE Slave
0007++ 8000             
0008++ 8000             flagFile	equ	#00			; flag:#00 - file
0009++ 8000             flagDir		equ	#10			;      #10 - dir
0010++ 8000             
0011++ 8000             resPal		equ	#01			; ресурс палитра
0012++ 8000             resSpr		equ	#02			; ресурс спрайты
0013++ 8000             ;---------------------------------------
0014++ 8000 C3 8F 81    shellStart	jp	_shellStart		; Начальна точка входа в CLi
0015++ 8003             						; i:A - тип вызова:
0016++ 8003             						;   #00 - вызов по расширению
0017++ 8003             						;   #03 - вызов из меню запуска плагинов
0018++ 8003             						;   любые другие значения - выход
0019++ 8003             						; o:A - статус:
0020++ 8003             						;   #00 - ошибок нет
0021++ 8003             						;   #01 - файл не опознан, пусть забирают вьюверы/другой плагин
0022++ 8003             
0023++ 8003 C3 1E 8A    openStream	jp	_openStream		; окрываем 0-й поток с устройством
0024++ 8006             						; i:B - устройство:
0025++ 8006             						;	deviceSDZC - SD-Card Z-Controller (SDZC)
0026++ 8006             						;	deviceNemoM - Nemo IDE Master
0027++ 8006             						;	deviceNemoS -Nemo IDE Slave
0028++ 8006             						;   C - раздел (не учитывается)
0029++ 8006             						;   BC=#FFFF: включает 0-й поток (не возвращает флагов)
0030++ 8006             						;	      иначе создает/пересоздает поток.
0031++ 8006             						; o:NZ - устройство или раздел не найдены
0032++ 8006             						;   Z - можно начинать работать с потоком
0033++ 8006             
0034++ 8006 C3 25 8A    pathToRoot	jp	_pathToRoot		; сброс Path текущего устройства (0-й поток) в root /
0035++ 8009             						; i: входящих параметров не требуется
0036++ 8009             						; o: на выходе так же нет флагов
0037++ 8009             
0038++ 8009 C3 2F 8A    checkKeyEnter	jp	_checkKeyEnter		; опрос статуса клавиши Enter
0039++ 800C             						; i: входящих параметров не требуется
0040++ 800C             						; o:NZ - клавиша нажата
0041++ 800C             						;   Z - ошибка или клавиша не была нажата
0042++ 800C             
0043++ 800C C3 34 8A    checkKeyDel	jp	_checkKeyDel		; опрос статуса клавиши Delete
0044++ 800F             						; i: входящих параметров не требуется
0045++ 800F             						; o:NZ - клавиша нажата
0046++ 800F             						;   Z - ошибка или клавиша не была нажата
0047++ 800F             
0048++ 800F C3 39 8A    checkKeyUp	jp	_checkKeyUp		; опрос статуса клавиши курсор вверх
0049++ 8012             						; i: входящих параметров не требуется
0050++ 8012             						; o:NZ - клавиша нажата
0051++ 8012             						;   Z - ошибка или клавиша не была нажата
0052++ 8012             
0053++ 8012 C3 3E 8A    checkKeyDown	jp	_checkKeyDown		; опрос статуса клавиши курсор вниз
0054++ 8015             						; i: входящих параметров не требуется
0055++ 8015             						; o:NZ - клавиша нажата
0056++ 8015             						;   Z - ошибка или клавиша не была нажата
0057++ 8015             
0058++ 8015 C3 43 8A    checkKeyLeft	jp	_checkKeyLeft		; опрос статуса клавиши курсор влево
0059++ 8018             						; i: входящих параметров не требуется
0060++ 8018             						; o:NZ - клавиша нажата
0061++ 8018             						;   Z - ошибка или клавиша не была нажата
0062++ 8018             
0063++ 8018 C3 48 8A    checkKeyRight	jp	_checkKeyRight		; опрос статуса клавиши курсор вправо
0064++ 801B             						; i: входящих параметров не требуется
0065++ 801B             						; o:NZ - клавиша нажата
0066++ 801B             						;   Z - ошибка или клавиша не была нажата
0067++ 801B             
0068++ 801B C3 4D 8A    checkKeyAlt	jp	_checkKeyAlt		; опрос статуса клавиши Alt
0069++ 801E             						; i: входящих параметров не требуется
0070++ 801E             						; o:NZ - клавиша нажата
0071++ 801E             						;   Z - ошибка или клавиша не была нажата
0072++ 801E             
0073++ 801E C3 52 8A    checkKeyEsc	jp	_checkKeyEsc		; опрос статуса клавиши Esc
0074++ 8021             						; i: входящих параметров не требуется
0075++ 8021             						; o:NZ - клавиша нажата
0076++ 8021             						;   Z - ошибка или клавиша не была нажата
0077++ 8021             
0078++ 8021 C3 57 8A    checkKeyF1	jp	_checkKeyF1		; опрос статуса клавиши F1
0079++ 8024             						; i: входящих параметров не требуется
0080++ 8024             						; o:NZ - клавиша нажата
0081++ 8024             						;   Z - ошибка или клавиша не была нажата
0082++ 8024             
0083++ 8024 C3 5C 8A    checkKeyF2	jp	_checkKeyF2		; опрос статуса клавиши F2
0084++ 8027             						; i: входящих параметров не требуется
0085++ 8027             						; o:NZ - клавиша нажата
0086++ 8027             						;   Z - ошибка или клавиша не была нажата
0087++ 8027             
0088++ 8027 C3 61 8A    waitKeyCalm	jp	_waitKeyCalm		; ожидание готовности клавиатуры
0089++ 802A             						; рекомендуется использовать перед вызовом «waitAnyKey»
0090++ 802A             						; i: входящих параметров не требуется
0091++ 802A             						; o: на выходе так же нет флагов
0092++ 802A             
0093++ 802A C3 66 8A    waitAnyKey	jp	_waitAnyKey		; ожидание нажатия любой клавиши (Any Key)
0094++ 802D             						; i: входящих параметров не требуется
0095++ 802D             						; o: на выходе так же нет флагов
0096++ 802D             
0097++ 802D C3 6E 8A    getKey		jp	_getKey			; опрос клавиатуры
0098++ 8030             						; i: входящих параметров не требуется
0099++ 8030             						; o: NZ: A - код нажатой клавиши (согласно таблицам TAI1/TAI2 WC)
0100++ 8030             						;     Z: A=#00 - неопознаная клавиша
0101++ 8030             						; 	 A=#FF - переполнение буфера клавиатуры
0102++ 8030             
0103++ 8030 C3 76 8A    getKeyWithShift jp	_getKeyWithShift	; опрос клавиатуры с учётом нажатия клавиши SHIFT
0104++ 8033             						; i: входящих параметров не требуется
0105++ 8033             						; o: NZ: A - код нажатой клавиши (согласно таблицам TAI1/TAI2 WC)
0106++ 8033             						;     Z: A=#00 - неопознаная клавиша
0107++ 8033             						;  	 A=#FF - переполнение буфера клавиатуры
0108++ 8033             
0109++ 8033 C3 7E 8A    setRamPage	jp	_setRamPage		; включение страницы на #C000 (из выделенного блока)
0110++ 8036             						; нумерация совпадает с использующейся в +36
0111++ 8036             						; i:A - номер страницы (от 0…)
0112++ 8036             						;   #FF - страница с фонтом (1го текстового экрана)
0113++ 8036             						;   #FE - первый текстовый экран (в нём панели)
0114++ 8036             
0115++ 8036 C3 84 8A    setVideoPage	jp	_setVideoPage		; включение видео-страницы на #C000
0116++ 8039             						; i:A - номер видео-страницы
0117++ 8039             						;   #00-#0F - страницы из 1го видео буфера
0118++ 8039             						;   #10-#1F - страницы из 2го видео буфера
0119++ 8039             
0120++ 8039 C3 8A 8A    setVideoBuffer	jp	_setVideoBuffer		; установка активного видео-буфера
0121++ 803C             						; i:A - номер видео-буфера
0122++ 803C             						;   #01 - 1й видео буфер (16 страниц)
0123++ 803C             						;   #02 - 2й видео буфер (16 страниц)
0124++ 803C             
0125++ 803C C3 90 8A    setVideoMode	jp	_setVideoMode		; включение видео режима (разрешение+тип)
0126++ 803F             						; i:A - видео режим, биты:
0127++ 803F             						;   [7-6]: %00 - 256x192
0128++ 803F             						;          %01 - 320x200
0129++ 803F             						;          %10 - 320x240
0130++ 803F             						;          %11 - 360x288
0131++ 803F             						;   [5-2]: %0000
0132++ 803F             						;   [1-0]: %00 - ZX
0133++ 803F             						;          %01 - 16c
0134++ 803F             						;          %10 - 256c
0135++ 803F             						;          %11 - txt
0136++ 803F             
0137++ 803F C3 96 8A    restoreWC	jp	_restoreWC		; Восстановление видеорежима для WC
0138++ 8042             
0139++ 8042 C3 9E 8A    searchEntry	jp	_searchEntry		; поиск файла/каталога в активной директории
0140++ 8045             						; i:HL - указатель на структуру: 1 байт - flag, 12 - байт имя, заканчивается #00
0141++ 8045             						;   flag: flagFile - файл
0142++ 8045             						;         flagDir - директория
0143++ 8045             						; o: Z - запись не найдена
0144++ 8045             						;    NZ - запись успешна найдена (для активации необходимо вызывать setFileBegin/setDirBegin)
0145++ 8045             						;    [DE,HL] - размер файла
0146++ 8045             
0147++ 8045 C3 A3 8A    setFileBegin	jp	_setFileBegin		; выставляет указатель на начало найденного файла
0148++ 8048             						; вызывается только после searchEntry
0149++ 8048             						; i: входящих параметров не требуется
0150++ 8048             						; o: на выходе так же нет флагов
0151++ 8048             
0152++ 8048 C3 A8 8A    setDirBegin	jp	_setDirBegin		; выставляет указатель на начало найденной директории
0153++ 804B             						; вызывается только после searchEntry
0154++ 804B             						; i: входящих параметров не требуется
0155++ 804B             						; o: на выходе так же нет флагов
0156++ 804B             
0157++ 804B C3 AD 8A    load512bytes	jp	_load512bytes		; потоковая загрузка файла
0158++ 804E             						; i:HL - адрес загрузки файла (каталога)
0159++ 804E             						;   B - количество блоков по 512 байт
0160++ 804E             						; o:HL - новый адрес (?)
0161++ 804E             
0162++ 804E C3 B2 8A    setPosBegin	jp	_setPosBegin		; позиционировать на начало файла
0163++ 8051             						; (сразу после запуска плагина — уже вызвана)
0164++ 8051             
0165++ 8051 C3 B7 8A    setHOffset	jp	_setHOffset		; выставление смещения экрана по горизонтали (X)
0166++ 8054             						; i:HL - значение в пикселях от 0 до 511
0167++ 8054             
0168++ 8054 C3 BC 8A    setVOffset	jp	_setVOffset		; выставление смещения экрана по вертикали (Y)
0169++ 8057             						; i:HL - значение в пикселях от 0 до 511
0170++ 8057             
0171++ 8057 C3 C1 8A    callDma		jp	_callDma		; работа с DMA
0172++ 805A             						; i: A - тип операции
0173++ 805A             						;    #00 - инициализация источника(S) и приёмника(D) (BHL - Source, CDE - Destination)
0174++ 805A             						;    #01 - инициализация источника(Source) (BHL)
0175++ 805A             						;    #02 - инициализация приёмника(Destination) (CDE)
0176++ 805A             						;    #03 - инициализация источника(Source) с пагой из окна (HL, B - 0-3 [номер окна])
0177++ 805A             						;    #04 - инициализация приёмника(Destination) с пагой из окна (HL, B - 0-3 [номер окна])
0178++ 805A             						;    #05 - выставление DMA_T (B - кол-во бёрстов)
0179++ 805A             						;    #06 - выставление DMA_N (B - размер бёрста)
0180++ 805A             						;
0181++ 805A             						;    #FD - запуск без ожидания завершения (o:NZ - DMA занята)
0182++ 805A             						;    #FE - запуск с ожиданием завершения (o:NZ - DMA занята)
0183++ 805A             						;    #FF - ожидание готовности DMA
0184++ 805A             						;
0185++ 805A             						; в функциях #00-#02 формат B/C следующий:
0186++ 805A             						;    [7]:%1 - выбор страницы из блока выделенного плагину (0-5)
0187++ 805A             						;        %0 - выбор страницы из видео буферов (0-31)
0188++ 805A             						;    [6-0]:номер страницы
0189++ 805A             
0190++ 805A C3 C7 8A    getFatEntry	jp	_getFatEntry		; получить ENTRY(32) из коммандера (структура как в каталоге FAT32)
0191++ 805D             						; i:DE - адрес загрузки
0192++ 805D             						; o:DE(32) - указатель на структуру:
0193++ 805D             						; +#00 (11) Name. Короткое имя файла (в рамках стандарта 8.3).
0194++ 805D             						;		  Если первый байт содержит #E5 или #05 - запись свободна (соответствующий файл был удалён)
0195++ 805D             						;		  Если первый байт содержит #00 - конец записей
0196++ 805D             						; +#0B (1)  Attr. Атрибуты файла. В байте атрибутов верхние два бита являются резервными и всегда должны быть обнулены
0197++ 805D             						;		  Остальные биты распределяются таким образом, что значение:
0198++ 805D             						;		  #01 - соответствует атрибуту «только для чтения»
0199++ 805D             						;		  #02 — «скрытый»
0200++ 805D             						;		  #04 — «системный»
0201++ 805D             						;		  #20 — «архивный»
0202++ 805D             						;		  #10 — директория
0203++ 805D             						;		  #08 — метка тома (VOLUME_ID)
0204++ 805D             						;		  #0F - LFN-запись (длинное имя другого файла, не вписывающегося в рамки 8.3)
0205++ 805D             						; +#0C (1)  NTRes. Используется в Windows NT (1 в 3м бите 3 - имя следует отображать в нижнем регистре; за расширение отвечает бит 4)
0206++ 805D             						; +#0D (1)  CrtTimeTenth. Счетчик десятков миллисекунд времени создания файла, допустимы значения 0-199
0207++ 805D             						;			  Поле часто неоправданно игнорируется
0208++ 805D             						; +#0E (2)  CrtTime. Время создания файла с точностью до 2 секунд:
0209++ 805D             						;		     биты 0-4 — счетчик секунд (по две), допустимы значения 0-29, то есть 0-58 секунд
0210++ 805D             						;		     биты 5-10 — минуты, допустимы значения 0-59
0211++ 805D             						;		     биты 11-15 — часы, допустимы значения 0-23
0212++ 805D             						; +#10 (2)  CrtDate. Дата создания файла:
0213++ 805D             						;		     биты 0-4 — день месяца, допускаются значения 1-31
0214++ 805D             						;		     биты 5-8 — месяц года, допускаются значения 1-12
0215++ 805D             						;		     биты 9-15 — год, считая от 1980 года («эпоха MS-DOS»)
0216++ 805D             						;				 возможны значения от 0 до 127 включительно, то есть 1980—2107 годы
0217++ 805D             						; +#12 (2)  LstAccDate. Дата последнего доступа к файлу (то есть последнего чтения или записи — в последнем
0218++ 805D             						;			случае приравнивается WrtDate). Аналогичное поле для времени не предусмотрено
0219++ 805D             						; +#14 (2)  FstClusHI. Номер первого кластера файла (старшее слово, на томе FAT12/FAT16 равен нулю)
0220++ 805D             						; +#16 (2)  WrtTime. Время последней записи (модификации) файла, например его создания
0221++ 805D             						; +#18 (2)  WrtDate. Дата последней записи (модификации) файла, в том числе создания
0222++ 805D             						; +#1A (2)  FstClusLO. Номер первого кластера файла (младшее слово)
0223++ 805D             						; +#1C (4)  FileSize. DWORD, содержащий значение размера файла в байтах. Фундаментальное ограничение FAT32 —
0224++ 805D             						;		      максимально допустимое значение размера файла составляет 0xFFFFFFFF (то есть 4 Гб минус 1 байт)
0225++ 805D             						;
0226++ 805D             						; Если это LFN-запись, то ENTRY(32) имеет другую структуру:
0227++ 805D             						; +#00 (1)  Ord. Cлужит для нумерации записей в наборе
0228++ 805D             						; +#01 (10) Name1. Cодержит первые пять символов части имени файла, которая отражена в данной LFN-записи
0229++ 805D             						; +#0B (1)  Attr. Атрибуты равены 0х0F (ATTR_LONG_NAME)
0230++ 805D             						; +#0C (1)  Type. Обнулен и дополнительно свидетельствует, что данная запись относится к файлу с длинным именем
0231++ 805D             						; +#0D (1)  Chksum. Cодержит контрольную сумму SFN псевдонима файла, соответствующего набору LFN-записей
0232++ 805D             						; +#0E (12) Name2. Cодержит шестой-одиннадцатый символы имени файла
0233++ 805D             						; +#1A (2)  FstClusLO. В контексте LFN-записи лишено смысла и обнуляется.
0234++ 805D             						; +#1C (4)  Name3. Содержит 12-й и 13-й символы имени файла.
0235++ 805D             
0236++ 805D C3 CC 8A    checkSync	jp	_checkSync		; Проверка необходимости обновления экрана
0237++ 8060             						; i: входящих параметров не требуется
0238++ 8060             						; o: NZ - новый инт был (необходимо обновить экран?)
0239++ 8060             						;    Z  - нового инта не было
0240++ 8060             
0241++ 8060 C3 DC 8A    printString	jp	_printString		; Печать строки в консоль (CLi)
0242++ 8063             						; i: HL - адрес строки, заканчивающейся #00
0243++ 8063             
0244++ 8063 C3 E0 8A    setScreen	jp	_setScreen		; Переключение межгу текстовым и графическим режимами
0245++ 8066             						; i: A - номер режима:
0246++ 8066             						;    #00 - текстовый
0247++ 8066             						;    #01 - графический
0248++ 8066             
0249++ 8066 C3 EB 8A    clearGfxScreen	jp	_clearGfxScreen		; Очистка графического экрана
0250++ 8069             
0251++ 8069 C3 24 8B    loadResource	jp	_loadResource		; Загрузка ресурсов из файла
0252++ 806C             						; i: HL - адрес загрузки
0253++ 806C             						;    A  - тип ресурса:
0254++ 806C             						;	  resPal - ресурс палитра
0255++ 806C             						; 	  resSpr - ресурс спрайты
0256++ 806C             
0257++ 806C C3 40 8B    printOkStatus	jp	_printOkStatus		; Печать [ ok ] если нет ошибки (a' = #00)
0258++ 806F             
0259++ 806F C3 25 8D    editInit	jp	_editInit		; Начальная инициализация строки ввода
0260++ 8072             
0261++ 8072 C3 8A 8F    printWW		jp	_printWW		; Обновление (?) строки ввода (Входящих/Исходящих параметров нет)
0262++ 8075             
0263++ 8075 C3 4A 8D    printInLine	jp	_printInLine		; Печать строки в строку ввода
0264++ 8078             						; i: HL - адрес строки, заканчивающейся #00 
0265++ 8078             
0266++ 8078 C3 4A 97    int2str		jp	_int2str		; Преобразование десятичного беззнакового числа Int16(16бит) в строку
0267++ 807B             						; i: HL - чисто
0268++ 807B             						;    DE - адресс строки куда сохранять (5 байт)
0269++ 807B             
0270++ 807B C3 5A 97    char2str	jp	_char2str		; Преобразование десятичного беззнакового числа Сhar(8bit) в строку
0271++ 807E             						; i: H=0, L - чисто
0272++ 807E             						;    DE - адресс строки куда сохранять (3 байта)
0273++ 807E             
0274++ 807E C3 62 97    fourbit2str	jp	_fourbit2str		; Преобразование десятичного беззнакового числа (4bit) в строку
0275++ 8081             						; i: H=0, L - чисто
0276++ 8081             						;    DE - адресс строки куда сохранять (2 байта)
0277++ 8081             
0278++ 8081 C3 F4 8A    chToHomePath	jp	_chToHomePath		; Установить «домашнюю» директорию как текущую (для загрузки ресурсов приложения)
0279++ 8084 C3 17 8B    chToCallPath	jp	_chToCallPath		; Восстановить директорию от куда была вызвана загрузка приложения
0280++ 8087             
0281++ 8087             ;---------------------------------------
0010+  8087 00          		ds	50*3,#00				; зарезервировано для будующего расширение
0011+  811D             		include "gli.h.asm"
0001++ 811D             ;---------------------------------------
0002++ 811D             ; GLi (Graphics Library interface) Header
0003++ 811D             ;---------------------------------------
0004++ 811D             ;loadResource	jp	_loadResource		; Загрузка ресурсов из файла
0005++ 811D             ;						; i: HL - адрес загрузки
0006++ 811D             
0007++ 811D C3 55 99    createSprite	jp	_createSprite		;
0008++ 8120 C3 70 99    updateSprite	jp	_updateSprite		;
0009++ 8123 C3 CF 99    showSprites	jp	_showSprites		;
0010++ 8126 C3 CB 99    hideSprites	jp	_hideSprites		;
0011++ 8129 C3 BF 99    enableSprites	jp	_enableSprites		;
0012++ 812C C3 C7 99    disableSprites	jp	_disableSprites		;
0013++ 812F C3 29 9A    setSpriteX	jp	_setSpriteX		;
0014++ 8132 C3 3B 9A    setSpriteY	jp	_setSpriteY		;
0015++ 8135             
0012+  8135 00          		ds	10*3,#00				; зарезервировано для будующего расширение
0013+  8153             		include "mouse.h.asm"
0001++ 8153             ;---------------------------------------
0002++ 8153             ; Kempstone Mouse driver Header
0003++ 8153             ;---------------------------------------
0004++ 8153 C3 84 98    mouseInit	jp	_mouseInit		; Инициализация драйвера мыши
0005++ 8156             						; i: hl - ширина, de - высота рабочей области
0006++ 8156             						;    256x192, 320x240, 360x288 итд 
0007++ 8156             
0008++ 8156 C3 8C 98    mouseUpdate	jp	_mouseUpdate		; Обновление данных из портов мыши (вызывается 1 раз за прервывание)
0009++ 8159             
0010++ 8159 C3 93 98    getMouseX	jp	_getMouseX		; Получить координаты X мыши
0011++ 815C             						; o: HL - координата X (16bit)
0012++ 815C             
0013++ 815C C3 97 98    getMouseY	jp	_getMouseY		; Получить координаты Y мыши
0014++ 815F             						; o: HL - координата Y (16bit)
0015++ 815F             
0016++ 815F C3 9B 98    getMouseDeltaX	jp	_getMouseDeltaX		; Получить дельту смещения мыши по оси X
0017++ 8162             						; o: HL - дельта X (16bit)
0018++ 8162             
0019++ 8162 C3 9F 98    getMouseDeltaY	jp	_getMouseDeltaY		; Получить дельту смещения мыши по оси Y
0020++ 8165             						; o: HL - дельта Y (16bit)
0021++ 8165             
0022++ 8165 C3 A3 98    getMouseRawX	jp	_getMouseRawX		; Получить RAW данные с порта X
0023++ 8168             						; o: H=0, L - RAW X (8bit)
0024++ 8168             
0025++ 8168 C3 A9 98    getMouseRawY	jp	_getMouseRawY		; Получить RAW данные с порта Y
0026++ 816B             						; o: H=0, L - RAW Y (8bit)
0027++ 816B             
0028++ 816B C3 B0 98    getMouseWheel	jp	_getMouseWheel		; Получить данные с порта колёсика
0029++ 816E             						; o: H=0, L - RAW Y (8bit) от 0 до 15
0030++ 816E             
0031++ 816E C3 B6 98    getMouseButtons	jp	_getMouseButtons	; Получить состояние кнопок мыши
0032++ 8171              						; o: A - биты состояния:
0033++ 8171              						;    bit0: левая кнопка (1=нажата)
0034++ 8171              						;    bit1: правая кнопка (1=нажата)
0035++ 8171              						;    bit2: средняя кнопка (1=нажата)
0036++ 8171              						;    bit3: зарезервировано
0037++ 8171             
0014+  8171 00          		ds	10*3,#00				; зарезервировано для будующего расширение
0015+  818F             
0016+  818F DD 22 BA BD _shellStart	ld	(storeIx),ix
0017+  8193 CD 21 83    		call	storeWcInt
0018+  8196 FE 00       		cp	#00					; вызов по расширению
0019+  8198 CA A3 81    		jp	z,callFromExt
0020+  819B             ;		cp	#01					; вызов при первом запуске
0021+  819B             ;		jp	z,callAtStart
0022+  819B FE 03       		cp	#03					; вызов из меню запуска плагинов
0023+  819D CA 53 82    		jp	z,callFromMenu
0024+  81A0 C3 FE 82    		jp	wrongExit
0025+  81A3             
0026+  81A3             ;---------------------------------------
0027+  81A3             ;callAtStart	ld	a,#04
0028+  81A3             ;		out	(254),a
0029+  81A3             ;		halt
0030+  81A3             ;		halt
0031+  81A3             ;		xor	a
0032+  81A3             ;		out	(254),a
0033+  81A3             ;		ret
0034+  81A3             ;---------------------------------------
0035+  81A3 22 9A 9F    callFromExt	ld	(fileLength),hl
0036+  81A6 ED 53 9C 9F 		ld	(fileLength+2),de
0037+  81AA             
0038+  81AA CD B7 81    		call	checkExtention
0039+  81AD CA AD 93    		jp	z,runSh
0040+  81B0 3D          		dec	a
0041+  81B1 CA 5A 94    		jp	z,runApp
0042+  81B4             ;		dec	a
0043+  81B4             ;		jp	z,mp3muz
0044+  81B4 C3 FE 82    		jp	wrongExit
0045+  81B7             
0046+  81B7             ;---------------------------------------
0047+  81B7 E5 D5       checkExtention	push	hl,de
0048+  81B9 11 93 BD    		ld	de,entry
0049+  81BC CD 5A 80    		call	getFatEntry
0050+  81BF             
0051+  81BF 21 9B BD    		ld	hl,entry+8
0052+  81C2 11 B3 BD    		ld	de,extSh
0053+  81C5 CD DF 81    		call	checkEStr
0054+  81C8 3E 00       		ld	a,0
0055+  81CA 28 0F       		jr	z,checkEExit
0056+  81CC             
0057+  81CC 21 9B BD    		ld	hl,entry+8
0058+  81CF 11 B6 BD    		ld	de,extSpace
0059+  81D2 CD DF 81    		call	checkEStr
0060+  81D5 3E 01       		ld	a,1
0061+  81D7 28 02       		jr	z,checkEExit
0062+  81D9             
0063+  81D9             		;ld	hl,entry+8
0064+  81D9             		;ld	de,mp3
0065+  81D9             		;call	checkEStr
0066+  81D9             		;d	a,2
0067+  81D9             		;jr	z,checkEExit
0068+  81D9             		
0069+  81D9 3E FF       		ld	a,#ff
0070+  81DB             
0071+  81DB D1 E1       checkEExit	pop 	de,hl
0072+  81DD B7          		or 	a
0073+  81DE C9          		ret
0074+  81DF             
0075+  81DF 1A          checkEStr	ld 	a,(de)
0076+  81E0 BE          		cp 	(hl)
0077+  81E1 C0          		ret 	nz
0078+  81E2 23          		inc 	hl
0079+  81E3 13          		inc 	de
0080+  81E4             		
0081+  81E4 1A          		ld	a,(de)
0082+  81E5 BE          		cp	(hl)
0083+  81E6 C0          		ret 	nz
0084+  81E7 23          		inc 	hl
0085+  81E8 13          		inc	de
0086+  81E9             
0087+  81E9 1A          		ld	a,(de)
0088+  81EA BE          		cp	(hl)
0089+  81EB C9                  	ret
0090+  81EC             
0091+  81EC             ;---------------------------------------
0092+  81EC             		; Устанавливаем CLI-палитру
0093+  81EC 21 C1 A0    cliInit		ld	hl,cliPal
0094+  81EF CD 5F 84    		call	initPal
0095+  81F2             
0096+  81F2             		; Сохраняем палитру для TXT режима
0097+  81F2 3E 03       		ld	a,palBank
0098+  81F4 CD 36 80    		call	setVideoPage
0099+  81F7 21 C1 A0    		ld	hl,cliPal
0100+  81FA 11 00 FC    		ld 	de,palAddr
0101+  81FD CD 73 84    		call	dupPal
0102+  8200             		; Сохраняем палитру для GFX режима
0103+  8200 3E 03       		ld	a,gPalBank
0104+  8202 CD 36 80    		call	setVideoPage
0105+  8205 21 C1 A0    		ld	hl,cliPal
0106+  8208 11 00 FE    		ld 	de,gPalAddr
0107+  820B CD 73 84    		call	dupPal
0108+  820E             
0109+  820E             		;ld	a,appBank
0110+  820E             		;call	setVideoPage
0111+  820E             
0112+  820E             		; Инициализируем строку ввода
0113+  820E CD 6F 80    		call	editInit
0114+  8211             
0115+  8211             		; Предварительно очищаем экран
0116+  8211 CD 11 84    		call	clearTxt
0117+  8214             
0118+  8214             		; Включаем текстовый режим и подготавливаем окружение
0119+  8214 CD B2 83    		call	txtModeInit
0120+  8217             
0121+  8217             		; Инициализируем переменные для печати в консоли
0122+  8217 CD 4A 8B    		call	printInit
0123+  821A C9          		ret
0124+  821B             
0125+  821B CD 30 82    cliInitDev	call	initPath
0126+  821E             
0127+  821E 06 00       		ld	b,deviceSDZC			; устройство SD-Card Z-Controller
0128+  8220 CD 03 80    		call	openStream
0129+  8223 C8          		ret	z				; если устройство найдено
0130+  8224             
0131+  8224 3E 3F       		ld	a,"?"
0132+  8226 32 A0 AC    		ld	(pathString),a
0133+  8229             
0134+  8229 21 51 9B    		ld	hl,wrongDevMsg			; иначе сообщить об ошибке
0135+  822C CD 8C 8B    		call	printStr
0136+  822F C9          		ret
0137+  8230             
0138+  8230 21 A0 AC    initPath	ld	hl,pathString
0139+  8233 11 A1 AC    		ld	de,pathString+1
0140+  8236 01 FB 03    		ld	bc,pathStrSize-1
0141+  8239 AF          		xor	a
0142+  823A 77          		ld	(hl),a
0143+  823B ED B0       		ldir
0144+  823D             			
0145+  823D 01 01 00    		ld	bc,#0001
0146+  8240 ED 43 9E AC 		ld	(pathStrPos),bc
0147+  8244 3E 2F       		ld	a,"/"
0148+  8246 32 A0 AC    		ld	(pathString),a
0149+  8249 3E 0D       		ld	a,#0d
0150+  824B 32 A1 AC    		ld	(pathString+1),a
0151+  824E AF          		xor	a
0152+  824F 32 59 91    		ld	(lsPathCount+1),a
0153+  8252 C9          		ret
0154+  8253             
0155+  8253             ;---------------------------------------
0156+  8253 CD 37 83    callFromMenu	call	setCLiInt
0157+  8256             
0158+  8256 CD EC 81    		call	cliInit
0159+  8259 CD 1B 82    		call	cliInitDev
0160+  825C             
0161+  825C CD F8 87    		call	storePath
0162+  825F             
0163+  825F 11 4D 9F    		ld	de,binPath
0164+  8262 CD 61 88    		call	checkSystemDirs
0165+  8265             
0166+  8265 11 52 9F    		ld	de,fontsPath
0167+  8268 CD 61 88    		call	checkSystemDirs
0168+  826B             
0169+  826B 11 59 9F    		ld	de,libsPath
0170+  826E CD 61 88    		call	checkSystemDirs
0171+  8271             
0172+  8271 11 5F 9F    		ld	de,localePath
0173+  8274 CD 61 88    		call	checkSystemDirs
0174+  8277             
0175+  8277 11 67 9F    		ld	de,systemPath
0176+  827A CD 61 88    		call	checkSystemDirs
0177+  827D             
0178+  827D CD 17 88    		call	restorePath
0179+  8280             
0180+  8280 CD 6B 88    		call	scopeBinary
0181+  8283             
0182+  8283 3E 00       cliStart	ld	a,#00				
0183+  8285 FE 00       		cp	#00
0184+  8287 20 11       		jr	nz,cliStart_0	
0185+  8289 21 5C 9A    		ld	hl,versionMsg			; cold start
0186+  828C CD 8C 8B    		call	printStr
0187+  828F 21 B2 9A    		ld	hl,typeHelpMsg
0188+  8292 CD 8C 8B    		call	printStr
0189+  8295 3E 01       		ld	a,#01
0190+  8297 32 84 82    		ld	(cliStart+1),a
0191+  829A             			
0192+  829A 21 ED 9A    cliStart_0	ld	hl,readyMsg			; warm start
0193+  829D CD 61 8D    		call	printEStr
0194+  82A0             
0195+  82A0 FB          		ei
0196+  82A1 76          mainLoop	halt					; Главный цикл (опрос клавиатуры)
0197+  82A2             
0198+  82A2 CD C1 8D    		call	showCursor
0199+  82A5             
0200+  82A5 21 00 BE    		ld 	hl,edit256
0201+  82A8 3E 01       		ld 	a,#01
0202+  82AA 01 00 00    		ld 	bc,#0000			; reserved
0203+  82AD CD 68 90    		call	BUF_UPD
0204+  82B0             
0205+  82B0 CD 72 80    		call	printWW				; печать
0206+  82B3 CD 09 80    		call	checkKeyEnter
0207+  82B6 C4 73 85    		call	nz,enterKey
0208+  82B9             
0209+  82B9 CD 0C 80    		call	checkKeyDel
0210+  82BC C4 1C 86    		call	nz,deleteKey
0211+  82BF             
0212+  82BF CD 1B 80    		call	checkKeyAlt
0213+  82C2 20 20       		jr	nz,scrollMode
0214+  82C4             
0215+  82C4 CD 0F 80    skipAltKey	call	checkKeyUp
0216+  82C7 C4 81 84    		call	nz,upKey
0217+  82CA             
0218+  82CA CD 12 80    		call	checkKeyDown
0219+  82CD C4 C3 84    		call	nz,downKey
0220+  82D0             
0221+  82D0 CD 15 80    		call	checkKeyLeft
0222+  82D3 C4 11 85    		call	nz,leftKey
0223+  82D6             
0224+  82D6 CD 18 80    		call	checkKeyRight
0225+  82D9 C4 3E 85    		call	nz,rightKey
0226+  82DC             
0227+  82DC CD 30 80    		call	getKeyWithShift
0228+  82DF C4 01 8E    		call	nz,printKey
0229+  82E2             
0230+  82E2 18 BD       		jr	mainLoop
0231+  82E4             
0232+  82E4 CD 0F 80    scrollMode	call	checkKeyUp
0233+  82E7 C4 F2 82    		call	nz,scrollUp
0234+  82EA             
0235+  82EA CD 12 80    		call	checkKeyDown
0236+  82ED C4 F8 82    		call	nz,scrollDown
0237+  82F0             
0238+  82F0 18 AF       		jr	mainLoop
0239+  82F2             
0240+  82F2 3E 01       scrollUp	ld	a,#01
0241+  82F4 CD C5 8E    		call	PR_POZ
0242+  82F7 C9          		ret
0243+  82F8             
0244+  82F8 3E 02       scrollDown	ld	a,#02
0245+  82FA CD C5 8E    		call	PR_POZ
0246+  82FD C9          		ret
0247+  82FE             
0248+  82FE             ;---------------------------------------
0249+  82FE CD 11 83    wrongExit	call	restoreExit
0250+  8301 DD 2A BA BD 		ld	ix,(storeIx)
0251+  8305 3E 01       		ld	a,1	 				; файл не опознан, пусть забирают вьюверы/другой плагин
0252+  8307 C9          		ret
0253+  8308             
0254+  8308 CD 11 83    pluginExit	call	restoreExit
0255+  830B DD 2A BA BD 		ld	ix,(storeIx)
0256+  830F AF          		xor	a	 				; просто выход
0257+  8310 C9          		ret
0258+  8311             
0259+  8311 CD B8 85    restoreExit	call	clearIBuffer
0260+  8314             
0261+  8314             		; Восстанавливаем ZX-палитру
0262+  8314 21 A1 A0    		ld	hl,zxPal
0263+  8317 CD 5F 84    		call	initPal
0264+  831A CD 2A 83    		call	restoreWCInt
0265+  831D CD 3F 80    		call	restoreWC
0266+  8320 C9          		ret
0267+  8321             ;---------------------------------------
0268+  8321 E5          storeWcInt	push	hl
0269+  8322 2A FF 5B    		ld	hl,(_WCINT)
0270+  8325 22 5F 83    		ld	(wcIntAddr+1),hl
0271+  8328 E1          		pop	hl
0272+  8329 C9          		ret
0273+  832A             
0274+  832A FB          restoreWCInt	ei
0275+  832B 76          		halt
0276+  832C F3          		di
0277+  832D E5          		push	hl
0278+  832E 2A 5F 83    		ld	hl,(wcIntAddr+1)
0279+  8331 22 FF 5B    		ld	(_WCINT),hl
0280+  8334 E1          		pop	hl
0281+  8335 FB          		ei
0282+  8336 C9          		ret
0283+  8337             
0284+  8337 FB          setCLiInt	ei
0285+  8338 76          		halt
0286+  8339 F3          		di
0287+  833A E5          		push	hl
0288+  833B 21 44 83    		ld	hl,cliInt
0289+  833E 22 FF 5B    		ld	(_WCINT),hl
0290+  8341 E1          		pop	hl
0291+  8342 FB          		ei
0292+  8343 C9          		ret
0293+  8344             ;---------------------------------------
0294+  8344 E5 D5 C5 F5 cliInt		push	hl,de,bc,af
0295+  8348 D9          		exx
0296+  8349 08          		ex	af,af'
0297+  834A E5 D5 C5 F5 		push	hl,de,bc,af
0298+  834E             
0299+  834E CD 1B 80    		call	checkKeyAlt
0300+  8351 C4 61 83    		call	nz,checkVideoKey
0301+  8354             		
0302+  8354 F1 C1 D1 E1 		pop	af,bc,de,hl		
0303+  8358 D9          		exx
0304+  8359 08          		ex	af,af'
0305+  835A F1 C1 D1 E1 		pop	af,bc,de,hl
0306+  835E C3 00 00    wcIntAddr	jp	#0000
0307+  8361             
0308+  8361 CD 21 80    checkVideoKey	call	checkKeyF1
0309+  8364 20 06       		jr	nz,setVideo0
0310+  8366 CD 24 80    		call	checkKeyF2
0311+  8369 20 22       		jr	nz,setVideo1
0312+  836B C9          		ret
0313+  836C             
0314+  836C CD 26 81    setVideo0	call	hideSprites
0315+  836F             		; Переключаем видео на наш текстовый режим
0316+  836F 3E 01       		ld	a,#01					; #01 - 1й видео буфер (16 страниц)
0317+  8371 CD 39 80    		call	setVideoBuffer
0318+  8374             
0319+  8374             		; На всякий случай переключаем разрешайку на 320x240 TXT
0320+  8374 3E 83       		ld	a,%10000011
0321+  8376 CD 3C 80    		call	setVideoMode
0322+  8379             
0323+  8379 CD 4D 84    		call	restBorder
0324+  837C             
0325+  837C 3E 03       		ld	a,palBank
0326+  837E CD 36 80    		call	setVideoPage
0327+  8381             
0328+  8381 21 00 FC    		ld	hl,palAddr
0329+  8384 CD 4B 95    		call	setFilePal
0330+  8387             
0331+  8387 3E 04       		ld	a,appBank
0332+  8389 CD 36 80    		call	setVideoPage
0333+  838C             
0334+  838C C9          		ret
0335+  838D             
0336+  838D CD 23 81    setVideo1	call	showSprites
0337+  8390             		; Переключаем видео на графический режим
0338+  8390 3E 02       		ld	a,#02					; #02 - 2й видео буфер (16 страниц)
0339+  8392 CD 39 80    		call	setVideoBuffer
0340+  8395             
0341+  8395             		; Переключаем графический режим (по умолчанию 320x240 256c)
0342+  8395 3A B9 BD    		ld	a,(currentVMode)
0343+  8398 CD 3C 80    		call	setVideoMode
0344+  839B             
0345+  839B 3A A0 A0    		ld	a,(curGfxBorder)
0346+  839E CD 59 84    		call	setBorder
0347+  83A1             
0348+  83A1 3E 03       		ld	a,gPalBank
0349+  83A3 CD 36 80    		call	setVideoPage
0350+  83A6             
0351+  83A6 21 00 FE    		ld	hl,gPalAddr
0352+  83A9 CD 4B 95    		call	setFilePal
0353+  83AC             
0354+  83AC 3E 04       		ld	a,appBank
0355+  83AE CD 36 80    		call	setVideoPage
0356+  83B1 C9          		ret
0357+  83B2             
0358+  83B2             ;---------------------------------------
0359+  83B2             txtModeInit	; Включаем страницу со страндартным фонтом WC
0360+  83B2 3E FF       		ld	a,#ff
0361+  83B4 CD 33 80    		call	setRamPage
0362+  83B7             
0363+  83B7             		; Сохраняем копию шрифта в #0000			
0364+  83B7 21 00 C0    		ld	hl,#c000
0365+  83BA 11 00 00    		ld	de,#0000
0366+  83BD 01 00 08    		ld	bc,2048
0367+  83C0 ED B0       		ldir
0368+  83C2             
0369+  83C2             		; Включаем страницу с нашим фонтом
0370+  83C2 3E 01       		ld	a,#01
0371+  83C4 CD 36 80    		call	setVideoPage
0372+  83C7             
0373+  83C7             		; Клонируем шрифт из #0000
0374+  83C7 21 00 00    		ld	hl,#0000
0375+  83CA 11 00 C0    		ld	de,#c000
0376+  83CD 01 00 08    		ld	bc,2048
0377+  83D0 ED B0       		ldir
0378+  83D2             		
0379+  83D2             		; Включаем страницу с нашим текстовым режимом
0380+  83D2 3E 00       		ld	a,#00
0381+  83D4 CD 36 80    		call	setVideoPage
0382+  83D7             
0383+  83D7 C3 6C 83    		jp	setVideo0
0384+  83DA             
0385+  83DA             ;---------------------------------------
0386+  83DA             ; Очистка графического экрана c помощью DMA
0387+  83DA             
0388+  83DA 3E 10       gfxCls		ld	a,#10					; Включаем страницу с нашим графическим режимом
0389+  83DC CD 36 80    		call	setVideoPage
0390+  83DF             
0391+  83DF 21 00 00    		ld	hl,#0000				; заливаем цветом первые 2 пикселя
0392+  83E2 22 00 C0    		ld	(#c000),hl
0393+  83E5             
0394+  83E5 3E FF       		ld	a,#ff
0395+  83E7 CD 57 80    		call	callDma					; ожидаем готовности DMA
0396+  83EA             
0397+  83EA 21 00 00    		ld	hl,0					; BHL - Source
0398+  83ED 11 02 00    		ld	de,2					; CDE - Destination
0399+  83F0 01 10 10    		ld	bc,#1010				;
0400+  83F3 3E 00       		ld	a,#00					; Инициализация источника(Source) и приёмника(Destination)
0401+  83F5 CD 57 80    		call	callDma
0402+  83F8             
0403+  83F8 3E 05       		ld	a,#05					; выставление DMA_T
0404+  83FA 06 FF       		ld	b,32*8-1				; B - кол-во бёрстов
0405+  83FC CD 57 80    		call	callDma
0406+  83FF                     	
0407+  83FF 3E 06               	ld	a,#06					; выставление DMA_N
0408+  8401 06 FF               	ld	b,255					; B - размер бёрста
0409+  8403 CD 57 80            	call	callDma
0410+  8406             
0411+  8406 3E FE       		ld	a,#fe					; запуск с ожиданием завершения (o:NZ - DMA занята)
0412+  8408 CD 57 80    		call	callDma
0413+  840B             
0414+  840B 3E 00       		ld	a,#00					; Восстанавливаем страницу с текстовым режимом
0415+  840D CD 36 80    		call	setVideoPage
0416+  8410             
0417+  8410 C9          		ret
0418+  8411             
0419+  8411             ;---------------------------------------
0420+  8411             ; Очистка текстового экрана
0421+  8411             		; Включаем страницу с нашим текстовым режимом
0422+  8411 3E 00       clearTxt	ld	a,#00
0423+  8413 CD 36 80    		call	setVideoPage
0424+  8416             
0425+  8416 06 05       		ld	b,cliTxtPages
0426+  8418             
0427+  8418 21 80 C0    		ld      hl,#c000+128				; блок атрибутов
0428+  841B 11 81 C0    	        ld      de,#c001+128
0429+  841E 3A 9F A0    	        ld	a,(curColor)
0430+  8421 06 40       	        ld      b,64
0431+  8423 C5 D5 E5    attrLoop    	push    bc,de,hl
0432+  8426 01 7F 00    	        ld      bc,127
0433+  8429 77          	        ld      (hl),a
0434+  842A ED B0       	        ldir
0435+  842C E1 D1 C1    	        pop     hl,de,bc
0436+  842F 24          	        inc     h
0437+  8430 14          	        inc     d
0438+  8431 10 F0       	        djnz    attrLoop
0439+  8433             
0440+  8433 3E 20       	        ld	a," "					; блок символов
0441+  8435 21 00 C0    	        ld      hl,#c000
0442+  8438 11 01 C0    	        ld      de,#c001
0443+  843B 06 40       	        ld      b,64
0444+  843D C5 D5 E5    scrLoop	   	push    bc,de,hl
0445+  8440 01 7F 00    	        ld      bc,127
0446+  8443 77          	        ld     (hl),a
0447+  8444 ED B0       	        ldir
0448+  8446 E1 D1 C1    	        pop     hl,de,bc
0449+  8449 24          	        inc     h
0450+  844A 14          	        inc     d
0451+  844B 10 F0       	        djnz    scrLoop
0452+  844D             
0453+  844D 3E 5F       restBorder  	ld	a,defaultCol				; восстановление бордера по умолчанию
0454+  844F E6 F0       	        and	%11110000
0455+  8451 CB 3F       	        srl	a
0456+  8453 CB 3F       	        srl	a
0457+  8455 CB 3F       	        srl	a
0458+  8457 CB 3F       	        srl	a
0459+  8459             
0460+  8459 01 AF 0F    setBorder   	ld	bc,Border
0461+  845C ED 79       	        out	(c),a
0462+  845E C9                  	ret
0463+  845F             
0464+  845F             ;---------------------------------------
0465+  845F             		;ld	hl,zxPal
0466+  845F 01 AF 15    initPal		ld	bc,FMAddr
0467+  8462 3E 10       		ld 	a,%00010000				; Разрешить приём данных для палитры (?) Bit 4 - FM_EN установлен
0468+  8464 ED 79       		out	(c),a
0469+  8466             
0470+  8466 11 00 00    		ld 	de,#0000				; Память с палитрой замапливается на адрес #0000
0471+  8469 CD 73 84    		call	dupPal
0472+  846C             
0473+  846C 01 AF 15    		ld 	bc,FMAddr			
0474+  846F AF          		xor	a					; Запретить, Bit 4 - FM_EN сброшен
0475+  8470 ED 79       		out	(c),a
0476+  8472 C9          		ret
0477+  8473             
0478+  8473 06 00       dupPal		ld	b,#00
0479+  8475 3E 10               	ld	a,16
0480+  8477 E5          palLoop		push	hl
0481+  8478 0E 20       		ld	c,32
0482+  847A ED B0       		ldir
0483+  847C 3D          		dec 	a
0484+  847D E1          		pop	hl
0485+  847E 20 F7       		jr 	nz,palLoop
0486+  8480 C9          		ret
0487+  8481             
0488+  8481             ;---------------------------------------
0489+  8481 3A A6 A2    upKey		ld	a,(hCount)
0490+  8484 FE 00       		cp	#00
0491+  8486 C8          		ret	z
0492+  8487 3A A7 A2    		ld	a,(historyPos)
0493+  848A FE 00       		cp	#00
0494+  848C 20 08       		jr	nz,upKey_00
0495+  848E 4F          		ld	c,a
0496+  848F 3A A6 A2    		ld	a,(hCount)
0497+  8492 3D          		dec	a
0498+  8493 81          		add	a,c
0499+  8494 18 01       		jr	upKey_00a
0500+  8496             
0501+  8496 3D          upKey_00	dec	a
0502+  8497             
0503+  8497 F5          upKey_00a	push	af
0504+  8498 21 FF 00    		ld	hl,iBufferSize				;hl * a
0505+  849B CD 1A 97    		call	mult16x8
0506+  849E E5          		push	hl
0507+  849F C1          		pop	bc
0508+  84A0 21 A8 A2    		ld	hl,cliHistory
0509+  84A3 09          		add	hl,bc
0510+  84A4             
0511+  84A4 F1          		pop	af
0512+  84A5 32 A7 A2    		ld	(historyPos),a
0513+  84A8             
0514+  84A8 11 A0 9F    upKey_01	ld	de,iBuffer
0515+  84AB 01 FF 00    		ld	bc,iBufferSize
0516+  84AE ED B0       		ldir
0517+  84B0             
0518+  84B0 CD 6F 80    		call	editInit
0519+  84B3             			
0520+  84B3 21 ED 9A    		ld	hl,readyMsg
0521+  84B6 CD 61 8D    		call	printEStr
0522+  84B9             
0523+  84B9 21 A0 9F    		ld	hl,iBuffer
0524+  84BC CD 61 8D    		call	printEStr
0525+  84BF             
0526+  84BF 32 9F 9F    		ld	(iBufferPos),a
0527+  84C2 C9          		ret
0528+  84C3             
0529+  84C3             ;---------------------------------------
0530+  84C3 3A A6 A2    downKey		ld	a,(hCount)
0531+  84C6 FE 00       		cp	#00
0532+  84C8 C8          		ret	z
0533+  84C9             
0534+  84C9 3A A7 A2    		ld	a,(historyPos)
0535+  84CC FE 0A       		cp	historySize
0536+  84CE 38 03       		jr	c,dnKey_00
0537+  84D0 AF          		xor	a
0538+  84D1 18 06       		jr	dnKey_00a
0539+  84D3             
0540+  84D3 3D          dnKey_00	dec	a
0541+  84D4 FE FF       		cp	#ff
0542+  84D6 20 01       		jr	nz,dnKey_00a
0543+  84D8             
0544+  84D8 AF          		xor	a
0545+  84D9             
0546+  84D9 21 FF 00    dnKey_00a	ld	hl,iBufferSize				;hl * a
0547+  84DC CD 1A 97    		call	mult16x8
0548+  84DF E5          		push	hl
0549+  84E0 C1          		pop	bc
0550+  84E1 21 A8 A2    		ld	hl,cliHistory
0551+  84E4 09          		add	hl,bc
0552+  84E5             
0553+  84E5 3A A6 A2    		ld	a,(hCount)
0554+  84E8 3C          		inc	a
0555+  84E9 4F          		ld	c,a
0556+  84EA 3A A7 A2    		ld	a,(historyPos)
0557+  84ED 3C          		inc	a
0558+  84EE B9          		cp	c
0559+  84EF 38 02       		jr	c,dnKey_00b
0560+  84F1 3E 01       		ld	a,1
0561+  84F3 32 A7 A2    dnKey_00b	ld	(historyPos),a
0562+  84F6             
0563+  84F6 11 A0 9F    		ld	de,iBuffer
0564+  84F9 01 FF 00    		ld	bc,iBufferSize
0565+  84FC ED B0       		ldir
0566+  84FE             
0567+  84FE CD 6F 80    		call	editInit
0568+  8501             
0569+  8501 21 ED 9A    		ld	hl,readyMsg
0570+  8504 CD 61 8D    		call	printEStr
0571+  8507             
0572+  8507 21 A0 9F    		ld	hl,iBuffer
0573+  850A CD 61 8D    		call	printEStr
0574+  850D 32 9F 9F    		ld	(iBufferPos),a
0575+  8510             
0576+  8510 C9          		ret
0577+  8511             
0578+  8511             ;---------------------------------------
0579+  8511 3A 9F 9F    leftKey		ld	a,(iBufferPos)
0580+  8514 FE 00       		cp	#00
0581+  8516 C8          		ret	z
0582+  8517 3D          		dec	a
0583+  8518 21 A0 9F    		ld	hl,iBuffer
0584+  851B 06 00       		ld	b,0
0585+  851D 4F          		ld	c,a
0586+  851E 09          		add	hl,bc
0587+  851F F5          		push	af
0588+  8520 3A 9E 9F    		ld	a,(storeKey)
0589+  8523 47          		ld	b,a
0590+  8524 7E          		ld	a,(hl)
0591+  8525 32 9E 9F    		ld	(storeKey),a
0592+  8528 78          		ld	a,b
0593+  8529 FE 00       		cp	#00
0594+  852B 20 02       		jr	nz,leftKey_00
0595+  852D 3E 20       		ld	a," "
0596+  852F CD AF 8D    leftKey_00	call	printEChar
0597+  8532 F1          		pop 	af
0598+  8533 32 9F 9F    		ld	(iBufferPos),a
0599+  8536 3A C2 8E    		ld	a,(printEX)
0600+  8539 3D          		dec	a
0601+  853A 32 C2 8E    		ld	(printEX),a
0602+  853D C9          		ret
0603+  853E             
0604+  853E             ;---------------------------------------
0605+  853E 3A 9F 9F    rightKey	ld	a,(iBufferPos)
0606+  8541 3C          		inc	a
0607+  8542 21 A0 9F    		ld	hl,iBuffer
0608+  8545 06 00       		ld	b,0
0609+  8547 4F          		ld	c,a
0610+  8548 09          		add	hl,bc
0611+  8549 F5          		push	af
0612+  854A E5          		push	hl
0613+  854B 2B          		dec	hl
0614+  854C 7E          		ld	a,(hl)
0615+  854D FE 00       		cp	#00
0616+  854F 28 1F       		jr	z,rightStop
0617+  8551 E1          		pop	hl
0618+  8552 3A 9E 9F    		ld	a,(storeKey)
0619+  8555 47          		ld	b,a
0620+  8556 7E          		ld	a,(hl)
0621+  8557 32 9E 9F    		ld	(storeKey),a
0622+  855A 78          		ld	a,b
0623+  855B FE 00       		cp	#00
0624+  855D 20 02       		jr	nz,rightKey_00
0625+  855F 3E 20       		ld	a," "
0626+  8561 CD AF 8D    rightKey_00	call	printEChar
0627+  8564 F1          		pop 	af
0628+  8565 32 9F 9F    		ld	(iBufferPos),a
0629+  8568 3A C2 8E    		ld	a,(printEX)
0630+  856B 3C          		inc	a
0631+  856C 32 C2 8E    		ld	(printEX),a
0632+  856F C9          		ret
0633+  8570 E1          rightStop	pop	hl
0634+  8571 F1          		pop	af
0635+  8572 C9          		ret
0636+  8573             
0637+  8573             ;---------------------------------------
0638+  8573 3E 5F       enterKey	ld	a,defaultCol
0639+  8575             		;ld	(curEColor),a
0640+  8575 32 9F A0    		ld	(curColor),a
0641+  8578 3A 9E 9F    		ld	a,(storeKey)
0642+  857B CD AF 8D    		call	printEChar
0643+  857E CD 9D 8D    		call	printEUp
0644+  8581             
0645+  8581 3A A0 9F    		ld	a,(iBuffer)
0646+  8584 FE 00       		cp	#00					; simple enter
0647+  8586 28 26       		jr	z,enterReady
0648+  8588             
0649+  8588 CD C9 85    		call	putHistory
0650+  858B             
0651+  858B 11 A0 9F    		ld	de,iBuffer
0652+  858E CD 03 86    		call	checkIsExec				; ./filename
0653+  8591             
0654+  8591 AF          		xor	a					; сброс флагов
0655+  8592 21 BD 9E    		ld	hl,cmdTable
0656+  8595 D5          		push	de
0657+  8596 CD 41 96    		call	parser
0658+  8599 D1          		pop	de
0659+  859A FE FF       		cp	#ff
0660+  859C 20 10       		jr	nz,enterReady
0661+  859E CD 34 89    		call	checkIsBin
0662+  85A1 FE FF       		cp	#ff
0663+  85A3 20 09       		jr	nz,enterReady
0664+  85A5 CD 4A 8B    		call	printInit
0665+  85A8 21 F0 9A    		ld	hl,errorMsg
0666+  85AB CD 8C 8B    		call	printStr
0667+  85AE             
0668+  85AE 21 ED 9A    enterReady	ld	hl,readyMsg
0669+  85B1 CD 61 8D    		call	printEStr
0670+  85B4 CD B8 85    		call	clearIBuffer
0671+  85B7 C9          		ret
0672+  85B8             
0673+  85B8 21 A0 9F    clearIBuffer	ld	hl,iBuffer
0674+  85BB 11 A1 9F    		ld	de,iBuffer+1
0675+  85BE 01 FE 00    		ld	bc,iBufferSize-1
0676+  85C1 AF          		xor	a
0677+  85C2 77          		ld	(hl),a
0678+  85C3 ED B0       		ldir
0679+  85C5 32 9F 9F    		ld	(iBufferPos),a
0680+  85C8 C9          		ret
0681+  85C9             
0682+  85C9 3A A6 A2    putHistory	ld	a,(hCount)
0683+  85CC FE 0A       		cp	historySize
0684+  85CE 38 0C       		jr	c,ph_00
0685+  85D0             
0686+  85D0 21 A7 A3    		ld	hl,cliHistory+iBufferSize
0687+  85D3 11 A8 A2    		ld	de,cliHistory
0688+  85D6 01 F7 08    		ld	bc,(historySize-1)*iBufferSize
0689+  85D9 ED B0       		ldir
0690+  85DB             
0691+  85DB 3D          		dec	a
0692+  85DC             
0693+  85DC 21 FF 00    ph_00		ld	hl,iBufferSize				;hl * a
0694+  85DF CD 1A 97    		call	mult16x8
0695+  85E2 E5          		push	hl
0696+  85E3 C1          		pop 	bc
0697+  85E4 21 A8 A2    		ld	hl,cliHistory
0698+  85E7 09          		add	hl,bc
0699+  85E8 EB          		ex	de,hl
0700+  85E9 21 A0 9F    		ld	hl,iBuffer
0701+  85EC 01 FF 00    		ld	bc,iBufferSize
0702+  85EF ED B0       		ldir
0703+  85F1             
0704+  85F1 3A A6 A2    		ld	a,(hCount)
0705+  85F4 3C          		inc	a
0706+  85F5 FE 0B       		cp	historySize+1
0707+  85F7 30 03       		jr	nc,ph_01
0708+  85F9 32 A6 A2    		ld	(hCount),a
0709+  85FC             
0710+  85FC 3A A6 A2    ph_01		ld	a,(hCount)
0711+  85FF 32 A7 A2    		ld	(historyPos),a
0712+  8602 C9          		ret
0713+  8603             ;---------------------------------------
0714+  8603 D5          checkIsExec	push	de
0715+  8604 CD 9F 96    		call	eat_space
0716+  8607 1A          		ld	a,(de)
0717+  8608 FE 2E       		cp	"."
0718+  860A 20 0E       		jr	nz,noExec
0719+  860C 13          		inc	de
0720+  860D 1A          		ld	a,(de)
0721+  860E FE 2F       		cp	"/"
0722+  8610 20 08       		jr	nz,noExec
0723+  8612 13          		inc	de					; file exec
0724+  8613 CD 24 94    		call	executeApp
0725+  8616 F1          		pop	af					; de
0726+  8617 F1          		pop	af					; ret	
0727+  8618 18 94       		jr	enterReady				; exit
0728+  861A             
0729+  861A D1          noExec		pop	de
0730+  861B C9          		ret
0731+  861C             
0732+  861C             ;---------------------------------------
0733+  861C 3A 9F 9F    deleteKey	ld	a,(iBufferPos)
0734+  861F FE 00       		cp	#00					; уже удалено до самого конца
0735+  8621 CA 38 8E    		jp	z,buffOverload+1
0736+  8624             
0737+  8624 21 9F 9F    		ld	hl,iBuffer-1
0738+  8627 06 00       		ld	b,#00
0739+  8629 4F          		ld	c,a
0740+  862A 09          		add	hl,bc
0741+  862B 70          		ld	(hl),b
0742+  862C             
0743+  862C 3D          		dec	a
0744+  862D 32 9F 9F    		ld	(iBufferPos),a
0745+  8630             
0746+  8630 3E 20       		ld	a," "
0747+  8632 CD AF 8D    		call	printEChar
0748+  8635             
0749+  8635 3A C2 8E    		ld	a,(printEX)
0750+  8638 3D          		dec	a
0751+  8639 FE FF       		cp	#ff					; Начало строки буфера edit256
0752+  863B 20 02       		jr	nz,putEX
0753+  863D             
0754+  863D             ;		ld	a,(iBufferPos)
0755+  863D             ;		cp	80-3					; 1>_ = 3 simbols
0756+  863D             ;		jr	c,delSkip
0757+  863D             ;		ld	a,79					; _ = 1 simbol
0758+  863D             ;delSkip	ld	b,#00
0759+  863D             ;		ld	c,a
0760+  863D             ;		ld	de,
0761+  863D             ;		ld	a,#01					; move up
0762+  863D             ;		call	PR_POZ
0763+  863D             
0764+  863D 3E 4F       		ld	a,79
0765+  863F 32 C2 8E    putEX		ld	(printEX),a
0766+  8642             		
0767+  8642 3A 9F 9F    		ld	a,(iBufferPos)
0768+  8645 FE 00       		cp	#00
0769+  8647 C0          		ret	nz
0770+  8648 3E 20       		ld	a," "
0771+  864A CD AF 8D    		call	printEChar
0772+  864D C9          		ret
0773+  864E             
0774+  864E             ;---------------------------------------
0775+  864E F1          closeCli	pop	af					; skip sp ret
0776+  864F F1          		pop	af
0777+  8650 F1          		pop	af
0778+  8651 C3 08 83    		jp	pluginExit
0779+  8654             
0780+  8654             ;---------------------------------------
0781+  8654 AF          clearScreen	xor	a
0782+  8655 CD C5 8E    		call	PR_POZ
0783+  8658 C9          		ret
0784+  8659             
0785+  8659             ;---------------------------------------
0786+  8659 EB          echoString	ex	de,hl
0787+  865A E5          		push	hl
0788+  865B CD 4A 8B    		call	printInit
0789+  865E             
0790+  865E 21 94 BC    		ld	hl,echoBuffer
0791+  8661 11 95 BC    		ld	de,echoBuffer+1
0792+  8664 01 FE 00    		ld	bc,eBufferSize-1
0793+  8667 AF          		xor	a
0794+  8668 77          		ld	(hl),a
0795+  8669 ED B0       		ldir
0796+  866B 32 8F 86    		ld	(quoteFlag+1),a
0797+  866E E1          		pop	hl
0798+  866F 11 94 BC    		ld	de,echoBuffer
0799+  8672             
0800+  8672 7E          echoStr_00	ld	a,(hl)
0801+  8673 FE 00       		cp	#00
0802+  8675 28 13       		jr	z,echoPrint
0803+  8677 FE 22       		cp	"\""
0804+  8679 20 0A       		jr	nz,echoStr_01
0805+  867B 3A 8F 86    		ld	a,(quoteFlag+1)
0806+  867E EE 01       		xor	#01
0807+  8680 32 8F 86    		ld	(quoteFlag+1),a
0808+  8683 18 02       		jr	echoStr_02
0809+  8685             
0810+  8685 12          echoStr_01	ld	(de),a
0811+  8686 13          		inc	de
0812+  8687 23          echoStr_02	inc	hl
0813+  8688 18 E8       		jr	echoStr_00
0814+  868A             
0815+  868A 12          echoPrint	ld	(de),a
0816+  868B             		
0817+  868B 21 94 BC    		ld	hl,echoBuffer
0818+  868E 3E 00       quoteFlag	ld	a,#00
0819+  8690 FE 01       		cp	#01
0820+  8692 20 03       		jr	nz,quoteOk
0821+  8694 21 30 9C    		ld	hl,wrongQuote
0822+  8697 CD 8C 8B    quoteOk		call	printStr
0823+  869A 21 4B 9B    		ld	hl,restoreMsg
0824+  869D CD 8C 8B    		call	printStr
0825+  86A0 CD B8 85    		call	clearIBuffer
0826+  86A3 C9          		ret
0827+  86A4             
0828+  86A4             ;---------------------------------------
0829+  86A4             checkCallKeys	
0830+  86A4 E5          		push	hl
0831+  86A5 EB          		ex	de,hl				; hl - адрес таблицы ключей
0832+  86A6             							; de - адрес строки с ключами
0833+  86A6 AF          		xor	a				; сброс флагов
0834+  86A7 1A          		ld	a,(de)
0835+  86A8 FE 2D       		cp	"-"
0836+  86AA 20 29       		jr	nz,exitNoKeys
0837+  86AC E5          checkCallLoop	push	hl
0838+  86AD CD 41 96    		call	parser
0839+  86B0 ED 5B AA 96 		ld	de,(storeAddr)
0840+  86B4 E1          		pop	hl
0841+  86B5 FE FF       		cp	#ff
0842+  86B7 28 08       		jr	z,errorCallExit
0843+  86B9 1A          		ld	a,(de)
0844+  86BA FE 2D       		cp	"-"
0845+  86BC 28 EE       		jr	z,checkCallLoop
0846+  86BE             
0847+  86BE F1          		pop	af
0848+  86BF EB          		ex	de,hl
0849+  86C0 C9          		ret
0850+  86C1             
0851+  86C1 EB          errorCallExit	ex	hl,de
0852+  86C2 E5          		push	hl
0853+  86C3 21 B8 9C    		ld	hl,unknownParamsMsg
0854+  86C6 CD 8C 8B    		call	printStr
0855+  86C9 E1          		pop	hl
0856+  86CA CD 7F 8B    		call	printSpaceStr
0857+  86CD 21 4B 9B    		ld	hl,restoreMsg
0858+  86D0 CD 8C 8B    		call	printStr
0859+  86D3 3E FF       		ld	a,#ff
0860+  86D5             
0861+  86D5 E1          exitNoKeys	pop	hl
0862+  86D6 C9          		ret
0863+  86D7             ;---------------------------------------
0864+  86D7 E5 F5       prepareEntry	push	hl,af
0865+  86D9 21 9A A1    		ld	hl,entrySearch
0866+  86DC 11 9B A1    		ld	de,entrySearch+1
0867+  86DF 01 0D 00    		ld	bc,13
0868+  86E2 AF          		xor	a
0869+  86E3 77          		ld	(hl),a
0870+  86E4 32 F7 86    		ld	(entryQuote+1),a
0871+  86E7 ED B0       		ldir
0872+  86E9 F1          		pop	af
0873+  86EA E1          		pop	hl
0874+  86EB 11 9A A1    		ld	de,entrySearch
0875+  86EE             
0876+  86EE 12          entryLoop	ld	(de),a
0877+  86EF 13          		inc	de
0878+  86F0 7E          		ld	a,(hl)
0879+  86F1 23          		inc	hl
0880+  86F2             
0881+  86F2 FE 22       		cp	"\""
0882+  86F4 20 0C       		jr	nz, entrySkip
0883+  86F6             
0884+  86F6 3E 00       entryQuote	ld	a,#00
0885+  86F8 FE 01       		cp	#01					; end quote
0886+  86FA C8          		ret	z
0887+  86FB EE 01       		xor	#01
0888+  86FD 32 F7 86    		ld	(entryQuote+1),a
0889+  8700 7E          		ld	a,(hl)
0890+  8701 23          		inc	hl
0891+  8702             
0892+  8702 FE 00       entrySkip	cp	#00
0893+  8704 C8          		ret	z
0894+  8705 FE 2F       		cp	"/"
0895+  8707 C8          		ret	z
0896+  8708 FE 61       		cp	97					; a
0897+  870A 38 E2       		jr	c,entryLoop
0898+  870C FE 7B       		cp	123					; }
0899+  870E 30 DE       		jr	nc,entryLoop
0900+  8710 D6 20       		sub	#20
0901+  8712 18 DA       		jr	entryLoop
0902+  8714             
0903+  8714             ;---------------------------------------
0904+  8714 21 CD 9B    showHelp	ld	hl,helpMsg
0905+  8717 CD 8C 8B    		call	printStr
0906+  871A             			
0907+  871A 21 BD 9E    		ld	hl,cmdTable
0908+  871D             
0909+  871D 11 4A A1    newLine		ld	de,helpOneLine
0910+  8720 0E 00       		ld	c,0
0911+  8722 06 0D       helpAgain	ld	b,13
0912+  8724 7E          helpLoop	ld	a,(hl)
0913+  8725 FE 00       		cp	#00
0914+  8727 28 39       		jr	z,helpLast
0915+  8729 FE 2A       		cp	"*"
0916+  872B 20 20       		jr	nz,helpSkip
0917+  872D 23          		inc	hl
0918+  872E 23          		inc	hl
0919+  872F 23          		inc	hl
0920+  8730             
0921+  8730 3E 20       helpSpace	ld	a," "
0922+  8732 12          		ld	(de),a
0923+  8733 13          		inc	de
0924+  8734 10 FA       		djnz	helpSpace
0925+  8736             
0926+  8736 0C          		inc	c
0927+  8737 79          		ld	a,c
0928+  8738 FE 06       		cp	6
0929+  873A 20 E6       		jr	nz,helpAgain
0930+  873C             
0931+  873C E5 D5 C5    		push	hl,de,bc
0932+  873F             		
0933+  873F 21 4A A1    		ld	hl,helpOneLine
0934+  8742 CD 8C 8B    		call	printStr
0935+  8745             
0936+  8745 CD 53 87    		call	clearOneLine
0937+  8748             
0938+  8748 C1 D1 E1    		pop	bc,de,hl
0939+  874B 18 D0       		jr	newLine
0940+  874D             
0941+  874D 12          helpSkip	ld	(de),a
0942+  874E 13          		inc	de
0943+  874F 23          		inc	hl
0944+  8750 05          		dec	b
0945+  8751 18 D1       		jr	helpLoop
0946+  8753             
0947+  8753 21 4A A1    clearOneLine	ld	hl,helpOneLine
0948+  8756 11 4B A1    		ld	de,helpOneLine+1
0949+  8759 3E 20       		ld	a," "
0950+  875B 77          		ld	(hl),a
0951+  875C 01 4D 00    		ld	bc,13*6-1
0952+  875F ED B0       		ldir
0953+  8761 C9          		ret
0954+  8762             
0955+  8762 21 4A A1    helpLast	ld	hl,helpOneLine
0956+  8765 CD 8C 8B    		call	printStr
0957+  8768             ;---------------
0958+  8768 21 F2 9B    		ld	hl,helpMsg2
0959+  876B CD 8C 8B    		call	printStr
0960+  876E             
0961+  876E 3E 03       		ld	a,scopeBinBank
0962+  8770 CD 36 80    		call	setVideoPage
0963+  8773             
0964+  8773 CD 53 87    		call	clearOneLine
0965+  8776             
0966+  8776 21 00 C0    		ld	hl,scopeBinAddr
0967+  8779 11 4A A1    		ld	de,helpOneLine
0968+  877C AF          		xor	a
0969+  877D 32 98 87    		ld	(helpCount+1),a
0970+  8780             
0971+  8780 7E          helpLoop2	ld	a,(hl)
0972+  8781 FE 00       		cp	#00
0973+  8783 28 36       		jr	z,helpExit
0974+  8785 06 08       		ld	b,8
0975+  8787 7E          helpCopy	ld	a,(hl)
0976+  8788 FE 41       		cp	"A"
0977+  878A 38 06       		jr	c,helpPaste
0978+  878C FE 5A       		cp	"Z"
0979+  878E 30 02       		jr	nc,helpPaste
0980+  8790 C6 20       		add	32
0981+  8792 12          helpPaste	ld	(de),a
0982+  8793 23          		inc	hl
0983+  8794 13          		inc	de
0984+  8795 10 F0       		djnz	helpCopy
0985+  8797             		
0986+  8797 3E 00       helpCount	ld	a,#00
0987+  8799 3C          		inc	a
0988+  879A 32 98 87    		ld	(helpCount+1),a
0989+  879D FE 08       		cp	8
0990+  879F 20 16       		jr	nz,helpSkip2
0991+  87A1 AF          		xor	a
0992+  87A2 32 98 87    		ld	(helpCount+1),a
0993+  87A5 E5 D5       		push	hl,de
0994+  87A7 21 4A A1    		ld	hl,helpOneLine
0995+  87AA CD 8C 8B    		call	printStr
0996+  87AD CD 53 87    		call	clearOneLine
0997+  87B0 D1 E1       		pop	de,hl
0998+  87B2 11 4A A1    		ld	de,helpOneLine
0999+  87B5 18 C9       		jr	helpLoop2
1000+  87B7             
1001+  87B7 13          helpSkip2	inc	de
1002+  87B8 13          		inc	de
1003+  87B9 18 C5       		jr	helpLoop2
1004+  87BB             
1005+  87BB             
1006+  87BB 21 4A A1    helpExit	ld	hl,helpOneLine
1007+  87BE CD 8C 8B    		call	printStr
1008+  87C1 C9          		ret
1009+  87C2             
1010+  87C2             ;---------------------------------------
1011+  87C2 E5 D5 C5    storeHomePath	push	hl,de,bc
1012+  87C5             
1013+  87C5 21 97 B8    		ld	hl,pathHomeString
1014+  87C8 11 98 B8    		ld	de,pathHomeString+1
1015+  87CB 01 FC 03    		ld	bc,pathStrSize
1016+  87CE AF          		xor	a
1017+  87CF 77          		ld	(hl),a
1018+  87D0 ED B0       		ldir
1019+  87D2             
1020+  87D2 21 A0 AC    		ld	hl,pathString			; store current path to home app path
1021+  87D5 11 97 B8    		ld	de,pathHomeString
1022+  87D8 CD 0B 88    		call	storeLoop
1023+  87DB C1 D1 E1    		pop	bc,de,hl
1024+  87DE C9          		ret
1025+  87DF             
1026+  87DF E5 D5 C5    restoreHomePath	push	hl,de,bc
1027+  87E2 21 97 B8    		ld	hl,pathHomeString		; restore current path from home app path
1028+  87E5 11 A0 AC    		ld	de,pathString
1029+  87E8 01 FC 03    		ld	bc,pathStrSize
1030+  87EB ED B0       		ldir
1031+  87ED C1 D1 E1    		pop	bc,de,hl
1032+  87F0 C9          		ret
1033+  87F1             ;---------------------------------------
1034+  87F1 21 A0 AC    pathWorkDir	ld	hl,pathString
1035+  87F4 CD 8C 8B    		call	printStr
1036+  87F7 C9          		ret
1037+  87F8             ;---------------------------------------
1038+  87F8 21 9D B0    storePath	ld	hl,pathBString
1039+  87FB 11 9E B0    		ld	de,pathBString+1
1040+  87FE 01 FC 03    		ld	bc,pathStrSize
1041+  8801 AF          		xor	a
1042+  8802 77          		ld	(hl),a
1043+  8803 ED B0       		ldir
1044+  8805             
1045+  8805 11 9D B0    		ld	de,pathBString
1046+  8808 21 A0 AC    storePathCall	ld	hl,pathString
1047+  880B 7E          storeLoop	ld	a,(hl)
1048+  880C FE 00       		cp	#00
1049+  880E C8          		ret	z
1050+  880F FE 0D       		cp	#0d
1051+  8811 C8          		ret	z
1052+  8812 12          		ld	(de),a
1053+  8813 23          		inc	hl
1054+  8814 13          		inc	de
1055+  8815 18 F4       		jr	storeLoop
1056+  8817             
1057+  8817 11 9D B0    restorePath	ld	de,pathBString
1058+  881A C3 85 92    		jp	changeDir
1059+  881D             
1060+  881D             ;---------------------------------------
1061+  881D E5          checkIsPath	push	hl
1062+  881E AF          		xor	a
1063+  881F 32 3A 88    		ld	(needCd+1),a
1064+  8822 22 40 88    		ld	(pathCd+1),hl
1065+  8825             
1066+  8825 7E          cipLoop		ld	a,(hl)
1067+  8826 FE 00       		cp	#00
1068+  8828 28 0F       		jr	z,needCd
1069+  882A FE 2F       		cp	"/"
1070+  882C 20 08       		jr	nz,cipNext
1071+  882E 3E 01       		ld	a,#01
1072+  8830 32 3A 88    		ld	(needCd+1),a
1073+  8833 22 40 88    		ld	(pathCd+1),hl
1074+  8836 23          cipNext		inc	hl
1075+  8837 18 EC       		jr	cipLoop
1076+  8839             
1077+  8839 3E 00       needCd		ld	a,#00				; need cd?
1078+  883B FE 00       		cp	#00
1079+  883D 28 1A       		jr	z,cipExit
1080+  883F             
1081+  883F 21 00 00    pathCd		ld	hl,#0000
1082+  8842 AF          		xor	a
1083+  8843 77          		ld	(hl),a
1084+  8844 E5          		push	hl
1085+  8845             
1086+  8845 CD F8 87    		call	storePath
1087+  8848 E1          		pop	hl
1088+  8849 D1          		pop	de
1089+  884A 1A          		ld	a,(de)
1090+  884B FE 00       		cp	#00				; root ?
1091+  884D 20 03       		jr	nz,pathCd_00
1092+  884F 11 4B 9F    		ld	de,rootPath
1093+  8852             		
1094+  8852 23          pathCd_00	inc	hl
1095+  8853 E5          		push	hl
1096+  8854 CD 85 92    		call	changeDir
1097+  8857             
1098+  8857 E1          pathCd_01	pop	hl
1099+  8858 C9          		ret
1100+  8859             
1101+  8859 CD F8 87    cipExit		call	storePath
1102+  885C E1          		pop	hl
1103+  885D AF          		xor	a
1104+  885E 08          		ex	af,af'
1105+  885F AF          		xor	a
1106+  8860 C9          		ret
1107+  8861             
1108+  8861             ;---------------------------------------
1109+  8861 CD 7E 92    checkSystemDirs	call	changeDirSilent
1110+  8864 08          		ex	af,af'
1111+  8865 FE 00       		cp	#00
1112+  8867 C8          		ret	z
1113+  8868 C3 13 89    		jp	systemBroken
1114+  886B             
1115+  886B             ;---------------------------------------
1116+  886B 3E 03       scopeBinary	ld	a,scopeBinBank
1117+  886D CD 36 80    		call	setVideoPage
1118+  8870             
1119+  8870 CD 05 89    		call	clearScopeBin
1120+  8873 CD F8 87    		call	storePath
1121+  8876             		
1122+  8876 11 00 C0    		ld	de,scopeBinAddr
1123+  8879 ED 53 D0 88 		ld	(sbCopyName+1),de
1124+  887D             
1125+  887D 11 4D 9F    		ld	de,binPath
1126+  8880 CD 85 92    		call	changeDir
1127+  8883             
1128+  8883 CD 45 80    		call	setFileBegin
1129+  8886             
1130+  8886 CD 23 92    sbReadAgain	call	clearBuffer
1131+  8889             
1132+  8889 21 00 00    		ld	hl,bufferAddr
1133+  888C 06 01       		ld	b,#01				; 1 block 512b
1134+  888E CD 4B 80    		call	load512bytes
1135+  8891             
1136+  8891 21 00 00    		ld	hl,bufferAddr
1137+  8894             
1138+  8894 7E          sbLoop		ld	a,(hl)
1139+  8895 FE 00       		cp	#00
1140+  8897 CA CB 88    		jp	z,sbEnd
1141+  889A             
1142+  889A E5          		push	hl
1143+  889B DD E1       		pop	ix
1144+  889D DD CB 0B 5E 		bit	3,(ix+11)
1145+  88A1 20 10       		jr	nz,sbSkip			; если 1, то запись это ID тома
1146+  88A3             		
1147+  88A3 DD CB 0B 66 		bit	4,(ix+11)
1148+  88A7 20 0A       		jr	nz,sbSkip			; если 1, то каталог
1149+  88A9             		
1150+  88A9 7E          		ld	a,(hl)
1151+  88AA FE E5       		cp	#e5
1152+  88AC 28 05       		jr	z,sbSkip
1153+  88AE             
1154+  88AE E5          		push	hl
1155+  88AF CD CF 88    		call	sbCopyName
1156+  88B2 E1          		pop	hl
1157+  88B3             
1158+  88B3             sbSkip		
1159+  88B3 3E 00       sbCount		ld	a,#00
1160+  88B5 3C          		inc	a
1161+  88B6 32 B4 88    		ld	(sbCount+1),a
1162+  88B9 FE 10       		cp	16					; 16 записей на сектор
1163+  88BB 28 07       		jr	z,sbLoadNext
1164+  88BD             
1165+  88BD 01 20 00    		ld	bc,32					; 32 byte = 1 item
1166+  88C0 09          		add	hl,bc
1167+  88C1 C3 94 88    		jp	sbLoop
1168+  88C4             
1169+  88C4 AF          sbLoadNext	xor	a
1170+  88C5 32 B4 88    		ld	(sbCount+1),a
1171+  88C8 C3 86 88    		jp 	sbReadAgain
1172+  88CB             
1173+  88CB CD 17 88    sbEnd		call	restorePath
1174+  88CE C9          		ret
1175+  88CF             
1176+  88CF 11 00 C0    sbCopyName	ld	de,scopeBinAddr
1177+  88D2             
1178+  88D2 E5          		push	hl
1179+  88D3 D5          		push	de
1180+  88D4 11 08 00    		ld 	de,#08
1181+  88D7 19          		add	hl,de
1182+  88D8 7E          		ld	a,(hl)
1183+  88D9 FE 20       		cp	" "
1184+  88DB 20 25       		jr	nz,sbSkipFile
1185+  88DD 23          		inc	hl
1186+  88DE 7E          		ld	a,(hl)
1187+  88DF FE 20       		cp	" "
1188+  88E1 20 1F       		jr	nz,sbSkipFile
1189+  88E3 23          		inc	hl
1190+  88E4 7E          		ld	a,(hl)
1191+  88E5 FE 20       		cp	" "
1192+  88E7 20 19       		jr	nz,sbSkipFile
1193+  88E9 D1          		pop	de
1194+  88EA E1          		pop	hl
1195+  88EB             
1196+  88EB 06 08       		ld	b,8					; 16384 / 8 = 2048 bin files		
1197+  88ED 7E          sbCopy		ld	a,(hl)
1198+  88EE FE 41       		cp	"A"
1199+  88F0 38 06       		jr	c,sbPaste
1200+  88F2 FE 5A       		cp	"Z"
1201+  88F4 30 02       		jr	nc,sbPaste
1202+  88F6 C6 20       		add	32
1203+  88F8 12          sbPaste		ld	(de),a
1204+  88F9 23          		inc	hl
1205+  88FA 13          		inc	de
1206+  88FB 10 F0       		djnz	sbCopy
1207+  88FD             
1208+  88FD ED 53 D0 88 		ld	(sbCopyName+1),de
1209+  8901 C9          		ret
1210+  8902             
1211+  8902 D1          sbSkipFile	pop	de
1212+  8903 E1          		pop	hl
1213+  8904 C9          		ret
1214+  8905             
1215+  8905             
1216+  8905 21 00 C0    clearScopeBin	ld	hl,scopeBinAddr
1217+  8908 11 01 C0    		ld	de,scopeBinAddr+1
1218+  890B 01 FF 3B    		ld	bc,palAddr-scopeBinAddr-1
1219+  890E AF          		xor	a
1220+  890F 77          		ld	(hl),a
1221+  8910 ED B0       		ldir
1222+  8912 C9          		ret
1223+  8913             
1224+  8913             ;---------------------------------------
1225+  8913 3E BF       systemBroken	ld	a,%10111111
1226+  8915 32 9F A0    		ld	(curColor),a
1227+  8918             		;ld	(curEColor),a
1228+  8918 CD 56 8B    		call	printClear
1229+  891B CD 11 84    		call	clearTxt
1230+  891E             
1231+  891E 3E 0B       		ld	a,%00001011
1232+  8920 CD 59 84    		call	setBorder
1233+  8923             
1234+  8923 CD 54 86    		call	clearScreen
1235+  8926             
1236+  8926 21 18 9D    		ld	hl,brokenMsg
1237+  8929 CD 8C 8B    		call	printStr
1238+  892C             		
1239+  892C 76          		halt
1240+  892D CD 2A 80    		call	waitAnyKey
1241+  8930             
1242+  8930 F1          		pop	af
1243+  8931 C3 08 83    		jp	pluginExit
1244+  8934             
1245+  8934             ;---------------------------------------
1246+  8934 D5          checkIsBin	push	de
1247+  8935 3E 03       		ld	a,scopeBinBank
1248+  8937 CD 36 80    		call	setVideoPage
1249+  893A             
1250+  893A 21 79 9F    		ld	hl,cibFile
1251+  893D 11 7A 9F    		ld	de,cibFile+1
1252+  8940 01 07 00    		ld	bc,7
1253+  8943 AF          		xor	a
1254+  8944 77          		ld	(hl),a
1255+  8945 ED B0       		ldir
1256+  8947             
1257+  8947 D1          		pop	de
1258+  8948 CD 9F 96    		call	eat_space
1259+  894B EB          		ex	de,hl
1260+  894C             
1261+  894C 11 00 C0    		ld	de,scopeBinAddr
1262+  894F 06 08       cibLoop		ld	b,8
1263+  8951 D5          		push	de
1264+  8952 E5          		push	hl
1265+  8953 1A          cibLoop_00	ld	a,(de)
1266+  8954 FE 00       		cp	#00
1267+  8956 28 72       		jr	z,cibError
1268+  8958 4F          		ld	c,a
1269+  8959 7E          		ld	a,(hl)
1270+  895A B9          		cp	c
1271+  895B 20 2A       		jr	nz,cibNext
1272+  895D 23          		inc	hl
1273+  895E 13          		inc	de
1274+  895F             		
1275+  895F 7E          ttt		ld	a,(hl)
1276+  8960             
1277+  8960 FE 20       		cp	" "				; end entered name?
1278+  8962 28 19       		jr	z,cibLoop_01a
1279+  8964             							
1280+  8964 FE 00       		cp	#00				; end entered name?
1281+  8966 20 1B       		jr	nz,cibLoop_02
1282+  8968             		
1283+  8968 1A          cibLoop_01	ld	a,(de)
1284+  8969 FE 20       		cp	" "				; end name in embedded table?
1285+  896B 28 24       		jr	z,cibOk
1286+  896D             		
1287+  896D FE 00       		cp	#00				; end name in external table?
1288+  896F 20 16       		jr	nz,cibNext
1289+  8971             
1290+  8971 23          		inc	hl
1291+  8972 7E          		ld	a,(hl)
1292+  8973 FE 20       		cp	" "
1293+  8975 28 1A       		jr	z,cibOk
1294+  8977             		
1295+  8977 FE 00       		cp	#00
1296+  8979 28 16       		jr	z,cibOk
1297+  897B             
1298+  897B 18 0A       		jr	cibNext
1299+  897D             
1300+  897D 23          cibLoop_01a	inc	hl
1301+  897E 22 C1 89    		ld	(cibParams+1),hl
1302+  8981 18 E5       		jr	cibLoop_01
1303+  8983             
1304+  8983 10 CE       cibLoop_02	djnz	cibLoop_00			; file found
1305+  8985 18 0A       		jr	cibOk
1306+  8987             
1307+  8987 E1          cibNext		pop	hl
1308+  8988 D1          		pop	de
1309+  8989 EB          		ex	de,hl
1310+  898A 01 08 00    		ld	bc,8
1311+  898D 09          		add	hl,bc
1312+  898E EB          		ex	de,hl	
1313+  898F 18 BE       		jr	cibLoop
1314+  8991             
1315+  8991 E1          cibOk		pop	hl
1316+  8992 D1          		pop	de
1317+  8993 11 79 9F    		ld	de,cibFile
1318+  8996 06 08       		ld	b,8
1319+  8998             
1320+  8998 AF          		xor	a
1321+  8999 32 9D 89    		ld	(cibOk_00+1),a
1322+  899C             
1323+  899C 3E 00       cibOk_00	ld	a,#00
1324+  899E FE 00       		cp	#00
1325+  89A0 20 0A       		jr	nz,cibOk_EndName
1326+  89A2 7E          		ld	a,(hl)
1327+  89A3 FE 20       		cp	" "
1328+  89A5 20 06       		jr	nz,cibOk_01
1329+  89A7 3E 01       		ld	a,#01
1330+  89A9 32 9D 89    		ld	(cibOk_00+1),a
1331+  89AC             
1332+  89AC AF          cibOk_EndName	xor	a
1333+  89AD 12          cibOk_01	ld	(de),a
1334+  89AE 23          		inc	hl
1335+  89AF 13          		inc	de
1336+  89B0 10 EA       		djnz	cibOk_00
1337+  89B2             
1338+  89B2             		;ld	bc,8
1339+  89B2             		;ldir
1340+  89B2             
1341+  89B2 21 6F 9F    		ld	hl,cdBinPath
1342+  89B5 11 74 9F    		ld	de,cibPath
1343+  89B8 01 05 00    		ld	bc,cibPath-cdBinPath
1344+  89BB ED B0       		ldir
1345+  89BD             
1346+  89BD 11 74 9F    		ld	de,cibPath
1347+  89C0 21 00 00    cibParams	ld	hl,#0000
1348+  89C3 CD 24 94    		call	executeApp
1349+  89C7 AF EE 00    		xor	a,#00				; no err
1350+  89C9 C9          		ret
1351+  89CA             
1352+  89CA E1          cibError	pop	hl
1353+  89CB D1          		pop	de
1354+  89CC 3E FF       		ld	a,#ff				; err
1355+  89CE C9          		ret
1356+  89CF             
1357+  89CF             ;---------------------------------------
1358+  89CF EB          switchScreen	ex	de,hl
1359+  89D0 CD AC 96    		call	str2int
1360+  89D3 7C          		ld	a,h
1361+  89D4 FE 00       		cp	#00
1362+  89D6 C2 13 91    		jp	nz,errorPar
1363+  89D9 7D          		ld	a,l
1364+  89DA FE 00       		cp	#00
1365+  89DC CA 6C 83    		jp	z,setVideo0
1366+  89DF FE 01       		cp	#01
1367+  89E1 CA 8D 83    		jp	z,setVideo1
1368+  89E4 C3 13 91    		jp	errorPar
1369+  89E7             
1370+  89E7             ;---------------------------------------
1371+  89E7 EB          gfxBorder	ex	de,hl
1372+  89E8 CD AC 96    		call	str2int
1373+  89EB 7C          		ld	a,h
1374+  89EC FE 00       		cp	#00
1375+  89EE C2 13 91    		jp	nz,errorPar
1376+  89F1 7D          		ld	a,l
1377+  89F2 32 A0 A0    		ld	(curGfxBorder),a
1378+  89F5 C9          		ret
1379+  89F6             
1380+  89F6             ;---------------------------------------
1381+  89F6 21 9B 9C    wrongFileSize	ld	hl,wrongFileSizeMsg
1382+  89F9 CD 8C 8B    		call	printStr
1383+  89FC 3E FF       		ld	a,#ff				; error
1384+  89FE C9          		ret
1385+  89FF             
1386+  89FF             ;---------------------------------------
1387+  89FF 3A 82 9F    progressWait	ld	a,(progressWPos)
1388+  8A02 06 00       		ld	b,#00
1389+  8A04 4F          		ld	c,a
1390+  8A05 21 83 9F    		ld	hl,progressWData
1391+  8A08 09          		add	hl,bc
1392+  8A09 7E          		ld	a,(hl)
1393+  8A0A 23          		inc	hl
1394+  8A0B 66          		ld	h,(hl)
1395+  8A0C 6F          		ld	l,a
1396+  8A0D CD 8C 8B    		call	printStr
1397+  8A10 3A 82 9F    		ld	a,(progressWPos)
1398+  8A13 3C          		inc	a
1399+  8A14 3C          		inc	a
1400+  8A15 FE 08       		cp	#08
1401+  8A17 38 01       		jr	c,progressWSkip
1402+  8A19 AF          		xor	a
1403+  8A1A 32 82 9F    progressWSkip	ld	(progressWPos),a
1404+  8A1D C9          		ret
1405+  8A1E             
1406+  8A1E             ;---------------------------------------
1407+  8A1E             ;testCmd		; Включаем страницу для приложений
1408+  8A1E             ;		ld	a,#02
1409+  8A1E             ;		call	setVideoPage
1410+  8A1E             ;		ld	hl,exampleStart
1411+  8A1E             ;		ld	de,#c000
1412+  8A1E             ;		ld	bc,exampleEnd-exampleStart
1413+  8A1E             ;		ldir
1414+  8A1E             ;		call	#c000
1415+  8A1E             ;		ret
1416+  8A1E             ;
1417+  8A1E             ;exampleStart
1418+  8A1E             ;		ld	hl,helloMsg
1419+  8A1E             ;		call	printStr
1420+  8A1E             ;		ret
1421+  8A1E             ;exampleEnd
1422+  8A1E             ;
1423+  8A1E             ;helloMsg	db	16,16,"Hello world!",#0d
1424+  8A1E             ;		db	#00
1425+  8A1E             
1426+  8A1E             ;---------------------------------------
1427+  8A1E             		include "api.asm"
0001++ 8A1E             ;---------------------------------------
0002++ 8A1E             ; CLi (Command Line Interface) API
0003++ 8A1E             ;---------------------------------------
0004++ 8A1E             
0005++ 8A1E             wcKernel	equ	#6006				; WildCommander API
0006++ 8A1E             
0007++ 8A1E             ;---------------------------------------
0008++ 8A1E 16 00       _openStream	ld	d,#00				; окрываем поток с устройством (#00 = инициализация, #ff = сброс в root)
0009++ 8A20 3E 39       		ld	a,_STREAM
0010++ 8A22 C3 06 60    		jp	wcKernel
0011++ 8A25             ;---------------------------------------
0012++ 8A25 16 FF       _pathToRoot	ld	d,#ff				; окрываем поток с устройством (#00 = инициализация, #ff = сброс в root)
0013++ 8A27 01 FF FF    		ld	bc,#ffff			; устройство (#ffff = не создавать заново, использовать текущий поток)
0014++ 8A2A 3E 39       		ld	a,_STREAM
0015++ 8A2C C3 06 60    		jp	wcKernel
0016++ 8A2F             ;---------------------------------------
0017++ 8A2F 3E 16       _checkKeyEnter	ld	a,_ENKE
0018++ 8A31 C3 06 60    		jp	wcKernel
0019++ 8A34             ;---------------------------------------
0020++ 8A34 3E 18       _checkKeyDel	ld	a,_BSPC
0021++ 8A36 C3 06 60    		jp	wcKernel
0022++ 8A39             ;---------------------------------------
0023++ 8A39 3E 11       _checkKeyUp	ld	a,_UPPP
0024++ 8A3B C3 06 60    		jp	wcKernel
0025++ 8A3E             ;---------------------------------------
0026++ 8A3E 3E 12       _checkKeyDown	ld	a,_DWWW
0027++ 8A40 C3 06 60    		jp	wcKernel
0028++ 8A43             ;---------------------------------------
0029++ 8A43 3E 13       _checkKeyLeft	ld	a,_LFFF
0030++ 8A45 C3 06 60    		jp	wcKernel
0031++ 8A48             ;---------------------------------------
0032++ 8A48 3E 14       _checkKeyRight	ld	a,_RGGG
0033++ 8A4A C3 06 60    		jp	wcKernel
0034++ 8A4D             ;---------------------------------------
0035++ 8A4D 3E 27       _checkKeyAlt	ld	a,_ALT
0036++ 8A4F C3 06 60    		jp	wcKernel
0037++ 8A52             ;---------------------------------------
0038++ 8A52 3E 17       _checkKeyEsc	ld	a,_ESC
0039++ 8A54 C3 06 60    		jp	wcKernel
0040++ 8A57             ;---------------------------------------
0041++ 8A57 3E 1D       _checkKeyF1	ld	a,_F1
0042++ 8A59 C3 06 60    		jp	wcKernel
0043++ 8A5C             ;---------------------------------------
0044++ 8A5C 3E 1E       _checkKeyF2	ld	a,_F2
0045++ 8A5E C3 06 60    		jp	wcKernel
0046++ 8A61             ;---------------------------------------
0047++ 8A61 3E 2E       _waitKeyCalm	ld	a,_USPO
0048++ 8A63 C3 06 60    		jp	wcKernel
0049++ 8A66             ;---------------------------------------
0050++ 8A66 CD 27 80    _waitAnyKey	call	waitKeyCalm
0051++ 8A69 3E 2F       		ld	a,_NUSP				; wait 4 anykey
0052++ 8A6B C3 06 60    		jp	wcKernel
0053++ 8A6E             ;---------------------------------------
0054++ 8A6E 3E 01       _getKey		ld	a,#01				; #01 - всегда выдает код из TAI1
0055++ 8A70 08          		ex	af,af'
0056++ 8A71 3E 2A       		ld	a,_KBSCN
0057++ 8A73 C3 06 60    		jp	wcKernel
0058++ 8A76             ;---------------------------------------
0059++ 8A76             _getKeyWithShift
0060++ 8A76 3E 00       		ld	a,#00				; #00 - учитывает SHIFT
0061++ 8A78 08          		ex	af,af'
0062++ 8A79 3E 2A       		ld	a,_KBSCN
0063++ 8A7B C3 06 60    		jp	wcKernel
0064++ 8A7E             ;---------------------------------------
0065++ 8A7E 08          _setRamPage	ex	af,af'				; A' - номер страницы (от 0)
0066++ 8A7F 3E 00       		ld	a,_MNGC_PL			; #FE - первый текстовый экран (в нём панели)
0067++ 8A81 C3 06 60    		jp	wcKernel			; #FF - страница с фонтом (1го текстового экрана)
0068++ 8A84             ;---------------------------------------
0069++ 8A84 08          _setVideoPage	ex	af,af'				; #00-#0F - страницы из 1го видео буфера
0070++ 8A85 3E 41       		ld	a,_MNGCVPL			; #10-#1F - страницы из 2го видео буфера
0071++ 8A87 C3 06 60    		jp	wcKernel
0072++ 8A8A             ;---------------------------------------
0073++ 8A8A 08          _setVideoBuffer	ex	af,af'				; #01 - 1й видео буфер (16 страниц)
0074++ 8A8B 3E 40       		ld	a,_MNGV_PL			; #02 - 2й видео буфер (16 страниц)
0075++ 8A8D C3 06 60    		jp	wcKernel
0076++ 8A90             ;---------------------------------------
0077++ 8A90 08          _setVideoMode	ex	af,af'
0078++ 8A91 3E 42       		ld	a,_GVmod
0079++ 8A93 C3 06 60    		jp	wcKernel
0080++ 8A96             ;---------------------------------------
0081++ 8A96 3E 00       _restoreWC	ld	a,#00				; Восстановление видеорежима для WC (#00 - основной экран (тхт))
0082++ 8A98 08          		ex	af,af'
0083++ 8A99 3E 40       		ld	a,_MNGV_PL
0084++ 8A9B C3 06 60    		jp	wcKernel
0085++ 8A9E             ;---------------------------------------
0086++ 8A9E 3E 3B       _searchEntry	ld	a,_FENTRY
0087++ 8AA0 C3 06 60    		jp	wcKernel
0088++ 8AA3             ;---------------------------------------
0089++ 8AA3 3E 3E       _setFileBegin	ld	a,_GFILE
0090++ 8AA5 C3 06 60    		jp	wcKernel
0091++ 8AA8             ;---------------------------------------
0092++ 8AA8 3E 3F       _setDirBegin	ld	a,_GDIR
0093++ 8AAA C3 06 60    		jp	wcKernel
0094++ 8AAD             ;---------------------------------------
0095++ 8AAD 3E 30       _load512bytes	ld	a,_LOAD512
0096++ 8AAF C3 06 60    		jp	wcKernel
0097++ 8AB2             ;---------------------------------------
0098++ 8AB2 3E 32       _setPosBegin	ld	a,_GIPAGPL
0099++ 8AB4 C3 06 60    		jp	wcKernel
0100++ 8AB7             ;---------------------------------------
0101++ 8AB7             ;---------------------------------------
0102++ 8AB7 3E 44       _setHOffset	ld	a,_GXoff
0103++ 8AB9 C3 06 60    		jp	wcKernel
0104++ 8ABC             ;---------------------------------------
0105++ 8ABC 3E 43       _setVOffset	ld	a,_GYoff
0106++ 8ABE C3 06 60    		jp	wcKernel
0107++ 8AC1             ;---------------------------------------
0108++ 8AC1             DMAPL							; Для совместимости с сорцами Budder/MGN
0109++ 8AC1 08          _callDma	ex	af,af'
0110++ 8AC2 3E 0D       		ld	a,_DMAPL
0111++ 8AC4 C3 06 60    		jp	wcKernel
0112++ 8AC7             ;---------------------------------------
0113++ 8AC7 3E 33       _getFatEntry	ld	a,_TENTRY
0114++ 8AC9 C3 06 60    		jp	wcKernel
0115++ 8ACC             ;---------------------------------------
0116++ 8ACC             
0117++ 8ACC             
0118++ 8ACC             
0119++ 8ACC             ;---------------------------------------
0120++ 8ACC 2A 09 60    _checkSync	ld	hl,(_TMN)
0121++ 8ACF 7C          		ld	a,h
0122++ 8AD0 B5          		or	l
0123++ 8AD1 C8          		ret	z				; Z - ещё не было обновлений - выход
0124++ 8AD2 21 00 00    		ld	hl,#0000
0125++ 8AD5 22 09 60    		ld	(_TMN),hl
0126++ 8AD8 3E 01       		ld	a,1				; NZ - обновление было
0127++ 8ADA B7          		or	a
0128++ 8ADB C9          		ret
0129++ 8ADC             ;---------------------------------------
0130++ 8ADC CD 8C 8B    _printString	call	printStr
0131++ 8ADF C9          		ret
0132++ 8AE0             ;---------------------------------------
0133++ 8AE0 FE 00       _setScreen	cp	#00				; в A - 0 - txt, 1 - gfx
0134++ 8AE2 CA 6C 83    		jp	z,setVideo0
0135++ 8AE5 FE 01       		cp	#01
0136++ 8AE7 CA 8D 83    		jp	z,setVideo1
0137++ 8AEA C9          		ret
0138++ 8AEB             ;---------------------------------------
0139++ 8AEB CD DA 83    _clearGfxScreen	call	gfxCls
0140++ 8AEE 3E 04       		ld	a,appBank
0141++ 8AF0 CD 36 80    		call	setVideoPage
0142++ 8AF3 C9          		ret
0143++ 8AF4             ;---------------------------------------
0144++ 8AF4 E5 C5 F5    _chToHomePath	push	hl,bc,af
0145++ 8AF7             
0146++ 8AF7 21 9A B4    		ld	hl,pathCString
0147++ 8AFA 11 9B B4    		ld	de,pathCString+1
0148++ 8AFD 01 FC 03    		ld	bc,pathStrSize
0149++ 8B00 AF          		xor	a
0150++ 8B01 77          		ld	(hl),a
0151++ 8B02 ED B0       		ldir
0152++ 8B04             
0153++ 8B04 11 9A B4    		ld	de,pathCString
0154++ 8B07 CD 08 88    		call	storePathCall
0155++ 8B0A CD DF 87     		call	restoreHomePath
0156++ 8B0D 11 A0 AC     		ld	de,pathString
0157++ 8B10 CD 85 92     		call	changeDir
0158++ 8B13             
0159++ 8B13 F1 C1 E1    		pop	af,bc,hl
0160++ 8B16 C9          		ret
0161++ 8B17             ;---------------------------------------
0162++ 8B17 E5 C5 F5    _chToCallPath	push	hl,bc,af
0163++ 8B1A             
0164++ 8B1A 11 9A B4     		ld	de,pathCString
0165++ 8B1D CD 85 92     		call	changeDir
0166++ 8B20             
0167++ 8B20 F1 C1 E1    		pop	af,bc,hl
0168++ 8B23 C9          		ret
0169++ 8B24             ;---------------------------------------
0170++ 8B24 EB          _loadResource	ex	de,hl
0171++ 8B25 21 34 8B    		ld	hl,exitResource
0172++ 8B28 E5          		push	hl
0173++ 8B29 FE 01       		cp	resPal				; загрузка палитры
0174++ 8B2B CA A4 94    		jp	z,loadGfxPal
0175++ 8B2E             		
0176++ 8B2E FE 02       		cp	resSpr				; загрузка спрайтов
0177++ 8B30 CA 61 95    		jp	z,loadSprites
0178++ 8B33             
0179++ 8B33 E1          		pop	hl				; тип ресурса не найден
0180++ 8B34             							; TODO: сделать ERROR MSG
0181++ 8B34             
0182++ 8B34 F5          exitResource	push	af
0183++ 8B35 08          		ex	af,af'
0184++ 8B36 F5          		push	af
0185++ 8B37 3E 04       		ld	a,appBank
0186++ 8B39 CD 36 80    		call	setVideoPage
0187++ 8B3C F1          		pop	af
0188++ 8B3D 08          		ex	af,af'
0189++ 8B3E F1          		pop	af
0190++ 8B3F             
0191++ 8B3F C9          		ret
0192++ 8B40             
0193++ 8B40             ;---------------------------------------
0194++ 8B40 08          _printOkStatus	ex	af,af'
0195++ 8B41 FE 00       		cp	#00
0196++ 8B43 C0          		ret	nz
0197++ 8B44 21 99 9E    		ld	hl,statusOkMsg
0198++ 8B47 C3 60 80    		jp	printString
0199++ 8B4A             
0200++ 8B4A             ;---------------------------------------
0201++ 8B4A             
0202++ 8B4A             
1428+  8B4A             		include "print.asm"
0001++ 8B4A             ;---------------------------------------
0002++ 8B4A             ; Main print (output) module
0003++ 8B4A             ;---------------------------------------
0004++ 8B4A 11 00 00    printInit	ld	de,#0000				; начальная инициализация
0005++ 8B4D ED 53 08 91 		ld	(printX),de
0006++ 8B51 3E 5F       		ld	a,defaultCol
0007++ 8B53 32 9F A0    		ld	(curColor),a
0008++ 8B56             
0009++ 8B56 21 00 BF    printClear	ld	hl,bufer256				; очистка буфера256 (ASCII)
0010++ 8B59 11 01 BF    		ld	de,bufer256+1
0011++ 8B5C 01 7F 00    		ld	bc,127
0012++ 8B5F 3E 20       		ld	a," "
0013++ 8B61 77          		ld	(hl),a
0014++ 8B62 ED B0       		ldir
0015++ 8B64             
0016++ 8B64 21 80 BF    		ld	hl,bufer256+128				; очистка буфера256 (Colors)
0017++ 8B67 11 81 BF    		ld	de,bufer256+129
0018++ 8B6A 01 7F 00    		ld	bc,127
0019++ 8B6D             		;ld	a,defaultCol
0020++ 8B6D 3A 9F A0    		ld	a,(curColor)
0021++ 8B70 77          		ld	(hl),a
0022++ 8B71 ED B0       		ldir
0023++ 8B73             
0024++ 8B73 21 00 BF    		ld	hl,bufer256
0025++ 8B76 3E 01       		ld	a,#01
0026++ 8B78 01 00 00    		ld	bc,#0000
0027++ 8B7B CD 68 90    		call	BUF_UPD
0028++ 8B7E C9          		ret
0029++ 8B7F             
0030++ 8B7F             ;---------------------------------------
0031++ 8B7F 3E 20       printSpaceStr	ld	a," "
0032++ 8B81 32 92 8B    		ld	(printExitCode+1),a
0033++ 8B84 CD 8C 8B    		call	printStr
0034++ 8B87 AF          		xor	a
0035++ 8B88 32 92 8B    		ld	(printExitCode+1),a
0036++ 8B8B C9          		ret
0037++ 8B8C             
0038++ 8B8C AF          printStr	xor	a					; Печать строки
0039++ 8B8D 32 0A 91    		ld	(strLen),a
0040++ 8B90             
0041++ 8B90 7E          printSLoop	ld	a,(hl)
0042++ 8B91 FE 00       printExitCode	cp	#00					; Управляющий код: 0 - выход
0043++ 8B93 CA D9 8B    		jp	z,printSExit
0044++ 8B96             
0045++ 8B96 FE 09       		cp	#09					; Управляющий код: 09 - tab
0046++ 8B98 CA 04 8C    		jp	z,codeTab
0047++ 8B9B             		
0048++ 8B9B FE 0C       		cp	#0C					; Управляющий код: 12 - delete
0049++ 8B9D CA 23 8C    		jp	z,codeDelete
0050++ 8BA0 FE 0D       		cp	#0D					; Управляющий код: 13 - new line (enter) windows
0051++ 8BA2 CA 32 8C    		jp	z,codeEnter
0052++ 8BA5 FE 0A       		cp	#0A					; Управляющий код: 10 - new line (enter) unix
0053++ 8BA7 CA 32 8C    		jp	z,codeEnter
0054++ 8BAA FE 10       		cp	#10					; Управляющий код: 16 - ink
0055++ 8BAC CA 50 8C    		jp	z,codeInk
0056++ 8BAF FE 11       		cp	#11					; Управляющий код: 17 - paper
0057++ 8BB1 CA 68 8C    		jp	z,codePaper
0058++ 8BB4 FE 14       		cp	#14					; Управляющий код: 20 - inverse
0059++ 8BB6 CA 8C 8C    		jp	z,codeInverse
0060++ 8BB9 FE 5C       		cp	"\\"					; Управляющий код: \xNN - где NN шестнадцатеричное значение
0061++ 8BBB CA AF 8C    		jp	z,codeESC
0062++ 8BBE             
0063++ 8BBE E5          printS		push	hl
0064++ 8BBF CD 14 8D    		call	printChar
0065++ 8BC2 3A 08 91    		ld	a,(printX)
0066++ 8BC5 3C          		inc	a
0067++ 8BC6 FE 50       		cp	80					; Конец буфера256
0068++ 8BC8 28 21       		jr	z,printS_00
0069++ 8BCA             
0070++ 8BCA 32 08 91    		ld	(printX),a
0071++ 8BCD             
0072++ 8BCD 3A 0A 91    		ld	a,(strLen)
0073++ 8BD0 3C          		inc	a
0074++ 8BD1 32 0A 91    		ld	(strLen),a
0075++ 8BD4             
0076++ 8BD4 E1          		pop	hl
0077++ 8BD5 23          		inc	hl
0078++ 8BD6 C3 90 8B    		jp	printSLoop
0079++ 8BD9             
0080++ 8BD9 21 00 BF    printSExit	ld	hl,bufer256
0081++ 8BDC 3E 01       		ld	a,#01
0082++ 8BDE 01 00 00    		ld	bc,#0000
0083++ 8BE1 CD 68 90    		call	BUF_UPD					; забирается буфер
0084++ 8BE4 CD FC 8B    		call	checkUpdate
0085++ 8BE7 3A 0A 91    		ld	a,(strLen)
0086++ 8BEA C9          		ret
0087++ 8BEB             
0088++ 8BEB E1          printS_00	pop	hl
0089++ 8BEC E5          		push	hl
0090++ 8BED 23          		inc	hl
0091++ 8BEE 7E          		ld	a,(hl)
0092++ 8BEF FE 00       		cp	#00
0093++ 8BF1 20 03       		jr	nz,printS_00a
0094++ 8BF3 E1          		pop	hl
0095++ 8BF4 18 E3       		jr	printSExit
0096++ 8BF6             
0097++ 8BF6 AF          printS_00a	xor	a
0098++ 8BF7 32 08 91    		ld	(printX),a
0099++ 8BFA 18 3E       		jr	nextLine_00
0100++ 8BFC             
0101++ 8BFC CD 5D 80    checkUpdate	call	checkSync				; проверяем необходимость обновления экрана
0102++ 8BFF C8          		ret	z					; нового инта не было - выход
0103++ 8C00 CD 72 80    		call	printWW
0104++ 8C03 C9          		ret
0105++ 8C04             ;---------------------------------------
0106++ 8C04 3A 08 91    codeTab		ld	a,(printX)
0107++ 8C07 CB 3F       		srl	a					; /2
0108++ 8C09 CB 3F       		srl	a					; /4
0109++ 8C0B CB 3F       		srl	a					; /8
0110++ 8C0D FE 09       		cp	#09
0111++ 8C0F 28 21       		jr	z,codeEnter
0112++ 8C11 3C          		inc	a
0113++ 8C12 E5          		push	hl
0114++ 8C13 21 8D 9F    		ld	hl,tabTable
0115++ 8C16 06 00       		ld	b,0
0116++ 8C18 4F          		ld	c,a
0117++ 8C19 09          		add	hl,bc
0118++ 8C1A 7E          		ld	a,(hl)
0119++ 8C1B 32 08 91    		ld	(printX),a
0120++ 8C1E E1          		pop	hl
0121++ 8C1F 23          		inc	hl
0122++ 8C20 C3 90 8B    		jp	printSLoop
0123++ 8C23             ;---------------------------------------
0124++ 8C23 3A 08 91    codeDelete	ld	a,(printX)
0125++ 8C26 FE 00       		cp	#00
0126++ 8C28 28 04       		jr	z,codeDelete_00
0127++ 8C2A 3D          		dec	a
0128++ 8C2B 32 08 91    		ld	(printX),a
0129++ 8C2E 23          codeDelete_00	inc	hl
0130++ 8C2F C3 90 8B    		jp	printSLoop
0131++ 8C32             
0132++ 8C32 23          codeEnter	inc	hl
0133++ 8C33 7E          		ld	a,(hl)
0134++ 8C34 FE 0A       		cp	#0A					; windows \n\r ?
0135++ 8C36 20 01       		jr	nz,nextLine
0136++ 8C38 23          		inc	hl
0137++ 8C39             
0138++ 8C39 E5          nextLine	push	hl
0139++ 8C3A             
0140++ 8C3A 21 00 BF    nextLine_00	ld	hl,bufer256
0141++ 8C3D 3E 00       		ld	a,#00
0142++ 8C3F CD 68 90    		call	BUF_UPD					; забирается буфер
0143++ 8C42             
0144++ 8C42 CD 56 8B    		call	printClear				; очищаем буфер256
0145++ 8C45 CD FC 8B    		call	checkUpdate
0146++ 8C48             
0147++ 8C48 AF          		xor	a
0148++ 8C49 32 08 91    		ld	(printX),a
0149++ 8C4C E1          		pop	hl
0150++ 8C4D C3 90 8B    		jp	printSLoop
0151++ 8C50             
0152++ 8C50             ;---------------------------------------
0153++ 8C50 23          codeInk		inc	hl
0154++ 8C51 7E          		ld	a,(hl)
0155++ 8C52 23          		inc	hl
0156++ 8C53             
0157++ 8C53 FE 10       codeInk_0	cp	16					; 16 ? взять цвет по умолчанию
0158++ 8C55 20 02       		jr	nz,codeInk_1
0159++ 8C57 3E 5F       		ld	a,defaultCol
0160++ 8C59             
0161++ 8C59 E6 0F       codeInk_1	and	%00001111
0162++ 8C5B 4F          		ld	c,a
0163++ 8C5C 3A 9F A0    		ld	a,(curColor)
0164++ 8C5F E6 F0       		and	%11110000
0165++ 8C61 B1          		or	c
0166++ 8C62 32 9F A0    		ld	(curColor),a
0167++ 8C65 C3 90 8B    		jp	printSLoop
0168++ 8C68             
0169++ 8C68 23          codePaper	inc	hl
0170++ 8C69 7E          		ld	a,(hl)
0171++ 8C6A 23          		inc	hl
0172++ 8C6B             
0173++ 8C6B FE 10       codePaper_0	cp	16					; 16 ? взять цвет по умолчанию
0174++ 8C6D 20 06       		jr	nz,codePaper_1
0175++ 8C6F 3E 5F       		ld	a,defaultCol
0176++ 8C71 E6 F0       		and	%11110000
0177++ 8C73 18 0A       		jr	codePaper_2
0178++ 8C75             
0179++ 8C75 E6 0F       codePaper_1	and	%00001111
0180++ 8C77 CB 27       		sla	a
0181++ 8C79 CB 27       		sla	a
0182++ 8C7B CB 27       		sla	a
0183++ 8C7D CB 27       		sla	a
0184++ 8C7F 4F          codePaper_2	ld	c,a
0185++ 8C80 3A 9F A0    		ld	a,(curColor)
0186++ 8C83 E6 0F       		and	%00001111
0187++ 8C85 B1          		or	c
0188++ 8C86 32 9F A0    		ld	(curColor),a
0189++ 8C89 C3 90 8B    		jp	printSLoop
0190++ 8C8C             
0191++ 8C8C 23          codeInverse	inc	hl
0192++ 8C8D 3A 9F A0    		ld	a,(curColor)
0193++ 8C90 E6 0F       		and	%00001111
0194++ 8C92 CB 27       		sla	a
0195++ 8C94 CB 27       		sla	a
0196++ 8C96 CB 27       		sla	a
0197++ 8C98 CB 27       		sla	a
0198++ 8C9A 47          		ld	b,a
0199++ 8C9B 3A 9F A0    		ld	a,(curColor)
0200++ 8C9E E6 F0       		and	%11110000
0201++ 8CA0 CB 3F       		srl	a
0202++ 8CA2 CB 3F       		srl	a
0203++ 8CA4 CB 3F       		srl	a
0204++ 8CA6 CB 3F       		srl	a
0205++ 8CA8 B0          		or	b
0206++ 8CA9 32 9F A0    		ld	(curColor),a
0207++ 8CAC C3 90 8B    		jp	printSLoop
0208++ 8CAF             
0209++ 8CAF 23          codeESC		inc	hl
0210++ 8CB0 7E          		ld	a,(hl)
0211++ 8CB1 FE 5C       codeESC_0	cp	"\\"					; управляющий ESC: BackSlash \
0212++ 8CB3 CA BE 8B    		jp	z,printS
0213++ 8CB6 FE 74       		cp	"t"
0214++ 8CB8 CA 04 8C    		jp	z,codeTab				; управляющий ESC: Tab
0215++ 8CBB FE 6E       		cp	"n"
0216++ 8CBD CA 32 8C    		jp	z,codeEnter				; управляющий ESC: Enter
0217++ 8CC0 FE 72       		cp	"r"
0218++ 8CC2 CA 32 8C    		jp	z,codeEnter				; управляющий ESC: Enter
0219++ 8CC5 FE 78       		cp	"x"
0220++ 8CC7 28 03       		jr	z,codeHex				; управляющий ESC: Hex value
0221++ 8CC9             
0222++ 8CC9 C3 91 8B    		jp	printSLoop+1				; код не опознан = просто напечатать следующий символ
0223++ 8CCC             
0224++ 8CCC 23          codeHex		inc	hl
0225++ 8CCD E5          		push	hl
0226++ 8CCE CD 48 98    		call	hex2int
0227++ 8CD1 E1          		pop	hl
0228++ 8CD2 FE 10       		cp	#10					; Управляющий код: 16 - ink
0229++ 8CD4 28 0C       		jr	z,codeHexI
0230++ 8CD6 FE 11       		cp	#11					; Управляющий код: 17 - paper
0231++ 8CD8 28 21       		jr	z,codeHexP
0232++ 8CDA             
0233++ 8CDA 23          		inc	hl
0234++ 8CDB FE 14       		cp	#14					; Управляющий код: 20 - inverse
0235++ 8CDD 28 AD       		jr	z,codeInverse
0236++ 8CDF C3 BE 8B    		jp	printS					; В противном случае просто напечатать код символа
0237++ 8CE2             
0238++ 8CE2 23          codeHexI	inc	hl
0239++ 8CE3 23          		inc	hl
0240++ 8CE4 7E          		ld	a,(hl)
0241++ 8CE5 FE 5C       		cp	"\\"
0242++ 8CE7 C2 BE 8B    		jp	nz,printS				; Ошибочная структура, пропустить символ
0243++ 8CEA 23          		inc	hl
0244++ 8CEB 7E          		ld	a,(hl)
0245++ 8CEC FE 78       		cp	"x"
0246++ 8CEE 20 C1       		jr	nz,codeESC_0				; Ошибочная структура, пропустить символ
0247++ 8CF0 23          		inc	hl
0248++ 8CF1 E5          		push	hl
0249++ 8CF2 CD 48 98    		call	hex2int
0250++ 8CF5 E1          		pop	hl
0251++ 8CF6 23          		inc	hl
0252++ 8CF7 23          		inc	hl
0253++ 8CF8 C3 53 8C    		jp	codeInk_0
0254++ 8CFB             
0255++ 8CFB 23          codeHexP	inc	hl
0256++ 8CFC 23          		inc	hl
0257++ 8CFD 7E          		ld	a,(hl)
0258++ 8CFE FE 5C       		cp	"\\"
0259++ 8D00 C2 BE 8B    		jp	nz,printS				; Ошибочная структура, пропустить символ
0260++ 8D03 23          		inc	hl
0261++ 8D04 7E          		ld	a,(hl)
0262++ 8D05 FE 78       		cp	"x"
0263++ 8D07 20 A8       		jr	nz,codeESC_0				; Ошибочная структура, пропустить символ
0264++ 8D09 23          		inc	hl
0265++ 8D0A E5          		push	hl
0266++ 8D0B CD 48 98    		call	hex2int
0267++ 8D0E E1          		pop	hl
0268++ 8D0F 23          		inc	hl
0269++ 8D10 23          		inc	hl
0270++ 8D11 C3 6B 8C    		jp	codePaper_0
0271++ 8D14             
0272++ 8D14             ;---------------------------------------
0273++ 8D14 21 00 BF    printChar	ld	hl,bufer256				; печать символа
0274++ 8D17 ED 5B 08 91 		ld	de,(printX)
0275++ 8D1B 19          		add	hl,de
0276++ 8D1C 77          		ld	(hl),a
0277++ 8D1D             		
0278++ 8D1D 3A 9F A0    		ld	a,(curColor)				; печать аттрибутов
0279++ 8D20 11 80 00    		ld	de,128
0280++ 8D23 19          		add	hl,de
0281++ 8D24 77          		ld	(hl),a
0282++ 8D25             
0283++ 8D25             		include "printE.asm"
0001+++8D25             ;---------------------------------------
0002+++8D25             ; Editline print (output) module
0003+++8D25             ;---------------------------------------
0004+++8D25 11 00 00    _editInit	ld	de,#0000				; начальная инициализация
0005+++8D28 ED 53 C2 8E 		ld	(printEX),de
0006+++8D2C             
0007+++8D2C 21 00 BE    editClear	ld	hl,edit256				; очистка редактируемой строки 256 (ASCII)
0008+++8D2F 11 01 BE    		ld	de,edit256+1
0009+++8D32 01 7F 00    		ld	bc,127
0010+++8D35 3E 20       		ld	a," "
0011+++8D37 77          		ld	(hl),a
0012+++8D38 ED B0       		ldir
0013+++8D3A             
0014+++8D3A 21 80 BE    		ld	hl,edit256+128				; очистка буфера256 (Colors)
0015+++8D3D 11 81 BE    		ld	de,edit256+129
0016+++8D40 01 7F 00    		ld	bc,127
0017+++8D43             		;ld	a,defaultCol
0018+++8D43 3A 9F A0    		ld	a,(curColor)
0019+++8D46 77          		ld	(hl),a
0020+++8D47 ED B0       		ldir
0021+++8D49             
0022+++8D49 C9          		ret
0023+++8D4A             
0024+++8D4A E5          _printInLine	push	hl
0025+++8D4B 21 00 00    		ld	hl,#0000
0026+++8D4E 22 C2 8E    		ld	(printEX),hl
0027+++8D51 E1          		pop	hl
0028+++8D52 CD 61 8D    		call	printEStr
0029+++8D55             		
0030+++8D55 21 00 BE    		ld 	hl,edit256
0031+++8D58 3E 01       		ld 	a,#01
0032+++8D5A 01 00 00    		ld 	bc,#0000				; reserved
0033+++8D5D CD 68 90    		call	BUF_UPD
0034+++8D60 C9          		ret
0035+++8D61             ;---------------------------------------
0036+++8D61 AF          printEStr	xor	a					; Печать в строке ввода
0037+++8D62 32 C4 8E    		ld	(eStrLen),a
0038+++8D65             
0039+++8D65 7E          printEStr_0	ld	a,(hl)
0040+++8D66 FE 00       		cp	#00
0041+++8D68 28 41       		jr	z,printEExit
0042+++8D6A             
0043+++8D6A FE 09       		cp	#09					; Управляющий код: 09 - tab
0044+++8D6C CA 43 8E    		jp	z,codeETab
0045+++8D6F FE 10       		cp	#10					; Управляющий код: 16 - ink
0046+++8D71 CA 63 8E    		jp	z,codeEInk
0047+++8D74 FE 11       		cp	#11					; Управляющий код: 17 - paper
0048+++8D76 CA 7B 8E    		jp	z,codeEPaper
0049+++8D79 FE 14       		cp	#14					; Управляющий код: 20 - inverse
0050+++8D7B CA 9F 8E    		jp	z,codeEInverse
0051+++8D7E             
0052+++8D7E E5          		push	hl
0053+++8D7F CD AF 8D    		call	printEChar
0054+++8D82 3A C2 8E    		ld	a,(printEX)
0055+++8D85 3C          		inc	a
0056+++8D86 FE 50       		cp	80					; Конец буфера edit256
0057+++8D88 20 04       		jr	nz,printEStr_1
0058+++8D8A CD 9D 8D    		call	printEUp
0059+++8D8D AF          		xor	a
0060+++8D8E             
0061+++8D8E 32 C2 8E    printEStr_1	ld	(printEX),a
0062+++8D91             
0063+++8D91 3A C4 8E    		ld	a,(eStrLen)
0064+++8D94 3C          		inc	a
0065+++8D95 32 C4 8E    		ld	(eStrLen),a
0066+++8D98             
0067+++8D98 E1          		pop	hl
0068+++8D99 23          		inc	hl
0069+++8D9A C3 65 8D    		jp	printEStr_0
0070+++8D9D             			
0071+++8D9D E5          printEUp	push	hl
0072+++8D9E 21 00 BE    		ld	hl,edit256
0073+++8DA1 3E 00       		ld	a,#00
0074+++8DA3 CD 68 90    		call	BUF_UPD					; забирается буфер
0075+++8DA6 CD 6F 80    		call	editInit
0076+++8DA9             
0077+++8DA9 E1          		pop	hl
0078+++8DAA C9          		ret
0079+++8DAB             
0080+++8DAB 3A C4 8E    printEExit	ld	a,(eStrLen)
0081+++8DAE C9          		ret
0082+++8DAF             
0083+++8DAF 21 00 BE    printEChar	ld	hl,edit256				; печать символа в редактируемой строке
0084+++8DB2 ED 5B C2 8E 		ld	de,(printEX)
0085+++8DB6             
0086+++8DB6 19          		add	hl,de
0087+++8DB7 77          		ld	(hl),a
0088+++8DB8             			
0089+++8DB8             		;ld	a,(curEColor)				; печать аттрибутов
0090+++8DB8 3A 9F A0    		ld	a,(curColor)
0091+++8DBB 11 80 00    		ld	de,128
0092+++8DBE 19          		add	hl,de
0093+++8DBF 77          		ld	(hl),a
0094+++8DC0 C9          		ret
0095+++8DC1             
0096+++8DC1             ;---------------------------------------
0097+++8DC1             showCursor
0098+++8DC1 3E 00       curTimeOut	ld	a,#00
0099+++8DC3 FE 00       		cp	#00
0100+++8DC5 28 05       		jr	z,sc_01
0101+++8DC7 3D          		dec	a
0102+++8DC8 32 C2 8D    		ld	(curTimeOut+1),a
0103+++8DCB C9          		ret
0104+++8DCC             
0105+++8DCC 21 9C A2    sc_01		ld	hl,curAnimPos
0106+++8DCF 7E          		ld	a,(hl)
0107+++8DD0 87          		add	a,a
0108+++8DD1 16 00       		ld	d,#00
0109+++8DD3 5F          		ld	e,a
0110+++8DD4 34          		inc	(hl)
0111+++8DD5 21 9D A2    		ld	hl,curAnim
0112+++8DD8 19          		add	hl,de					; frame
0113+++8DD9 7E          		ld	a,(hl)
0114+++8DDA FE 00       		cp	#00
0115+++8DDC 20 07       		jr	nz,sc_02
0116+++8DDE             
0117+++8DDE 32 9C A2    		ld	(curAnimPos),a
0118+++8DE1 21 9D A2    		ld	hl,curAnim
0119+++8DE4 7E          		ld	a,(hl)
0120+++8DE5             
0121+++8DE5 32 C2 8D    sc_02		ld	(curTimeOut+1),a
0122+++8DE8 23          		inc	hl
0123+++8DE9 7E          		ld	a,(hl)
0124+++8DEA E6 0F       		and	%00001111
0125+++8DEC 4F          		ld	c,a
0126+++8DED             		;ld	a,(curEColor)
0127+++8DED 3A 9F A0    		ld	a,(curColor)
0128+++8DF0 E6 F0       		and	%11110000
0129+++8DF2 B1          		or	c
0130+++8DF3             		;ld	(curEColor),a
0131+++8DF3 32 9F A0    		ld	(curColor),a
0132+++8DF6 3E 5F       		ld	a,cursorType
0133+++8DF8 CD AF 8D    		call	printEChar
0134+++8DFB 3E 5F       		ld	a,defaultCol
0135+++8DFD             		;ld	(curEColor),a
0136+++8DFD 32 9F A0    		ld	(curColor),a
0137+++8E00 C9          		ret
0138+++8E01             
0139+++8E01             ;---------------------------------------
0140+++8E01             ; in A - ASCII code
0141+++8E01 21 A0 9F    printKey	ld	hl,iBuffer
0142+++8E04 06 00       		ld	b,#00
0143+++8E06 F5          		push	af
0144+++8E07 3A 9F 9F    		ld	a,(iBufferPos)
0145+++8E0A             		;cp	iBufferSize-1
0146+++8E0A FE 4D       		cp	80-3					;TODO: iBufferSize
0147+++8E0C 28 29       		jr	z,buffOverload				; Конец строки! Бип и выход!
0148+++8E0E             
0149+++8E0E 4F          		ld	c,a
0150+++8E0F 09          		add	hl,bc
0151+++8E10 3C          		inc	a
0152+++8E11 32 9F 9F    		ld	(iBufferPos),a
0153+++8E14 F1          		pop	af
0154+++8E15 77          		ld	(hl),a
0155+++8E16 CD AF 8D    		call	printEChar
0156+++8E19             		
0157+++8E19 3A C2 8E    		ld	a,(printEX)
0158+++8E1C 3C          		inc	a
0159+++8E1D FE 50       		cp	80					; Конец буфера edit256
0160+++8E1F 20 04       		jr	nz,printKey_00
0161+++8E21 CD 9D 8D    		call	printEUp
0162+++8E24 AF          		xor	a
0163+++8E25             
0164+++8E25 32 C2 8E    printKey_00	ld	(printEX),a
0165+++8E28             
0166+++8E28 3A 9F 9F    		ld	a,(iBufferPos)
0167+++8E2B 06 00       		ld	b,0
0168+++8E2D 4F          		ld	c,a
0169+++8E2E 21 A0 9F    		ld	hl,iBuffer
0170+++8E31 09          		add	hl,bc
0171+++8E32 7E          		ld	a,(hl)
0172+++8E33 32 9E 9F    		ld	(storeKey),a
0173+++8E36 C9          		ret
0174+++8E37             
0175+++8E37 F1          buffOverload	pop	af
0176+++8E38             
0177+++8E38 76          		halt
0178+++8E39 3E 02       		ld	a,#02
0179+++8E3B CD 59 84    		call	setBorder
0180+++8E3E 76          		halt
0181+++8E3F CD 4D 84    		call	restBorder
0182+++8E42 C9          		ret
0183+++8E43             ;---------------------------------------
0184+++8E43 3A C2 8E    codeETab	ld	a,(printEX)
0185+++8E46 CB 3F       		srl	a					; /2
0186+++8E48 CB 3F       		srl	a					; /4
0187+++8E4A CB 3F       		srl	a					; /8
0188+++8E4C FE 09       		cp	#09
0189+++8E4E CA 65 8D    		jp	z,printEStr_0
0190+++8E51 3C          		inc	a
0191+++8E52 E5          		push	hl
0192+++8E53 21 8D 9F    		ld	hl,tabTable
0193+++8E56 06 00       		ld	b,0
0194+++8E58 4F          		ld	c,a
0195+++8E59 09          		add	hl,bc
0196+++8E5A 7E          		ld	a,(hl)
0197+++8E5B 32 C2 8E    		ld	(printEX),a
0198+++8E5E E1          		pop	hl
0199+++8E5F 23          		inc	hl
0200+++8E60 C3 65 8D    		jp	printEStr_0
0201+++8E63             ;---------------------------------------
0202+++8E63 23          codeEInk	inc	hl
0203+++8E64 7E          		ld	a,(hl)
0204+++8E65 23          		inc	hl
0205+++8E66             
0206+++8E66 FE 10       codeEInk_0	cp	16					; 16 ? взять цвет по умолчанию
0207+++8E68 20 02       		jr	nz,codeEInk_1
0208+++8E6A 3E 5F       		ld	a,defaultCol
0209+++8E6C             
0210+++8E6C E6 0F       codeEInk_1	and	%00001111
0211+++8E6E 4F          		ld	c,a
0212+++8E6F 3A 9F A0    		ld	a,(curColor)
0213+++8E72 E6 F0       		and	%11110000
0214+++8E74 B1          		or	c
0215+++8E75 32 9F A0    		ld	(curColor),a
0216+++8E78 C3 65 8D    		jp	printEStr_0
0217+++8E7B             
0218+++8E7B 23          codeEPaper	inc	hl
0219+++8E7C 7E          		ld	a,(hl)
0220+++8E7D 23          		inc	hl
0221+++8E7E             
0222+++8E7E FE 10       codeEPaper_0	cp	16					; 16 ? взять цвет по умолчанию
0223+++8E80 20 06       		jr	nz,codeEPaper_1
0224+++8E82 3E 5F       		ld	a,defaultCol
0225+++8E84 E6 F0       		and	%11110000
0226+++8E86 18 0A       		jr	codeEPaper_2
0227+++8E88             
0228+++8E88 E6 0F       codeEPaper_1	and	%00001111
0229+++8E8A CB 27       		sla	a
0230+++8E8C CB 27       		sla	a
0231+++8E8E CB 27       		sla	a
0232+++8E90 CB 27       		sla	a
0233+++8E92 4F          codeEPaper_2	ld	c,a
0234+++8E93 3A 9F A0    		ld	a,(curColor)
0235+++8E96 E6 0F       		and	%00001111
0236+++8E98 B1          		or	c
0237+++8E99 32 9F A0    		ld	(curColor),a
0238+++8E9C C3 65 8D    		jp	printEStr_0
0239+++8E9F             
0240+++8E9F 23          codeEInverse	inc	hl
0241+++8EA0 3A 9F A0    		ld	a,(curColor)
0242+++8EA3 E6 0F       		and	%00001111
0243+++8EA5 CB 27       		sla	a
0244+++8EA7 CB 27       		sla	a
0245+++8EA9 CB 27       		sla	a
0246+++8EAB CB 27       		sla	a
0247+++8EAD 47          		ld	b,a
0248+++8EAE 3A 9F A0    		ld	a,(curColor)
0249+++8EB1 E6 F0       		and	%11110000
0250+++8EB3 CB 3F       		srl	a
0251+++8EB5 CB 3F       		srl	a
0252+++8EB7 CB 3F       		srl	a
0253+++8EB9 CB 3F       		srl	a
0254+++8EBB B0          		or	b
0255+++8EBC 32 9F A0    		ld	(curColor),a
0256+++8EBF C3 65 8D    		jp	printEStr_0
0257+++8EC2             ;---------------------------------------
0258+++8EC2 00 00       printEX		dw	#0000					; позиция X для печати в edit256
0259+++8EC4 00          eStrLen		db	#00
0260+++8EC5             
0284++ 8EC5             		include "budder.asm"
0001+++8EC5             ;---------------------------------------
0002+++8EC5             ; Code by Budder^MGN
0003+++8EC5             ;---------------------------------------
0004+++8EC5             BSZ     EQU #7F-24
0005+++8EC5             
0006+++8EC5             CLN     EQU 30
0007+++8EC5             
0008+++8EC5             MIN_PAG EQU 1+128;
0009+++8EC5             MAX_PAG EQU 9+128; 128KB buffer
0010+++8EC5             ;-------
0011+++8EC5             PR_POZ  ;i:  A - action type
0012+++8EC5             ;          #00 - clear poz (like cls)
0013+++8EC5             ;          #01 - move up
0014+++8EC5             ;          #02 - move down
0015+++8EC5             ;          #03 - go to buffer start
0016+++8EC5             ;          #04 - go to buffer end
0017+++8EC5             
0017+++8EC5 B7                  OR A
0018+++8EC6 28 0D        JR Z,POZ_CLS
0018+++8EC8 3D                  DEC A
0019+++8EC9 28 1C        JR Z,POZ_UP
0019+++8ECB 3D                  DEC A
0020+++8ECC 28 33        JR Z,POZ_DN
0020+++8ECE 3D                  DEC A
0021+++8ECF 28 44        JR Z,POZ_ST
0021+++8ED1 3D                  DEC A
0022+++8ED2 28 5A        JR Z,POZ_ED
0023+++8ED4 C9                  RET
0024+++8ED5             
0025+++8ED8             POZ_CLS LD A,(CLN_PG),(WW_PG),A
0025+++8ED8 3AFC90320491
0026+++8EDE                     LD HL,(CLN_OF),(WW_OFF),HL
0026+++8EDE 2AFD90220591
0027+++8EE3 3E1E320791          LD A,CLN,(WW_DA),A
0028+++8EE6 C9                  RET
0029+++8EE7             
0030+++8EE7 3A 04 91    POZ_UP  LD A,(WW_PG)
0031+++8EEA 2A 05 91            LD HL,(WW_OFF)
0032+++8EED CD D2 90            CALL PRV_LNR
0032+++8EF0 CD 40 8F            CALL SUP
0033+++8EF3 C0           RET NZ
0034+++8EF4 5F                  LD E,A
0034+++8EF5 CD 23 90            CALL WW_DT
0035+++8EF8 C0           RET NZ
0036+++8EF9 7B                  LD A,E
0037+++8EFA 32 04 91            LD (WW_PG),A
0038+++8EFD 22 05 91            LD (WW_OFF),HL
0039+++8F00 C9                  RET
0040+++8F01             
0041+++8F01 3A 04 91    POZ_DN  LD A,(WW_PG)
0042+++8F04 2A 05 91            LD HL,(WW_OFF)
0042+++8F07 CD 66 8F            CALL SDN
0043+++8F0A C0           RET NZ
0044+++8F0B CD E6 90            CALL NXT_LNR
0045+++8F0E 32 04 91            LD (WW_PG),A
0046+++8F11 22 05 91            LD (WW_OFF),HL
0047+++8F14 C9                  RET
0048+++8F15             
0048+++8F15 CD 80 8F    POZ_ST  CALL SHM
0049+++8F18 D8           RET C
0050+++8F1B 3E01320791          LD A,1,(WW_DA),A
0051+++8F1E 2A 02 91            LD HL,(BR_OFF)
0052+++8F21 3A 01 91            LD A,(BR_PG)
0053+++8F24 CD E6 90            CALL NXT_LNR
0054+++8F27 32 04 91            LD (WW_PG),A
0055+++8F2A 22 05 91            LD (WW_OFF),HL
0056+++8F2D C9                  RET
0057+++8F2E             
0057+++8F2E 3A 07 91    POZ_ED  LD A,(WW_DA)
0057+++8F31 3D           DEC A
0058+++8F32 C0           RET NZ
0059+++8F33             
0060+++8F36                     LD HL,(CLN_OF),(WW_OFF),HL
0060+++8F36 2AFD90220591
0061+++8F3C                     LD A,(CLN_PG),(WW_PG),A
0061+++8F3C 3AFC90320491
0062+++8F3F C9                  RET
0063+++8F40             
0064+++8F40 ED 5B FF 90 SUP     LD DE,(CLN_CT)
0064+++8F44 14                  INC D
0064+++8F45 15           DEC D
0065+++8F46 20 07        JR NZ,ZUP
0066+++8F48 57                  LD D,A
0066+++8F49 7B                  LD A,E
0066+++8F4A FE 1E        CP CLN
0067+++8F4C 38 14        JR C,SNN
0068+++8F4E 7A                  LD A,D
0069+++8F4F ED 5B 01 91 ZUP     LD DE,(BR_PG)
0069+++8F53 BB                  CP E
0070+++8F54 20 0A        JR NZ,SPP
0071+++8F56 ED 5B 02 91         LD DE,(BR_OFF)
0071+++8F5A B7                  OR A
0071+++8F5B ED 52        SBC HL,DE
0072+++8F5D 28 03        JR Z,SNN
0073+++8F5F 19                  ADD HL,DE
0074+++8F60 BF          SPP     CP A
0075+++8F61 C9                  RET
0075+++8F62 3E 01       SNN     LD A,1
0076+++8F64 B7           OR A
0077+++8F65 C9                  RET
0078+++8F66             
0079+++8F66 5F          SDN     LD E,A
0079+++8F67 3A 07 91            LD A,(WW_DA)
0079+++8F6A 3D           DEC A
0080+++8F6B C0           RET NZ
0081+++8F6C 7B                  LD A,E
0082+++8F6D ED 5B FC 90         LD DE,(CLN_PG)
0082+++8F71 BB                  CP E
0083+++8F72 20 EC        JR NZ,SPP
0084+++8F74 ED 5B FD 90         LD DE,(CLN_OF)
0084+++8F78 B7                  OR A
0084+++8F79 ED 52        SBC HL,DE
0085+++8F7B 28 E5        JR Z,SNN
0086+++8F7D 19                  ADD HL,DE
0087+++8F7E 18 E0               JR SPP
0088+++8F80             
0089+++8F80 2A FF 90    SHM     LD HL,(CLN_CT)
0090+++8F83 11 1E 00            LD DE,CLN
0090+++8F86 B7                  OR A
0091+++8F87 ED 52        SBC HL,DE
0092+++8F89 C9                  RET
0093+++8F8A             
0094+++8F8A             ;-------
0095+++8F8A             ;PRINTWW ;i:no inputs
0096+++8F8A             
0097+++8F8A             _printWW
0097+++8F8A 3E FF               LD A,#FF
0098+++8F8C CD C1 8A     CALL DMAPL;Waiting DMA
0098+++8F91 3E 05 06 00         LD A,#05,B,#00
0099+++8F93 CD C1 8A     CALL DMAPL
0099+++8F98 3E 06 06 67         LD A,#06,B,BSZ
0100+++8F9A CD C1 8A     CALL DMAPL
0101+++8F9D             
0101+++8FA1             WWDATA  LD BC,(WW_DA),A,30
0101+++8FA1 ED4B07913E1E
0102+++8FA3 91           SUB C
0103+++8FA5 47 48               LD B,A,C,B
0104+++8FA6             
0105+++8FA6 2A 05 91            LD HL,(WW_OFF)
0105+++8FA9 3A 04 91            LD A,(WW_PG)
0106+++8FAC 28 05        JR Z,A440
0107+++8FAE CD D2 90    WWD     CALL PRV_LNR
0108+++8FB1 10 FB               DJNZ WWD
0109+++8FB3               
0109+++8FB3 41          A440    LD B,C
0110+++8FB4 04           INC B
0111+++8FB5 11 00 00            LD DE,0
0112+++8FB8 C5          WWDTA   PUSH BC
0113+++8FB9 D5                  PUSH DE
0114+++8FBA E5 F5               PUSH HL,AF
0115+++8FBC 47                  LD B,A
0116+++8FBD CD 2C 90            CALL PR_STR
0117+++8FC0 F1 E1               POP AF,HL
0118+++8FC2 CD E6 90            CALL NXT_LNR
0119+++8FC5 D1                  POP DE
0120+++8FC6 EB                  EX DE,HL
0120+++8FC7 01 00 01            LD BC,256
0121+++8FCA 09           ADD HL,BC
0122+++8FCB EB                  EX DE,HL
0122+++8FCC C1                  POP BC
0123+++8FCD 10 E9        DJNZ WWDTA
0124+++8FCF             
0125+++8FCF 3A 07 91            LD A,(WW_DA)
0125+++8FD2 3D          BKK     DEC A
0126+++8FD3 C8           RET Z
0127+++8FD4 F5                  PUSH AF
0128+++8FD5 21 00 1E            LD HL,30*256
0129+++8FD8 06 00               LD B,0;Screen page
0129+++8FDA D5                  PUSH DE
0130+++8FDB CD 2C 90     CALL PR_STR
0131+++8FDE E1                  POP HL
0131+++8FDF 01 00 01            LD BC,256
0131+++8FE2 09           ADD HL,BC
0132+++8FE3 EB           EX DE,HL
0133+++8FE4 F1                  POP AF
0134+++8FE5 18 EB               JR BKK
0135+++8FE7             
0136+++8FEA             WW_UPD  LD HL,(CLN_OF),(WW_OFF),HL
0136+++8FEA 2AFD90220591
0137+++8FF0                     LD A,(CLN_PG),(WW_PG),A
0137+++8FF0 3AFC90320491
0138+++8FF3             
0138+++8FF3 2A FF 90            LD HL,(CLN_CT)
0139+++8FF6 23           INC HL
0140+++8FF8 44 7D               LD B,H,A,L
0141+++8FF9                     DUP 6
0142+++8FF9 CB 38       >        SRL B
0143+++8FFB 1F          > RRA
0142+++8FFC CB 38       >        SRL B
0143+++8FFE 1F          > RRA
0142+++8FFF CB 38       >        SRL B
0143+++9001 1F          > RRA
0142+++9002 CB 38       >        SRL B
0143+++9004 1F          > RRA
0142+++9005 CB 38       >        SRL B
0143+++9007 1F          > RRA
0142+++9008 CB 38       >        SRL B
0143+++900A 1F          > RRA
0144+++900B FE 08               CP MAX_PAG-MIN_PAG
0145+++900D 38 11               JR C,WW_TT
0146+++900F 3A 01 91            LD A,(BR_PG)
0147+++9012 2A 02 91            LD HL,(BR_OFF)
0148+++9015 CD E6 90            CALL NXT_LNR
0149+++9018 32 01 91            LD (BR_PG),A
0150+++901B 22 02 91            LD (BR_OFF),HL
0151+++901E 18 03               JR WW_DT
0152+++9020 22 FF 90    WW_TT   LD (CLN_CT),HL
0153+++9023 3A 07 91    WW_DT   LD A,(WW_DA)
0153+++9026 3D                  DEC A
0154+++9027 C8           RET Z
0155+++9028 32 07 91            LD (WW_DA),A
0156+++902B C9                  RET
0157+++902C             
0158+++902C             PR_STR  ;i:HL - TXT Offset
0159+++902C             ;           B - TXT Page
0160+++902C             ;          DE - Address in Screen
0161+++902C             ;               (#0000-#3F00)
0162+++902C             
0162+++902C D5                  PUSH DE
0162+++902D 3E 01        LD A,#01
0163+++902F CD C1 8A     CALL DMAPL
0164+++9032 D1                  POP DE
0165+++9033 0E 00               LD C,#00
0165+++9035 3E 02               LD A,#02
0166+++9037 CD C1 8A     CALL DMAPL
0166+++903A 3E FE               LD A,#FE
0167+++903C CD C1 8A     CALL DMAPL
0168+++903F C9                  RET
0169+++9040             ;-------
0169+++9040 79          UPD     LD A,C
0169+++9041 B7           OR A
0170+++9042 CA 74 90     JP Z,DMACOPY
0171+++9045 41                  LD B,C
0172+++9046             
0173+++9046 EB                  EX DE,HL
0174+++9047 3A FC 90            LD A,(CLN_PG)
0175+++904A 2A FD 90            LD HL,(CLN_OF)
0176+++904D E5 F5               PUSH HL,AF
0177+++904F D5                  PUSH DE
0177+++9050 CD D2 90            CALL PRV_LNR
0178+++9053 10 FB        DJNZ $-3
0179+++9055 22 FD 90            LD (CLN_OF),HL
0180+++9058 32 FC 90            LD (CLN_PG),A
0180+++905B E1                  POP HL
0181+++905C CD 74 90     CALL DMACOPY
0182+++905F F1 E1               POP AF,HL
0183+++9061 22 FD 90            LD (CLN_OF),HL
0184+++9064 32 FC 90            LD (CLN_PG),A
0185+++9067 C9                  RET       
0186+++9068             
0187+++9068             BUF_UPD ;i:HL - Buffer with STRING(256)
0188+++9068             ;           A: #00 - add sting
0189+++9068             ;                    (no inputs)
0190+++9068             ;              #01 - upd string
0191+++9068             ;                    (BC - delta)
0192+++9068             
0192+++9068 B7                  OR A
0193+++9069 20 D5        JR NZ,UPD
0194+++906B             		
0195+++906B CD 74 90            CALL DMACOPY
0196+++906E CD B0 90            CALL NXT_LN
0197+++9071 C3 E7 8F            JP WW_UPD
0198+++9074             		
0199+++9075 7C 01 40 00 DMACOPY LD A,H,BC,#0040
0199+++9078 91                  SUB C
0199+++9079 38 09        JR C,WW
0200+++907B 04           INC B
0200+++907C 91                  SUB C
0200+++907D 38 05        JR C,WW
0201+++907F 04           INC B
0201+++9080 91                  SUB C
0201+++9081 38 01        JR C,WW
0202+++9083 04           INC B
0202+++9084 81          WW      ADD A,C
0203+++9085 67           LD H,A
0203+++9086 3E 03               LD A,#03
0204+++9088 CD C1 8A     CALL DMAPL
0205+++908B             
0206+++908B                     ;LD A,#05,B,#00:CALL DMAPL
0207+++908B                     ;LD A,#06,B,#7F:CALL DMAPL
0207+++908D 3E 05 06 00         LD A,#05,B,#00
0208+++908F CD C1 8A     CALL DMAPL
0208+++9094 3E 06 06 67         LD A,#06,B,BSZ
0209+++9096 CD C1 8A     CALL DMAPL
0210+++9099             
0211+++909D                     LD BC,(CLN_PG),DE,(CLN_OF)
0211+++909D ED4BFC90ED5BFD90
0211+++90A1 3E 02               LD A,#02
0212+++90A3 CD C1 8A     CALL DMAPL
0213+++90A6             
0213+++90A6 3E FF               LD A,#FF
0214+++90A8 CD C1 8A     CALL DMAPL;Waiting DMA
0214+++90AB 3E FE               LD A,#FE
0215+++90AD C3 C1 8A     JP DMAPL
0216+++90B0             
0217+++90B0 2A FD 90    NXT_LN  LD HL,(CLN_OF)
0217+++90B3 11 00 01            LD DE,256
0218+++90B6 19           ADD HL,DE
0218+++90B7 7C                  LD A,H
0218+++90B8 D6 40        SUB #40
0219+++90BA 30 04        JR NC,NXTPG
0220+++90BC 22 FD 90            LD (CLN_OF),HL
0221+++90BF C9                  RET
0222+++90C1 67 22 FD 90 NXTPG   LD H,A,(CLN_OF),HL
0222+++90C4 3A FC 90            LD A,(CLN_PG)
0223+++90C7 3C           INC A
0223+++90C8 FE 89               CP MAX_PAG
0223+++90CA 38 02        JR C,$+4
0224+++90CC 3E 81        LD A,MIN_PAG
0225+++90CE 32 FC 90            LD (CLN_PG),A
0226+++90D1 C9                  RET
0227+++90D2             
0228+++90D2 11 00 01    PRV_LNR LD DE,256
0228+++90D5 B7                  OR A
0228+++90D6 ED 52        SBC HL,DE
0229+++90D8 D0           RET NC
0230+++90D9 5F                  LD E,A
0230+++90DA 7C                  LD A,H
0230+++90DB E6 3F        AND %00111111
0231+++90DD 67           LD H,A
0232+++90DE 7B                  LD A,E
0233+++90DF 3D                  DEC A
0233+++90E0 FE 81               CP MIN_PAG
0234+++90E2 D0           RET NC
0235+++90E3 3E 88               LD A,MAX_PAG-1
0236+++90E5 C9                  RET
0237+++90E6             
0237+++90E6 11 00 01    NXT_LNR LD DE,256
0238+++90E9 19           ADD HL,DE
0239+++90EA 5F                  LD E,A
0239+++90EB 7C                  LD A,H
0239+++90EC D6 40        SUB #40
0240+++90EE 38 0A        JR C,NLNR
0241+++90F0 67                  LD H,A
0241+++90F1 7B                  LD A,E
0242+++90F2 3C           INC A
0242+++90F3 FE 89               CP MAX_PAG
0242+++90F5 38 02        JR C,$+4
0243+++90F7 3E 81        LD A,MIN_PAG
0244+++90F9 C9                  RET
0245+++90FA 7B          NLNR    LD A,E
0246+++90FB C9                  RET
0247+++90FC             ;---------------------------------------
0248+++90FC 81          CLN_PG  DB MIN_PAG;      Page
0249+++90FD 00 00       CLN_OF  DW #0000;0-#3FFF;Offset
0250+++90FF 00 00       CLN_CT  DW 0;            Count
0251+++9101             
0252+++9101 81          BR_PG   DB MIN_PAG
0253+++9102 00 1C       BR_OFF  DW #0000+28*256
0254+++9104             
0255+++9104 81          WW_PG   DB MIN_PAG
0256+++9105 00 00       WW_OFF  DW #0000
0257+++9107 1E          WW_DA   DB CLN;delta
0258+++9108             ;---------------------------------------
0285++ 9108             
0286++ 9108             ;---------------------------------------
0287++ 9108 00 00       printX		dw	#0000					; позиция X для печати в буфере256
0288++ 910A 00          strLen		db	#00
0289++ 910B             
1429+  910B             		include	"sleep.asm"
0001++ 910B             ;---------------------------------------
0002++ 910B             ; sleep - wait in seconds
0003++ 910B             ;---------------------------------------
0004++ 910B EB          sleepSeconds	ex	de,hl				; hl params
0005++ 910C CD AC 96    		call	str2int
0006++ 910F FE FF       		cp	#ff				; wrong params
0007++ 9111 20 09       		jr	nz,sleep_00
0008++ 9113             
0009++ 9113 21 0D 9B    errorPar	ld	hl,errorParMsg
0010++ 9116 CD 8C 8B    		call	printStr
0011++ 9119 3E FF       		ld	a,#ff				; error
0012++ 911B C9          		ret
0013++ 911C             
0014++ 911C 7D          sleep_00	ld	a,l
0015++ 911D FE 00       		cp	#00
0016++ 911F 20 0C       		jr	nz,sleep_01
0017++ 9121 21 2B 9B    		ld	hl,anyKeyMsg
0018++ 9124 CD 8C 8B    		call	printStr
0019++ 9127             
0020++ 9127 76          		halt
0021++ 9128 CD 2A 80    		call	waitAnyKey
0022++ 912B 18 12       		jr	sleep_02
0023++ 912D             
0024++ 912D F5          sleep_01	push	af
0025++ 912E 21 4B 9B    		ld	hl,restoreMsg
0026++ 9131 CD 8C 8B    		call	printStr
0027++ 9134 F1          		pop	af
0028++ 9135 47          		ld	b,a
0029++ 9136             
0030++ 9136 C5          sleep_01a	push	bc
0031++ 9137 06 32       		ld	b,50
0032++ 9139             
0033++ 9139 76          sleep_01b	halt
0034++ 913A 10 FD       		djnz	sleep_01b
0035++ 913C C1          		pop	bc
0036++ 913D 10 F7       		djnz	sleep_01a
0037++ 913F             
0038++ 913F C9          sleep_02	ret
0039++ 9140             
1430+  9140             		include	"ls.asm"
0001++ 9140             ;---------------------------------------
0002++ 9140             ; ls/dir - read directory
0003++ 9140             ;---------------------------------------
0004++ 9140 EB          listDir		ex	de,hl
0005++ 9141 7E          		ld	a,(hl)
0006++ 9142 FE 00       		cp	#00
0007++ 9144 28 12       		jr	z,lsPathCount
0008++ 9146             
0009++ 9146 E5          		push	hl
0010++ 9147 CD F8 87    		call	storePath
0011++ 914A D1          		pop	de
0012++ 914B CD 85 92    		call	changeDir
0013++ 914E 08          		ex	af,af'
0014++ 914F FE 00       		cp	#00
0015++ 9151 CC 58 91    		call	z,lsPathCount
0016++ 9154             
0017++ 9154 CD 17 88    		call	restorePath
0018++ 9157 C9          		ret
0019++ 9158             
0020++ 9158             
0021++ 9158 3E 00       lsPathCount	ld	a,#00					; path counter
0022++ 915A FE 00       		cp	#00
0023++ 915C 20 05       		jr	nz,lsNotRoot
0024++ 915E             
0025++ 915E CD 06 80    		call	pathToRoot
0026++ 9161 18 09       		jr	lsBegin
0027++ 9163             
0028++ 9163 21 99 A2    lsNotRoot	ld	hl,rootSearch
0029++ 9166 CD 42 80    		call	searchEntry
0030++ 9169 CA 77 92    		jp	z,lsCantReadDir
0031++ 916C             
0032++ 916C AF          lsBegin		xor	a
0033++ 916D 32 D2 91    		ld	(lsCount+1),a
0034++ 9170 32 E7 91    		ld	(itemsCount+1),a
0035++ 9173             
0036++ 9173 CD 45 80    		call	setFileBegin
0037++ 9176             
0038++ 9176 CD 23 92    lsReadAgain	call	clearBuffer
0039++ 9179             
0040++ 9179 21 00 00    		ld	hl,bufferAddr
0041++ 917C 06 01       		ld	b,#01					; 1 block 512b
0042++ 917E CD 4B 80    		call	load512bytes
0043++ 9181             
0044++ 9181 21 00 00    		ld	hl,bufferAddr
0045++ 9184             
0046++ 9184 7E          lsLoop		ld	a,(hl)
0047++ 9185 FE 00       		cp	#00
0048++ 9187 CA F7 91    		jp	z,lsEnd					; если #00 конец записей
0049++ 918A             
0050++ 918A E5          		push	hl
0051++ 918B DD E1       		pop	ix
0052++ 918D DD CB 0B 5E 		bit	3,(ix+11)
0053++ 9191 20 53       		jr	nz,lsSkip+1				; если 1, то запись это ID тома
0054++ 9193 7E          		ld	a,(hl)
0055++ 9194 FE E5       		cp	#e5
0056++ 9196 28 4E       		jr	z,lsSkip+1
0057++ 9198             
0058++ 9198 E5          		push	hl
0059++ 9199 CD 31 92    		call	lsCopyName
0060++ 919C             
0061++ 919C DD CB 0B 66 		bit	4,(ix+11)
0062++ 91A0 28 04       		jr	z,lsNext_00				; если 1, то каталог
0063++ 91A2 3E 0F       		ld	a,colorDir
0064++ 91A4 18 2A       		jr	lsNext
0065++ 91A6             
0066++ 91A6 DD CB 0B 46 lsNext_00	bit	0,(ix+11)
0067++ 91AA 28 04       		jr	z,lsNext_01				; если 1, то файл только для чтения
0068++ 91AC 3E 01       		ld	a,colorRO
0069++ 91AE 18 20       		jr	lsNext
0070++ 91B0             
0071++ 91B0 DD CB 0B 4E lsNext_01	bit	1,(ix+11)
0072++ 91B4 28 04       		jr	z,lsNext_02				; если 1, то файл скрытый
0073++ 91B6 3E 0D       		ld	a,colorHidden
0074++ 91B8 18 16       		jr	lsNext
0075++ 91BA             
0076++ 91BA DD CB 0B 56 lsNext_02	bit	2,(ix+11)
0077++ 91BE 28 04       		jr	z,lsNext_03				; если 1, то файл системный
0078++ 91C0 3E 02       		ld	a,colorSystem
0079++ 91C2 18 0C       		jr	lsNext
0080++ 91C4             
0081++ 91C4 DD CB 0B 6E lsNext_03	bit	5,(ix+11)
0082++ 91C8 28 04       		jr	z,lsNext_04				; если 1, то файл системный
0083++ 91CA 3E 03       		ld	a,colorArch
0084++ 91CC 18 02       		jr	lsNext
0085++ 91CE             
0086++ 91CE 3E 08       lsNext_04	ld	a,colorFile				; в противном случает - обычный файл
0087++ 91D0             
0088++ 91D0 12          lsNext		ld	(de),a
0089++ 91D1             
0090++ 91D1 3E 00       lsCount		ld	a,#00
0091++ 91D3 3C          		inc	a
0092++ 91D4 32 D2 91    		ld	(lsCount+1),a
0093++ 91D7 FE 06       		cp	#06
0094++ 91D9 20 0A       		jr	nz,lsSkip
0095++ 91DB AF          		xor	a
0096++ 91DC 32 D2 91    		ld	(lsCount+1),a
0097++ 91DF             
0098++ 91DF 21 EE A0    		ld	hl,fileOneLine
0099++ 91E2 CD 8C 8B    		call	printStr
0100++ 91E5             
0101++ 91E5 E1          lsSkip		pop	hl
0102++ 91E6             
0103++ 91E6 3E 00       itemsCount	ld	a,#00
0104++ 91E8 3C          		inc	a
0105++ 91E9 32 E7 91    		ld	(itemsCount+1),a
0106++ 91EC FE 10       		cp	16					; 16 записей на сектор
0107++ 91EE 28 2C       		jr	z,lsLoadNext
0108++ 91F0             
0109++ 91F0 01 20 00    		ld	bc,32					; 32 byte = 1 item
0110++ 91F3 09          		add	hl,bc
0111++ 91F4 C3 84 91    		jp	lsLoop
0112++ 91F7             
0113++ 91F7 3A D2 91    lsEnd		ld	a,(lsCount+1)
0114++ 91FA FE 00       		cp	#00
0115++ 91FC 28 17       		jr	z,lsEnd_01
0116++ 91FE             
0117++ 91FE 21 E1 A0    lsEnd_00	ld	hl,nameEmpty
0118++ 9201 CD 31 92    		call	lsCopyName
0119++ 9204 3A D2 91    		ld	a,(lsCount+1)
0120++ 9207 3C          		inc	a
0121++ 9208 32 D2 91    		ld	(lsCount+1),a
0122++ 920B FE 06       		cp	#06
0123++ 920D 20 EF       		jr	nz,lsEnd_00			
0124++ 920F             
0125++ 920F 21 EE A0    		ld	hl,fileOneLine
0126++ 9212 CD 8C 8B    		call	printStr
0127++ 9215             			
0128++ 9215 21 4B 9B    lsEnd_01	ld	hl,restoreMsg
0129++ 9218 CD 8C 8B    		call	printStr
0130++ 921B C9          		ret
0131++ 921C             
0132++ 921C AF          lsLoadNext	xor	a
0133++ 921D 32 E7 91    		ld	(itemsCount+1),a
0134++ 9220 C3 76 91    		jp 	lsReadAgain
0135++ 9223             
0136++ 9223 21 00 00    clearBuffer	ld	hl,bufferAddr
0137++ 9226 11 01 00    		ld	de,bufferAddr+1
0138++ 9229 01 FF 1F    		ld	bc,#1fff
0139++ 922C AF          		xor	a
0140++ 922D 77          		ld	(hl),a
0141++ 922E ED B0       		ldir
0142++ 9230 C9          		ret
0143++ 9231             
0144++ 9231 E5          lsCopyName	push	hl
0145++ 9232 21 EE A0    		ld	hl,fileOneLine
0146++ 9235 06 00       		ld	b,0
0147++ 9237 3A D2 91    		ld	a,(lsCount+1)
0148++ 923A 4F          		ld	c,a
0149++ 923B 87          		add	a,a
0150++ 923C 87          		add	a,a
0151++ 923D 87          		add	a,a
0152++ 923E 87          		add	a,a
0153++ 923F 99          		sbc	c
0154++ 9240 4F          		ld	c,a
0155++ 9241 09          		add	hl,bc
0156++ 9242 EB          		ex	de,hl
0157++ 9243 E1          		pop	hl
0158++ 9244 13          		inc	de
0159++ 9245 D5          		push	de
0160++ 9246 13          		inc	de
0161++ 9247             			
0162++ 9247 01 00 00    		ld	bc,#0000
0163++ 924A 7E          lsCopyLoop	ld	a,(hl)
0164++ 924B FE 20       		cp	" "
0165++ 924D 28 03       		jr	z,lsCopySkip
0166++ 924F 12          		ld	(de),a
0167++ 9250 13          		inc	de
0168++ 9251 0C          		inc	c					; счётчик символов отпечатано (позиция)
0169++ 9252 04          lsCopySkip	inc	b					; счётчик символов всего (позиция)
0170++ 9253 23          		inc	hl
0171++ 9254 78          		ld	a,b
0172++ 9255 FE 0B       		cp	11
0173++ 9257 28 10       		jr	z,lsCopyRet
0174++ 9259 FE 08       		cp	8					; 8.3
0175++ 925B 20 ED       		jr	nz,lsCopyLoop
0176++ 925D 7E          		ld	a,(hl)
0177++ 925E FE 20       		cp	" "
0178++ 9260 28 07       		jr	z,lsCopyRet
0179++ 9262 3E 2E       		ld	a,"."
0180++ 9264 0C          		inc	c
0181++ 9265 12          		ld	(de),a
0182++ 9266 13          		inc	de
0183++ 9267 18 E1       		jr	lsCopyLoop
0184++ 9269             
0185++ 9269 79          lsCopyRet	ld	a,c
0186++ 926A FE 0C       		cp	12
0187++ 926C 30 07       		jr	nc,lsCopyRet_0
0188++ 926E 3E 20       		ld	a," "
0189++ 9270 12          		ld	(de),a
0190++ 9271 0C          		inc	c
0191++ 9272 13          		inc	de
0192++ 9273 18 F4       		jr	lsCopyRet
0193++ 9275             
0194++ 9275 D1          lsCopyRet_0	pop	de
0195++ 9276 C9          		ret
0196++ 9277             
0197++ 9277 21 AB 9B    lsCantReadDir	ld	hl,cantReadDirMsg
0198++ 927A CD 8C 8B    		call	printStr
0199++ 927D C9          		ret
0200++ 927E             
1431+  927E             		include	"cd.asm"
0001++ 927E             ;---------------------------------------
0002++ 927E             ; cd - change work directory
0003++ 927E             ;---------------------------------------
0004++ 927E 3E 01       changeDirSilent	ld	a,1
0005++ 9280 32 34 93    		ld	(cdNotFound+1),a
0006++ 9283 18 04       		jr	changeDir_00
0007++ 9285             
0008++ 9285 AF          changeDir	xor	a
0009++ 9286 32 34 93    		ld	(cdNotFound+1),a
0010++ 9289             
0011++ 9289 EB          changeDir_00	ex	de,hl				; hl params
0012++ 928A 7E          		ld	a,(hl)
0013++ 928B FE 2F       		cp	"/"
0014++ 928D CC 5E 93    		call	z,resetToRoot
0015++ 9290             
0016++ 9290 E5          		push	hl
0017++ 9291 7E          cdLoop		ld	a,(hl)
0018++ 9292 FE 00       		cp	#00
0019++ 9294 28 24       		jr	z,cdLastCheck
0020++ 9296 FE 2F       		cp	"/"
0021++ 9298 28 03       		jr	z,changeNow
0022++ 929A 23          		inc	hl
0023++ 929B 18 F4       		jr	cdLoop
0024++ 929D             
0025++ 929D EB          changeNow	ex	de,hl
0026++ 929E AF          		xor	a
0027++ 929F 12          		ld	(de),a				; end current pos
0028++ 92A0 E1          		pop	hl
0029++ 92A1             		
0030++ 92A1 13          		inc	de
0031++ 92A2 D5          		push	de				; store next pos
0032++ 92A3             
0033++ 92A3 3E 10       		ld	a,flagDir			; directory
0034++ 92A5 CD D7 86    		call	prepareEntry
0035++ 92A8             
0036++ 92A8 21 9A A1    		ld	hl,entrySearch
0037++ 92AB CD 42 80    		call	searchEntry
0038++ 92AE CA 32 93    		jp	z,cdNotFound-1
0039++ 92B1             
0040++ 92B1 CD 48 80    		call	setDirBegin
0041++ 92B4             
0042++ 92B4 CD D6 92    		call	setPathString
0043++ 92B7             
0044++ 92B7 E1          		pop	hl
0045++ 92B8 18 D6       		jr	cdLoop-1
0046++ 92BA             
0047++ 92BA E1          cdLastCheck	pop	hl
0048++ 92BB 7E          		ld	a,(hl)
0049++ 92BC FE 00       		cp	#00
0050++ 92BE CA 4F 93    		jp	z,cdExitOk
0051++ 92C1             
0052++ 92C1 3E 10       		ld	a,flagDir			; directory
0053++ 92C3 CD D7 86    		call	prepareEntry
0054++ 92C6             
0055++ 92C6 21 9A A1    		ld	hl,entrySearch
0056++ 92C9 CD 42 80    		call	searchEntry
0057++ 92CC 28 65       		jr	z,cdNotFound
0058++ 92CE             
0059++ 92CE CD 48 80    		call	setDirBegin
0060++ 92D1             
0061++ 92D1 CD D6 92    		call	setPathString
0062++ 92D4             
0063++ 92D4 18 79       		jr	cdExitOk
0064++ 92D6             
0065++ 92D6             
0066++ 92D6 21 9B A1    setPathString	ld	hl,entrySearch+1
0067++ 92D9 7E          		ld	a,(hl)
0068++ 92DA FE 2E       		cp	"."
0069++ 92DC 20 2D       		jr	nz,incPath
0070++ 92DE 23          		inc	hl
0071++ 92DF 7E          		ld	a,(hl)
0072++ 92E0 FE 2E       		cp	"."
0073++ 92E2 28 05       		jr	z,decPath
0074++ 92E4 FE 00       		cp	#00				; single dir .
0075++ 92E6 C8          		ret	z
0076++ 92E7 18 22       		jr	incPath
0077++ 92E9             
0078++ 92E9 3A 59 91    decPath		ld	a,(lsPathCount+1)
0079++ 92EC 3D          		dec	a
0080++ 92ED 32 59 91    		ld	(lsPathCount+1),a
0081++ 92F0             
0082++ 92F0 21 A0 AC    		ld	hl,pathString
0083++ 92F3 ED 4B 9E AC 		ld	bc,(pathStrPos)
0084++ 92F7 09          		add	hl,bc
0085++ 92F8 1E 00       		ld	e,#00
0086++ 92FA 73          		ld	(hl),e				; pos
0087++ 92FB 2B          		dec	hl
0088++ 92FC 0B          		dec	bc
0089++ 92FD             
0090++ 92FD 73          cdDelLoop	ld	(hl),e				; /
0091++ 92FE 2B          		dec	hl
0092++ 92FF 0B          		dec	bc
0093++ 9300 7E          		ld	a,(hl)
0094++ 9301 FE 2F       		cp	"/"
0095++ 9303 20 F8       		jr	nz,cdDelLoop
0096++ 9305 03          		inc	bc
0097++ 9306 ED 43 9E AC 		ld	(pathStrPos),bc
0098++ 930A C9          		ret
0099++ 930B             
0100++ 930B 3A 59 91    incPath		ld	a,(lsPathCount+1)
0101++ 930E 3C          		inc	a
0102++ 930F 32 59 91    		ld	(lsPathCount+1),a
0103++ 9312             
0104++ 9312 21 A0 AC    		ld	hl,pathString
0105++ 9315 ED 4B 9E AC 		ld	bc,(pathStrPos)
0106++ 9319 09          		add	hl,bc
0107++ 931A EB          		ex	de,hl
0108++ 931B             
0109++ 931B 21 9B A1    		ld	hl,entrySearch+1
0110++ 931E 7E          cdLoopPath	ld	a,(hl)
0111++ 931F FE 00       		cp	#00
0112++ 9321 28 06       		jr	z,cdEndPath
0113++ 9323 12          		ld	(de),a
0114++ 9324 23          		inc	hl
0115++ 9325 13          		inc	de
0116++ 9326 03          		inc	bc
0117++ 9327 18 F5       		jr	cdLoopPath
0118++ 9329             
0119++ 9329 3E 2F       cdEndPath	ld	a,"/"
0120++ 932B 12          		ld	(de),a
0121++ 932C 03          		inc	bc
0122++ 932D ED 43 9E AC 		ld	(pathStrPos),bc
0123++ 9331 C9          		ret
0124++ 9332             
0125++ 9332 E1          		pop	hl
0126++ 9333 3E 00       cdNotFound	ld	a,#00
0127++ 9335 FE 01       		cp	#01
0128++ 9337 28 06       		jr	z,cdNotFound_00
0129++ 9339 21 6E 9B    		ld	hl,dirNotFoundMsg
0130++ 933C CD 8C 8B    		call	printStr
0131++ 933F             
0132++ 933F 21 A0 AC    cdNotFound_00	ld	hl,pathString
0133++ 9342 ED 4B 9E AC 		ld	bc,(pathStrPos)
0134++ 9346 09          		add	hl,bc
0135++ 9347 3E 0D       		ld	a,#0d
0136++ 9349 77          		ld	(hl),a
0137++ 934A             		
0138++ 934A 3E FF       		ld	a,#ff				; alt error
0139++ 934C 08          		ex	af,af'
0140++ 934D AF          		xor	a
0141++ 934E C9          		ret
0142++ 934F             
0143++ 934F 21 A0 AC    cdExitOk	ld	hl,pathString
0144++ 9352 ED 4B 9E AC 		ld	bc,(pathStrPos)
0145++ 9356 09          		add	hl,bc
0146++ 9357 3E 0D       		ld	a,#0d
0147++ 9359 77          		ld	(hl),a
0148++ 935A             
0149++ 935A AF          		xor	a				; alt no error
0150++ 935B 08          		ex	af,af'
0151++ 935C AF          		xor	a				; no error
0152++ 935D C9          		ret
0153++ 935E             
0154++ 935E 23          resetToRoot	inc	hl
0155++ 935F 3A 59 91    		ld	a,(lsPathCount+1)
0156++ 9362 FE 00       		cp	#00
0157++ 9364 C8          		ret	z				; alredy root
0158++ 9365 E5          		push	hl
0159++ 9366 CD 06 80    		call	pathToRoot
0160++ 9369 AF          		xor	a
0161++ 936A 32 59 91    		ld	(lsPathCount+1),a
0162++ 936D CD 30 82    		call	initPath
0163++ 9370 E1          		pop	hl
0164++ 9371 C9          		ret
1432+  9372             		include	"sh.asm"
0001++ 9372             ;---------------------------------------
0002++ 9372             ; sh - execute shell scripts
0003++ 9372             ;---------------------------------------
0004++ 9372 EB          shellExecute	ex	de,hl
0005++ 9373 7E          		ld	a,(hl)
0006++ 9374 FE 00       		cp	#00
0007++ 9376 CA 13 91    		jp	z,errorPar
0008++ 9379             
0009++ 9379 CD 1D 88    		call	checkIsPath
0010++ 937C 08          		ex	af,af'
0011++ 937D FE 00       		cp	#00
0012++ 937F CC 86 93    		call	z,shellExe
0013++ 9382             		
0014++ 9382 CD 17 88    		call	restorePath
0015++ 9385 C9          		ret
0016++ 9386             
0017++ 9386 3E 00       shellExe	ld	a,flagFile			; file
0018++ 9388 CD D7 86    		call	prepareEntry
0019++ 938B             			
0020++ 938B 21 9A A1    		ld	hl,entrySearch
0021++ 938E CD 42 80    		call	searchEntry
0022++ 9391 28 11       		jr	z,fileNotFound
0023++ 9393             
0024++ 9393 22 9A 9F    		ld	(fileLength),hl
0025++ 9396 ED 53 9C 9F 		ld	(fileLength+2),de
0026++ 939A             
0027++ 939A CD 45 80    		call	setFileBegin
0028++ 939D CD B9 93    		call	prepareSize
0029++ 93A0 CD DF 93    		call	loadScript
0030++ 93A3 C9          		ret
0031++ 93A4             
0032++ 93A4 21 8F 9B    fileNotFound	ld	hl,fileNotFoundMsg
0033++ 93A7 CD 8C 8B    		call	printStr
0034++ 93AA 3E FF       		ld	a,#ff				; error
0035++ 93AC C9          		ret
0036++ 93AD             
0037++ 93AD CD EC 81    runSh		call	cliInit				; call as extention
0038++ 93B0 CD B9 93    		call	prepareSize
0039++ 93B3             
0040++ 93B3             		;call	scopeBinary
0041++ 93B3             
0042++ 93B3 CD DF 93    		call	loadScript
0043++ 93B6 C3 08 83    		jp	pluginExit
0044++ 93B9             
0045++ 93B9             ;---------------------------------------
0046++ 93B9 ED 4B 9C 9F prepareSize	ld	bc,(fileLength+2)
0047++ 93BD 78          		ld	a,b
0048++ 93BE B1          		or	c
0049++ 93BF 28 04       		jr	z,ps_01
0050++ 93C1 06 20       		ld	b,#20				; 32 * 512 = 16384 (#4000)
0051++ 93C3 18 0E       		jr	ps_02
0052++ 93C5             
0053++ 93C5 ED 4B 9A 9F ps_01		ld	bc,(fileLength)
0054++ 93C9 AF          		xor	a
0055++ 93CA CB 38       		srl	b
0056++ 93CC 78          		ld	a,b
0057++ 93CD FE 00       		cp	#00
0058++ 93CF 20 02       		jr	nz,ps_02
0059++ 93D1 06 01       		ld	b,#01				; 1 block 512b
0060++ 93D3 FE 20       ps_02		cp	#20
0061++ 93D5 30 02       		jr	nc,ps_03
0062++ 93D7 06 20       		ld	b,#20
0063++ 93D9             
0064++ 93D9 79          ps_03		ld	a,c
0065++ 93DA FE 00       		cp	#00
0066++ 93DC C8          		ret	z
0067++ 93DD 04          		inc	b
0068++ 93DE C9          		ret
0069++ 93DF             
0070++ 93DF             ;---------------------------------------
0071++ 93DF 21 00 00    loadScript	ld	hl,bufferAddr
0072++ 93E2 E5          		push	hl
0073++ 93E3 CD 4B 80    		call	load512bytes
0074++ 93E6             
0075++ 93E6 E1          shExt_Loop	pop	hl
0076++ 93E7 11 A0 9F    		ld	de,iBuffer
0077++ 93EA             
0078++ 93EA 01 00 00    		ld	bc,#0000
0079++ 93ED 7E          shStr_Loop	ld	a,(hl)
0080++ 93EE FE 00       		cp	#00				; end file ?
0081++ 93F0 C8          		ret	z
0082++ 93F1 FE 0D       		cp	#0d				; end string?
0083++ 93F3 28 06       		jr	z,shExt_00
0084++ 93F5 12          		ld	(de),a
0085++ 93F6 23          		inc	hl
0086++ 93F7 13          		inc	de
0087++ 93F8 03          		inc	bc
0088++ 93F9 18 F2       		jr	shStr_Loop
0089++ 93FB             
0090++ 93FB 23          shExt_00	inc	hl
0091++ 93FC 7E          		ld	a,(hl)
0092++ 93FD FE 0A       		cp	#0a
0093++ 93FF 20 01       		jr	nz,shExt_01
0094++ 9401 23          		inc	hl
0095++ 9402             
0096++ 9402 E5          shExt_01	push	hl
0097++ 9403 78          		ld	a,b
0098++ 9404 B1          		or	c
0099++ 9405 28 DF       		jr	z,shExt_Loop			; пропустить пустую строку
0100++ 9407             
0101++ 9407 AF          		xor	a				; сброс флагов
0102++ 9408 21 BD 9E    		ld	hl,cmdTable
0103++ 940B 11 A0 9F    		ld	de,iBuffer
0104++ 940E             		
0105++ 940E 1A          		ld	a,(de)
0106++ 940F FE 00       		cp	#00
0107++ 9411 20 02       		jr	nz,shExt_02
0108++ 9413 E1          		pop	hl
0109++ 9414 C8          		ret	z
0110++ 9415             
0111++ 9415 CD 41 96    shExt_02	call	parser
0112++ 9418 FE FF       		cp	#ff
0113++ 941A 20 CA       		jr	nz,shExt_Loop
0114++ 941C             			
0115++ 941C 21 F0 9A    		ld	hl,errorMsg
0116++ 941F CD 8C 8B    		call	printStr
0117++ 9422 18 C2       		jr	shExt_Loop
0118++ 9424             
1433+  9424             		include	"exec.asm"
0001++ 9424             ;---------------------------------------
0002++ 9424             ; exec - execute application
0003++ 9424             ;---------------------------------------
0004++ 9424 22 91 94    executeApp	ld	(appParams+1),hl	
0005++ 9427 EB          		ex	de,hl
0006++ 9428 7E          		ld	a,(hl)
0007++ 9429 FE 00       		cp	#00
0008++ 942B CA 13 91    		jp	z,errorPar
0009++ 942E             
0010++ 942E CD 1D 88    		call	checkIsPath
0011++ 9431 CD C2 87    		call	storeHomePath
0012++ 9434             		
0013++ 9434 08          		ex	af,af'
0014++ 9435 FE 00       		cp	#00
0015++ 9437 CC 3B 94    		call	z,exeApp
0016++ 943A             
0017++ 943A             		;call	restorePath			; restore start path at exit (ok or error)
0018++ 943A C9          		ret
0019++ 943B             
0020++ 943B 3E 00       exeApp		ld	a,flagFile			; file
0021++ 943D CD D7 86    		call	prepareEntry
0022++ 9440             			
0023++ 9440 21 9A A1    		ld	hl,entrySearch
0024++ 9443 CD 42 80    		call	searchEntry
0025++ 9446 CA A4 93    		jp	z,fileNotFound
0026++ 9449             
0027++ 9449 22 9A 9F    		ld	(fileLength),hl
0028++ 944C ED 53 9C 9F 		ld	(fileLength+2),de
0029++ 9450             
0030++ 9450 CD 45 80    		call	setFileBegin
0031++ 9453 CD B9 93    		call	prepareSize
0032++ 9456 CD 6B 94    		call	loadApp
0033++ 9459 C9          		ret
0034++ 945A             ;---------------------------------------		
0035++ 945A CD EC 81    runApp		call	cliInit
0036++ 945D CD B9 93    		call	prepareSize
0037++ 9460             		
0038++ 9460 CD 6B 94    		call	loadApp
0039++ 9463 FE 00       		cp	#00
0040++ 9465 CA 08 83    		jp	z,pluginExit
0041++ 9468 C3 FE 82    		jp	wrongExit
0042++ 946B             ;---------------------------------------
0043++ 946B 3E 04       loadApp		ld	a,appBank
0044++ 946D CD 36 80    		call	setVideoPage
0045++ 9470             
0046++ 9470 21 FC BF    		ld	hl,appAddr-4
0047++ 9473 E5          		push	hl
0048++ 9474 CD 4B 80    		call	load512bytes
0049++ 9477             
0050++ 9477 E1          		pop	hl
0051++ 9478             
0052++ 9478 7E          		ld	a,(hl)
0053++ 9479 FE 7F       		cp	127
0054++ 947B 20 1E       		jr	nz,wrongApp
0055++ 947D 23          		inc	hl
0056++ 947E             
0057++ 947E 7E          		ld	a,(hl)
0058++ 947F FE 43       		cp	"C"
0059++ 9481 20 18       		jr	nz,wrongApp
0060++ 9483 23          		inc	hl
0061++ 9484             
0062++ 9484 7E          		ld	a,(hl)
0063++ 9485 FE 4C       		cp	"L"
0064++ 9487 20 12       		jr	nz,wrongApp
0065++ 9489 23          		inc	hl
0066++ 948A             
0067++ 948A 7E          		ld	a,(hl)
0068++ 948B FE 41       		cp	"A"
0069++ 948D 20 0C       		jr	nz,wrongApp
0070++ 948F 23          		inc	hl
0071++ 9490             
0072++ 9490 21 00 00    appParams	ld	hl,#0000
0073++ 9493 E5          		push	hl
0074++ 9494 CD 17 88    		call	restorePath
0075++ 9497 E1          		pop	hl
0076++ 9498 C3 00 C0    		jp	appAddr
0077++ 949B             
0078++ 949B 21 49 9C    wrongApp	ld	hl,wrongAppMsg
0079++ 949E CD 8C 8B    		call	printStr
0080++ 94A1 3E FF       		ld	a,#ff				; wrong application
0081++ 94A3 C9          		ret
0082++ 94A4             
1434+  94A4             		include "loadPal.asm"
0001++ 94A4             ;---------------------------------------
0002++ 94A4             ; loadpal - loading palette
0003++ 94A4             ;---------------------------------------
0004++ 94A4 CD DC 94    loadGfxPal	call	loadPal
0005++ 94A7 FE 00       		cp	#00
0006++ 94A9 20 2E       		jr	nz,exitPal
0007++ 94AB             		
0008++ 94AB E5          		push	hl
0009++ 94AC 3E 03       		ld	a,gPalBank			; load Pal File
0010++ 94AE CD 36 80    		call	setVideoPage
0011++ 94B1 E1          		pop	hl
0012++ 94B2             
0013++ 94B2 11 00 FE    		ld	de,gPalAddr			; сохраняем загруженную палитру
0014++ 94B5 01 00 02    		ld	bc,512
0015++ 94B8 ED B0       		ldir
0016++ 94BA AF          		xor	a				; нет ошибок загрузки
0017++ 94BB 18 1C       		jr	exitPal
0018++ 94BD             ;---------------------------------------
0019++ 94BD CD DC 94    loadTxtPal	call	loadPal
0020++ 94C0 FE 00       		cp	#00
0021++ 94C2 20 15       		jr	nz,exitPal
0022++ 94C4             		
0023++ 94C4 E5          		push	hl
0024++ 94C5 3E 03       		ld	a,palBank			; load Pal File
0025++ 94C7 CD 36 80    		call	setVideoPage
0026++ 94CA E1          		pop	hl
0027++ 94CB             
0028++ 94CB 11 00 FC    		ld	de,palAddr			; сохраняем загруженную палитру
0029++ 94CE D5          		push	de
0030++ 94CF 01 00 02    		ld	bc,512
0031++ 94D2 ED B0       		ldir
0032++ 94D4 E1          		pop	hl
0033++ 94D5 CD 4B 95    		call	setFilePal
0034++ 94D8             
0035++ 94D8 AF          		xor	a
0036++ 94D9             
0037++ 94D9 08          exitPal		ex	af,af'
0038++ 94DA AF          		xor	a				; убирает сообщение "unknown command"
0039++ 94DB C9          		ret
0040++ 94DC             ;---------------------------------------
0041++ 94DC EB          loadPal		ex	de,hl
0042++ 94DD 7E          		ld	a,(hl)
0043++ 94DE FE 00       		cp	#00
0044++ 94E0 CA 13 91    		jp	z,errorPar
0045++ 94E3             
0046++ 94E3 CD 1D 88    		call	checkIsPath
0047++ 94E6 08          		ex	af,af'
0048++ 94E7 FE 00       		cp	#00
0049++ 94E9 CC F4 94    		call	z,findPalFile
0050++ 94EC             		;cp	#ff
0051++ 94EC             		;ret	z
0052++ 94EC E5 F5       		push	hl,af
0053++ 94EE CD 17 88    		call	restorePath
0054++ 94F1 F1 E1       		pop	af,hl
0055++ 94F3 C9          		ret
0056++ 94F4             
0057++ 94F4 3E 00       findPalFile	ld	a,flagFile			; file
0058++ 94F6 CD D7 86    		call	prepareEntry
0059++ 94F9             			
0060++ 94F9 21 9A A1    		ld	hl,entrySearch
0061++ 94FC CD 42 80    		call	searchEntry
0062++ 94FF CA A4 93    		jp	z,fileNotFound
0063++ 9502             		
0064++ 9502 22 9A 9F    		ld	(fileLength),hl
0065++ 9505 ED 53 9C 9F 		ld	(fileLength+2),de
0066++ 9509             		
0067++ 9509 7A          		ld	a,d				; #0000
0068++ 950A B3          		or	e
0069++ 950B C2 F6 89    		jp	nz,wrongFileSize
0070++ 950E 7C          		ld	a,h
0071++ 950F FE 02       		cp	#02				; #0204 = 512b + header
0072++ 9511 C2 F6 89    		jp	nz,wrongFileSize
0073++ 9514 7D          		ld	a,l
0074++ 9515 FE 04       		cp	#04
0075++ 9517 C2 F6 89    		jp	nz,wrongFileSize
0076++ 951A             
0077++ 951A CD 45 80    		call	setFileBegin
0078++ 951D CD B9 93    		call	prepareSize
0079++ 9520             
0080++ 9520 21 00 00    		ld	hl,#0000
0081++ 9523 E5          		push	hl
0082++ 9524 CD 4B 80    		call	load512bytes
0083++ 9527             
0084++ 9527 E1          		pop	hl
0085++ 9528             
0086++ 9528 7E          		ld	a,(hl)
0087++ 9529 FE 7F       		cp	127
0088++ 952B 20 15       		jr	nz,wrongPal
0089++ 952D 23          		inc	hl
0090++ 952E             
0091++ 952E 7E          		ld	a,(hl)
0092++ 952F FE 50       		cp	"P"
0093++ 9531 20 0F       		jr	nz,wrongPal
0094++ 9533 23          		inc	hl
0095++ 9534             
0096++ 9534 7E          		ld	a,(hl)
0097++ 9535 FE 41       		cp	"A"
0098++ 9537 20 09       		jr	nz,wrongPal
0099++ 9539 23          		inc	hl
0100++ 953A             
0101++ 953A 7E          		ld	a,(hl)
0102++ 953B FE 4C       		cp	"L"
0103++ 953D 20 03       		jr	nz,wrongPal
0104++ 953F 23          		inc	hl
0105++ 9540             
0106++ 9540 AF          		xor	a
0107++ 9541 C9          		ret						; pal file is ok
0108++ 9542             
0109++ 9542 21 74 9C    wrongPal	ld	hl,wrongPalMsg
0110++ 9545 CD 8C 8B    		call	printStr
0111++ 9548 3E FF       		ld	a,#ff					; wrong pal file
0112++ 954A C9          		ret
0113++ 954B             
0114++ 954B 01 AF 15    setFilePal	ld	bc,FMAddr
0115++ 954E 3E 10       		ld 	a,%00010000				; Разрешить приём данных для палитры (?) Bit 4 - FM_EN установлен
0116++ 9550 ED 79       		out	(c),a
0117++ 9552             
0118++ 9552 11 00 00    		ld 	de,#0000				; Память с палитрой замапливается на адрес #0000
0119++ 9555 01 00 02    		ld	bc,512
0120++ 9558 ED B0       		ldir
0121++ 955A             
0122++ 955A 01 AF 15    		ld 	bc,FMAddr			
0123++ 955D AF          		xor	a					; Запретить, Bit 4 - FM_EN сброшен
0124++ 955E ED 79       		out	(c),a
0125++ 9560 C9          		ret
0126++ 9561             
0127++ 9561             
1435+  9561             		include "loadSpr.asm"
0001++ 9561             ;---------------------------------------
0002++ 9561             ; loadspr - loading sprite resource
0003++ 9561             ;---------------------------------------
0004++ 9561             
0005++ 9561 AF          loadSprites	xor	a
0006++ 9562 79          		ld	a,c
0007++ 9563             		; TODO: если значение получилось больше #40, то включить следующую банку!
0008++ 9563 CB 27       		sla	a
0009++ 9565 CB 27       		sla	a
0010++ 9567 CB 27       		sla	a	
0011++ 9569 32 CC 95    		ld	(addAddr+2),a
0012++ 956C             
0013++ 956C EB          		ex	de,hl
0014++ 956D 7E          		ld	a,(hl)
0015++ 956E FE 00       		cp	#00
0016++ 9570 CA 13 91    		jp	z,errorPar
0017++ 9573             
0018++ 9573 CD 1D 88    		call	checkIsPath
0019++ 9576 08          		ex	af,af'
0020++ 9577 FE FF       		cp	#ff
0021++ 9579 28 21       		jr	z,exitSpr
0022++ 957B             
0023++ 957B E5          loadSpr		push	hl
0024++ 957C 7E          		ld	a,(hl)
0025++ 957D 23          		inc	hl
0026++ 957E FE 00       		cp	#00
0027++ 9580 20 FA       		jr	nz,loadSpr+1
0028++ 9582 2B          		dec	hl
0029++ 9583 2B          		dec	hl
0030++ 9584 11 50 9A    		ld	de,sprType+2
0031++ 9587             
0032++ 9587 7E          		ld	a,(hl)
0033++ 9588 12          		ld	(de),a
0034++ 9589 1B          		dec	de
0035++ 958A 2B          		dec	hl
0036++ 958B 7E          		ld	a,(hl)
0037++ 958C 12          		ld	(de),a
0038++ 958D 1B          		dec	de
0039++ 958E 2B          		dec	hl
0040++ 958F 7E          		ld	a,(hl)
0041++ 9590 12          		ld	(de),a				; store extension
0042++ 9591             
0043++ 9591 E1          		pop	hl
0044++ 9592             
0045++ 9592 CD 9E 95    		call	findSprFile
0046++ 9595             		;cp	#ff
0047++ 9595             		;ret	z
0048++ 9595 E5 F5       		push	hl,af
0049++ 9597 CD 17 88    		call	restorePath
0050++ 959A F1 E1       		pop	af,hl
0051++ 959C             
0052++ 959C 08          exitSpr		ex	af,af'
0053++ 959D C9          		ret
0054++ 959E             
0055++ 959E 3E 00       findSprFile	ld	a,flagFile			; file
0056++ 95A0 CD D7 86    		call	prepareEntry
0057++ 95A3             			
0058++ 95A3 21 9A A1    		ld	hl,entrySearch
0059++ 95A6 CD 42 80    		call	searchEntry
0060++ 95A9 CA A4 93    		jp	z,fileNotFound
0061++ 95AC             
0062++ 95AC 22 9A 9F    		ld	(fileLength),hl
0063++ 95AF ED 53 9C 9F 		ld	(fileLength+2),de
0064++ 95B3             
0065++ 95B3 CD 45 80    		call	setFileBegin
0066++ 95B6 CD B9 93    		call	prepareSize
0067++ 95B9             
0068++ 95B9             		; TODO: Сделать проверку на тип файла, если bin = просто загрузка
0069++ 95B9             		; если другой тип (tga,bmp,spr) загружать по частям и декодировать
0070++ 95B9             		; если файл больше длины #4000, сменить банку
0071++ 95B9             
0072++ 95B9 3E 08       		ld	a,sprBank
0073++ 95BB CD 36 80    		call	setVideoPage
0074++ 95BE             
0075++ 95BE 3A 03 60    		ld	a,(_PAGE3)			; устанавливаем страницу где у нас живут спрайты
0076++ 95C1 01 AF 19    		ld	bc,SGPage
0077++ 95C4 ED 79       		out	(c),a
0078++ 95C6             
0079++ 95C6 C5          		push	bc
0080++ 95C7 21 00 C0    		ld	hl,sprAddr
0081++ 95CA 01 00 00    addAddr		ld	bc,#0000
0082++ 95CD 09          		add	hl,bc
0083++ 95CE C1          		pop	bc
0084++ 95CF E5          		push	hl
0085++ 95D0 CD 4B 80    		call	load512bytes
0086++ 95D3 E1          		pop	hl
0087++ 95D4             
0088++ 95D4 AF          		xor	a
0089++ 95D5 C9          		ret
0090++ 95D6             
1436+  95D6             		include "loadFnt.asm"
0001++ 95D6             ;---------------------------------------
0002++ 95D6             ; loadfnt - loading font
0003++ 95D6             ;---------------------------------------
0004++ 95D6 CD F3 95    loadTxtFnt	call	loadFnt
0005++ 95D9 FE 00       		cp	#00
0006++ 95DB 20 13       		jr	nz,exitFnt
0007++ 95DD             		
0008++ 95DD E5          		push	hl
0009++ 95DE             		; Включаем страницу с нашим фонтом
0010++ 95DE 3E 01       		ld	a,#01
0011++ 95E0 CD 36 80    		call	setVideoPage
0012++ 95E3             
0013++ 95E3             		; Клонируем шрифт из #0000
0014++ 95E3 21 00 00    		ld	hl,#0000
0015++ 95E6 11 00 C0    		ld	de,#c000
0016++ 95E9 01 00 08    		ld	bc,2048
0017++ 95EC ED B0       		ldir
0018++ 95EE E1          		pop	hl
0019++ 95EF             
0020++ 95EF AF          		xor	a
0021++ 95F0             
0022++ 95F0 08          exitFnt		ex	af,af'
0023++ 95F1 AF          		xor	a				; убирает сообщение "unknown command"
0024++ 95F2 C9          		ret
0025++ 95F3             ;---------------------------------------
0026++ 95F3 EB          loadFnt		ex	de,hl
0027++ 95F4 7E          		ld	a,(hl)
0028++ 95F5 FE 00       		cp	#00
0029++ 95F7 CA 13 91    		jp	z,errorPar
0030++ 95FA             
0031++ 95FA CD 1D 88    		call	checkIsPath
0032++ 95FD 08          		ex	af,af'
0033++ 95FE FE 00       		cp	#00
0034++ 9600 CC 0B 96    		call	z,findFntFile
0035++ 9603             		;cp	#ff
0036++ 9603             		;ret	z
0037++ 9603 E5 F5       		push	hl,af
0038++ 9605 CD 17 88    		call	restorePath
0039++ 9608 F1 E1       		pop	af,hl
0040++ 960A C9          		ret
0041++ 960B             
0042++ 960B 3E 00       findFntFile	ld	a,flagFile			; file
0043++ 960D CD D7 86    		call	prepareEntry
0044++ 9610             			
0045++ 9610 21 9A A1    		ld	hl,entrySearch
0046++ 9613 CD 42 80    		call	searchEntry
0047++ 9616 CA A4 93    		jp	z,fileNotFound
0048++ 9619             		
0049++ 9619 22 9A 9F    		ld	(fileLength),hl
0050++ 961C ED 53 9C 9F 		ld	(fileLength+2),de
0051++ 9620             
0052++ 9620 7A          		ld	a,d				; #0000
0053++ 9621 B3          		or	e
0054++ 9622 C2 F6 89    		jp	nz,wrongFileSize
0055++ 9625 7C          		ld	a,h
0056++ 9626 FE 08       		cp	#08				; #0800
0057++ 9628 C2 F6 89    		jp	nz,wrongFileSize
0058++ 962B 7D          		ld	a,l
0059++ 962C FE 00       		cp	#00
0060++ 962E C2 F6 89    		jp	nz,wrongFileSize
0061++ 9631             
0062++ 9631 CD 45 80    		call	setFileBegin
0063++ 9634 CD B9 93    		call	prepareSize
0064++ 9637             
0065++ 9637 21 00 00    		ld	hl,#0000
0066++ 963A E5          		push	hl
0067++ 963B CD 4B 80    		call	load512bytes
0068++ 963E             
0069++ 963E E1          		pop	hl
0070++ 963F             
0071++ 963F AF          		xor	a
0072++ 9640 C9          		ret
1437+  9641             ;		include "modLoad.asm"
1438+  9641             ;		include "neoGS.asm"
1439+  9641             		include "parser.asm"
0001++ 9641             ;---------------------------------------
0002++ 9641             ; Command line parser
0003++ 9641             ;---------------------------------------
0004++ 9641             ; In: de, command string addr
0005++ 9641             ;	  hl, table of commands list
0006++ 9641             ; Out:a,#ff = command not found
0007++ 9641             ;     a,#00 - command found, hl - addr params start
0008++ 9641             
0009++ 9641             ;startCode
0010++ 9641             ;		ld	hl,table
0011++ 9641             ;		ld	de,cmd_buffer
0012++ 9641             ;		call	parser
0013++ 9641             
0014++ 9641 CD 9F 96    parser		call	eat_space
0015++ 9644 ED 53 AA 96 		ld	(storeAddr),de
0016++ 9648             
0017++ 9648 1A          		ld	a,(de)
0018++ 9649 FE 23       		cp	"#"				; first simbol comment
0019++ 964B C8          		ret	z
0020++ 964C FE 3B       		cp	";"				; first simbol comment
0021++ 964E C8          		ret	z
0022++ 964F             
0023++ 964F 1A          parse_start	ld      a,(de)
0024++ 9650 FE 00       		cp	#00				; space means end of buffer
0025++ 9652 CA 89 96    		jp	z,end_of_command
0026++ 9655 FE 20       		cp	" "				; space means end of command
0027++ 9657 CA 89 96    		jp	z,end_of_command
0028++ 965A             
0029++ 965A FE 41       		cp	"A"
0030++ 965C 38 06       		jr	c,parse_skip
0031++ 965E FE 5A       		cp	"Z"
0032++ 9660 30 02       		jr	nc,parse_skip
0033++ 9662 C6 20       		add	32
0034++ 9664             
0035++ 9664 BE          parse_skip	cp	(hl)				; Compare a with first character in command table
0036++ 9665 C2 6C 96    		jp	nz,next_command			; Move HL to point to the first character of the next command in the table
0037++ 9668 13          		inc	de
0038++ 9669 23          		inc	hl
0039++ 966A 18 E3       		jr	parse_start
0040++ 966C             
0041++ 966C F5          next_command	push 	af
0042++ 966D 3E 2A       		ld	a,"*"
0043++ 966F BE          		cp	(hl)				; Is it the end off command * ?
0044++ 9670 CA 7E 96    		jp	z,forward			; Yes inc HL 3 times to set to begining of next command in the table
0045++ 9673             
0046++ 9673 3E 00       		ld	a,#00				; Table end reached ?
0047++ 9675 BE          		cp	(hl)
0048++ 9676 CA 9B 96    		jp	z,no_match
0049++ 9679 F1          		pop	af
0050++ 967A 23          		inc	hl
0051++ 967B C3 6C 96                	jp	next_command
0052++ 967E             
0053++ 967E F1          forward		pop	af
0054++ 967F 23          		inc	hl
0055++ 9680 23          		inc	hl
0056++ 9681 23          		inc	hl
0057++ 9682 ED 5B AA 96 		ld	de,(storeAddr)
0058++ 9686 C3 4F 96    		jp	parse_start
0059++ 9689             
0060++ 9689 CD 9F 96    end_of_command	call	eat_space
0061++ 968C 7E          		ld	a,(hl)
0062++ 968D FE 2A       		cp	"*"
0063++ 968F 20 0B       		jr	nz,no_match+1
0064++ 9691             
0065++ 9691 23          		inc	hl				; increase to *
0066++ 9692             							; Increase to point to jump vector for command
0067++ 9692 7E          		ld	a,(hl)
0068++ 9693 23          		inc	hl
0069++ 9694 66          		ld	h,(hl)
0070++ 9695 6F          		ld	l,a
0071++ 9696 ED 53 AA 96 		ld	(storeAddr),de
0072++ 969A E9          		jp	(hl)				; de - addr start params
0073++ 969B             
0074++ 969B F1          no_match	pop	af
0075++ 969C             							; Routine to print "Unkown command error"
0076++ 969C 3E FF       		ld	a,#ff
0077++ 969E C9          		ret
0078++ 969F             
0079++ 969F 1A          eat_space	ld	a,(de)
0080++ 96A0 FE 00       		cp	#00
0081++ 96A2 C8          		ret	z				; if reach to the end of buffer
0082++ 96A3 FE 20       		cp	#20				; check for space
0083++ 96A5 C0          		ret	nz
0084++ 96A6 13          		inc	de
0085++ 96A7 C3 9F 96    		jp	eat_space
0086++ 96AA             
0087++ 96AA 00 00       storeAddr	dw	#0000
0088++ 96AC             
1440+  96AC             		include "str2int.asm"
0001++ 96AC             ;---------------------------------------
0002++ 96AC             ; string to int converter
0003++ 96AC             ;---------------------------------------
0004++ 96AC             ; in: hl,string addr
0005++ 96AC             ; out:hl = value
0006++ 96AC             
0007++ 96AC 01 00 00    str2int		ld	bc,#0000
0008++ 96AF 11 00 00    		ld	de,#0000
0009++ 96B2 EB          		ex	de,hl
0010++ 96B3 22 48 97    		ld	(intBuffer),hl
0011++ 96B6 EB          		ex	de,hl
0012++ 96B7             
0013++ 96B7 7E          calcLen		ld	a,(hl)
0014++ 96B8 FE 20       		cp	#20					; end as space
0015++ 96BA 28 10       		jr	z,calcVal
0016++ 96BC FE 00       		cp	#00					; end as zero
0017++ 96BE 28 0C       		jr	z,calcVal
0018++ 96C0 FE 30       		cp	"0"
0019++ 96C2 38 50       		jr	c,wrongValue
0020++ 96C4 FE 3A       		cp	"9"+1
0021++ 96C6 30 4C       		jr	nc,wrongValue
0022++ 96C8 04          		inc	b
0023++ 96C9 23          		inc	hl
0024++ 96CA 18 EB       		jr	calcLen
0025++ 96CC             
0026++ 96CC 78          calcVal		ld	a,b
0027++ 96CD FE 00       		cp	#00
0028++ 96CF 28 43       		jr	z,wrongValue
0029++ 96D1             
0030++ 96D1 32 06 97    		ld	(calcEnd+1),a
0031++ 96D4 06 00       		ld	b,#00
0032++ 96D6             
0033++ 96D6 2B          calcLoop	dec	hl
0034++ 96D7 7E          		ld	a,(hl)
0035++ 96D8 D6 30       		sub	#30					; ascii 0
0036++ 96DA             
0037++ 96DA E5          		push	hl
0038++ 96DB C5          		push	bc
0039++ 96DC             
0040++ 96DC F5          		push	af
0041++ 96DD 78          		ld	a,b
0042++ 96DE B1          		or	c
0043++ 96DF 20 0D       		jr	nz,calcSkip
0044++ 96E1 F1          		pop	af
0045++ 96E2 26 00       		ld	h,0
0046++ 96E4 6F          		ld	l,a
0047++ 96E5 22 48 97    		ld      (intBuffer),hl
0048++ 96E8 F1          		pop	af
0049++ 96E9 01 0A 00    		ld	bc,10
0050++ 96EC 18 16       		jr	calcNext
0051++ 96EE             
0052++ 96EE F1          calcSkip	pop	af
0053++ 96EF C5          		push	bc
0054++ 96F0 E1          		pop	hl
0055++ 96F1 CD 1A 97    		call	mult16x8
0056++ 96F4 EB          		ex	de,hl
0057++ 96F5 2A 48 97    		ld	hl,(intBuffer)
0058++ 96F8 19          		add	hl,de
0059++ 96F9 22 48 97    		ld      (intBuffer),hl
0060++ 96FC             
0061++ 96FC E1          		pop	hl					; bc
0062++ 96FD 3E 0A       		ld	a,10
0063++ 96FF CD 1A 97    		call    mult16x8
0064++ 9702 E5          		push	hl
0065++ 9703 C1          		pop	bc
0066++ 9704             
0067++ 9704 E1          calcNext	pop	hl
0068++ 9705             
0069++ 9705 3E 00       calcEnd		ld	a,#00
0070++ 9707 3D          		dec	a
0071++ 9708 32 06 97    		ld	(calcEnd+1),a
0072++ 970B FE 00       		cp	#00
0073++ 970D 20 C7       		jr	nz,calcLoop
0074++ 970F 2A 48 97    		ld	hl,(intBuffer)
0075++ 9712 AF          		xor	a					; ok
0076++ 9713 C9          		ret
0077++ 9714             
0078++ 9714 21 00 00    wrongValue	ld	hl,#0000
0079++ 9717 3E FF       		ld	a,#ff					; error!
0080++ 9719 C9          		ret
0081++ 971A             
0082++ 971A             ;-------------------------------------------
0083++ 971A             ; multiplication
0084++ 971A             ;-------------------------------------------
0085++ 971A             ; in: hl * a
0086++ 971A             ; out:hl,low de,high
0087++ 971A             
0088++ 971A 11 00 00    mult16x8	ld	de,#0000
0089++ 971D ED 53 44 97 		ld	(mult16x8_2 + 1),de
0090++ 9721 FE 00       	        cp      #00
0091++ 9723 20 04       		jr	nz,mult16x8_00
0092++ 9725 21 00 00    		ld	hl,#0000
0093++ 9728 C9          		ret
0094++ 9729             
0095++ 9729 FE 01       mult16x8_00	cp	#01
0096++ 972B C8          		ret	z
0097++ 972C             
0098++ 972C C5          		push	bc
0099++ 972D 3D          		dec	a
0100++ 972E 47          		ld	b,a
0101++ 972F 0E 00       		ld	c,0
0102++ 9731 E5          		push	hl
0103++ 9732 D1          		pop	de
0104++ 9733             
0105++ 9733 19          mult16x8_0	add	hl,de
0106++ 9734 30 0B       		jr	nc,mult16x8_1
0107++ 9736 D5          		push	de
0108++ 9737 ED 5B 44 97 		ld	de,(mult16x8_2 + 1)
0109++ 973B 13          		inc	de
0110++ 973C ED 53 44 97 		ld	(mult16x8_2 + 1),de
0111++ 9740 D1          		pop	de
0112++ 9741 10 F0       mult16x8_1	djnz	mult16x8_0
0113++ 9743             
0114++ 9743 11 00 00    mult16x8_2	ld	de,#0000
0115++ 9746 C1          		pop	bc
0116++ 9747 C9          		ret							
0117++ 9748             
0118++ 9748             ;-------------------------------------------
0119++ 9748 00 00       intBuffer	dw	#0000
0120++ 974A             
1441+  974A             		include "int2str.asm"
0001++ 974A             ;--------------------------------------------------------------
0002++ 974A             ; int2str перевод int в текст (десятичное число)
0003++ 974A             ; (C) BUDDER/MGN - 2011.12.26
0004++ 974A             ; char2str перевод char(8bit) в текст (десятичное число)
0005++ 974A             ; Added by breeze
0006++ 974A             ;--------------------------------------------------------------
0007++ 974A             ; i:[HL] - int16, EXX DE - String addres
0008++ 974A             ; o:Decimal string(5)
0009++ 974A 01 10 27    _int2str	ld	bc,10000
0010++ 974D CD 70 97    		call	delit
0011++ 9750 12          		ld	(de),a
0012++ 9751 13          		inc	de
0013++ 9752             
0014++ 9752 01 E8 03    		ld	bc,1000
0015++ 9755 CD 70 97    		call	delit
0016++ 9758 12          		ld	(de),a
0017++ 9759 13          		inc	de
0018++ 975A             
0019++ 975A             ; i:[HL] - int8, EXX DE - String addres
0020++ 975A             ; o:Decimal string(3)
0021++ 975A 01 64 00    _char2str	ld	bc,100
0022++ 975D CD 70 97    		call	delit
0023++ 9760 12          		ld	(de),a
0024++ 9761 13          		inc	de
0025++ 9762             
0026++ 9762             ; i:[HL] - int4, EXX DE - String addres
0027++ 9762             ; o:Decimal string(3)
0028++ 9762 0E 0A       _fourbit2str	ld	c,10
0029++ 9764 CD 70 97    		call	delit
0030++ 9767 12          		ld	(de),a
0031++ 9768 13          		inc	de
0032++ 9769             		
0033++ 9769 0E 01       		ld	c,1
0034++ 976B CD 70 97    		call	delit
0035++ 976E 12          		ld	(de),a
0036++ 976F C9          		ret
0037++ 9770             
0038++ 9770 3E FF       delit		ld	a,#ff
0039++ 9772 B7          		or	a
0040++ 9773 3C          dlit		inc	a
0041++ 9774 ED 42       		sbc	hl,bc
0042++ 9776 D2 73 97    		jp	nc,dlit
0043++ 9779 09          		add	hl,bc
0044++ 977A C6 30       		add	a,#30
0045++ 977C C9          		ret
0046++ 977D             
0047++ 977D             ;--------------------------------------------------------------
0048++ 977D             word2str
0049++ 977D             ;ВЫВОД 32bit ЧИСЛА:
0050++ 977D             DECZON4 ;i:[DE,HL] - int32
0051++ 977D             ;           EXX DE - String addres
0052++ 977D             ;        o:Decimal string(10)
0053++ 977D             
0054++ 9780             	LD BC,#CA00,(CLHL),BC;        1B
0054++ 9780 0100CAED43F697
0055++ 9787             	LD BC,#3B9A,(CLDE),BC
0055++ 9787 019A3BED43EC97
0056++ 978B CD E6 97    	CALL DELIT4T
0056++ 978E D9          	EXX
0056++ 978F 12           LD (DE),A
0056++ 9790 13           INC DE
0057++ 9791 D9           EXX
0058++ 9792             
0059++ 9795             	LD BC,#E100,(CLHL),BC;      100M
0059++ 9795 0100E1ED43F697
0060++ 979C             	LD BC,#05F5,(CLDE),BC
0060++ 979C 01F505ED43EC97
0061++ 97A0 CD E6 97    	CALL DELIT4T
0061++ 97A3 D9          	EXX
0061++ 97A4 12           LD (DE),A
0061++ 97A5 13           INC DE
0062++ 97A6 D9           EXX
0063++ 97A7             
0064++ 97AA             	LD BC,#9680,(CLHL),BC;       10M
0064++ 97AA 018096ED43F697
0065++ 97B1             	LD BC,#0098,(CLDE),BC
0065++ 97B1 019800ED43EC97
0066++ 97B5 CD E6 97    	CALL DELIT4T
0066++ 97B8 D9          	EXX
0066++ 97B9 12           LD (DE),A
0066++ 97BA 13           INC DE
0067++ 97BB D9           EXX
0068++ 97BC             
0069++ 97BF             	LD BC,#4240,(CLHL),BC;        1M
0069++ 97BF 014042ED43F697
0070++ 97C6             	LD BC,#000F,(CLDE),BC
0070++ 97C6 010F00ED43EC97
0071++ 97CA CD E6 97    	CALL DELIT4T
0071++ 97CD D9          	EXX
0071++ 97CE 12           LD (DE),A
0071++ 97CF 13           INC DE
0072++ 97D0 D9           EXX
0073++ 97D1             
0074++ 97D4             	LD BC,#86A0,(CLHL),BC;      100K
0074++ 97D4 01A086ED43F697
0075++ 97DB             	LD BC,#0001,(CLDE),BC
0075++ 97DB 010100ED43EC97
0076++ 97DF CD E6 97    	CALL DELIT4T
0076++ 97E2 D9          	EXX
0076++ 97E3 12           LD (DE),A
0076++ 97E4 13           INC DE
0077++ 97E5 D9           EXX
0078++ 97E6             
0079++ 97E6             ;---------------------------------------
0080++ 97E6             DELIT4T ;i:[DE,HL]/[CLDE,CLHL]
0081++ 97E6             ;        o:[DE,HL] - Remainder
0082++ 97E6             ;               BC - Count
0083++ 97E6             
0084++ 97E6 DD 21 FF FF         LD IX,0-1
0085++ 97EA B7          NAZE    OR A
0086++ 97EB 01 00 00    DLTB    LD BC,0
0087++ 97EE DD 23               INC IX
0087++ 97F0 EB                  EX DE,HL
0087++ 97F1 ED 42        SBC HL,BC
0088++ 97F3 38 18        JR C,ND
0089++ 97F5 01 00 00    DLTA    LD BC,0
0089++ 97F8 EB                  EX DE,HL
0089++ 97F9 ED 42        SBC HL,BC
0090++ 97FB 30 EE        JR NC,DLTB
0091++ 97FD 1B                  DEC DE
0091++ 97FE 7A                  LD A,D
0091++ 97FF 3C           INC A
0092++ 9800 20 E8        JR NZ,NAZE
0092++ 9802 7B                  LD A,E
0092++ 9803 3C           INC A
0093++ 9804 20 E4        JR NZ,NAZE
0094++ 9806 13                  INC DE
0095++ 9807             
0096++ 9807 09                  ADD HL,BC
0097++ 9808 EB                  EX DE,HL
0098++ 9809 ED 4B EC 97         LD BC,(CLDE)
0099++ 980D             ;-------
0100++ 980D 09          ND      ADD HL,BC
0101++ 980E EB                  EX DE,HL
0102++ 980F             
0103++ 980F DD E5       Nd      PUSH IX
0104++ 9811 C1                  POP BC
0104++ 9812 79                  LD A,C
0105++ 9813 C6 30        ADD A,#30
0106++ 9815 C9                  RET
0107++ 9816             ;---------------------------------------
0108++ 9816             CLHL    EQU DLTA+1
0109++ 9816             CLDE    EQU DLTB+1
0110++ 9816             ;---------------------------------------
0111++ 9816             
1442+  9816             		include "int2hex.asm"
0001++ 9816             ;--------------------------------------------------------------
0002++ 9816             ;		ld 	de,stringAddr  		; ascii
0003++ 9816             ;		ld 	hl,intAddr		; code
0004++ 9816             ;		call 	int2hex
0005++ 9816             
0006++ 9816 E5          int2hex		push	hl
0007++ 9817 7E          		ld 	a,(hl)			; перевод числа в текст
0008++ 9818 E5          		push 	hl
0009++ 9819 E6 F0       		and 	#f0
0010++ 981B 1F          		rra 
0011++ 981C 1F          		rra 
0012++ 981D 1F          		rra 
0013++ 981E 1F          		rra 
0014++ 981F             		
0015++ 981F 21 38 98    		ld 	hl,letters
0016++ 9822 06 00       		ld 	b,0
0017++ 9824 4F          		ld 	c,a
0018++ 9825 09          		add 	hl,bc
0019++ 9826             		
0020++ 9826 7E          		ld 	a,(hl)
0021++ 9827 12          		ld 	(de),a
0022++ 9828 13          		inc	de
0023++ 9829             		
0024++ 9829 E1          		pop 	hl
0025++ 982A 7E          		ld 	a,(hl)
0026++ 982B E6 0F       		and 	#0f
0027++ 982D             		
0028++ 982D 21 38 98    		ld 	hl,letters
0029++ 9830 06 00       		ld 	b,0
0030++ 9832 4F          		ld 	c,a
0031++ 9833 09          		add 	hl,bc
0032++ 9834             		
0033++ 9834 7E          		ld 	a,(hl)
0034++ 9835 12          		ld 	(de),a
0035++ 9836             						
0036++ 9836 E1          		pop	hl
0037++ 9837 C9          		ret
0038++ 9838             
0039++ 9838             letters	db	"0123456789ABCDEF"
0039++ 9838 30313233343536373839414243444546
1443+  9848             		include "hex2int.asm"
0001++ 9848             ;---------------------------------------
0002++ 9848             ; hex to int converter
0003++ 9848             ;---------------------------------------
0004++ 9848             ;in: hl,str addr | "0A"
0005++ 9848             ;out:a,byte      | #0a (10)
0006++ 9848             
0007++ 9848 7E          hex2int		ld	a,(hl)
0008++ 9849 CD 61 98    		call	hex2int_
0009++ 984C CB 27       		sla	a
0010++ 984E CB 27       		sla	a
0011++ 9850 CB 27       		sla	a
0012++ 9852 CB 27       		sla	a
0013++ 9854 E6 F0       		and	%11110000
0014++ 9856 4F          		ld	c,a
0015++ 9857 23          		inc	hl
0016++ 9858 7E          		ld	a,(hl)
0017++ 9859 23          		inc	hl
0018++ 985A CD 61 98    		call	hex2int_
0019++ 985D E6 0F       		and	%00001111
0020++ 985F B1          		or	c
0021++ 9860 C9          		ret
0022++ 9861             
0023++ 9861 FE 30       hex2int_	cp	"0"
0024++ 9863 38 1D       		jr	c,wrongHex
0025++ 9865 FE 3A       		cp	"9"+1
0026++ 9867 30 03       		jr	nc,hCheck_00
0027++ 9869 D6 30       		sub	#30					; 0 - 9
0028++ 986B C9          		ret
0029++ 986C             
0030++ 986C FE 41       hCheck_00	cp	"A"
0031++ 986E 38 12       		jr	c,wrongHex
0032++ 9870 FE 47       		cp	"F"+1
0033++ 9872 30 03       		jr	nc,hCheck_01
0034++ 9874 D6 37       		sub	55					; A = 10
0035++ 9876 C9          		ret
0036++ 9877             
0037++ 9877 FE 61       hCheck_01	cp	"a"
0038++ 9879 38 07       		jr	c,wrongHex
0039++ 987B FE 67       		cp	"f"+1
0040++ 987D 30 03       		jr	nc,wrongHex
0041++ 987F D6 57       		sub	87					; a = 10
0042++ 9881 C9          		ret
0043++ 9882             
0044++ 9882 AF          wrongHex	xor	a
0045++ 9883 C9          		ret
0046++ 9884             
1444+  9884             		include "mouse.asm"
0001++ 9884             ;---------------------------------------------
0002++ 9884             ; Kempstone Mouse driver
0003++ 9884             ;---------------------------------------------
0004++ 9884             mBPort		equ	#fadf			; D0: левая кнопка (0=нажата)
0005++ 9884             						; D1: правая кнопка (0=нажата)
0006++ 9884             						; D2: средняя кнопка (0=нажата)
0007++ 9884             						; D3: зарезервировано под ещё одну кнопку (0=нажата)
0008++ 9884             						; D4-D7: координата колёсика
0009++ 9884             mXPort		equ	#fbdf			; X-координата (растёт слева направо)
0010++ 9884             mYPort		equ	#ffdf			; Y-координата (растёт снизу вверх)
0011++ 9884             ;---------------------------------------
0012++ 9884 22 F9 98    _mouseInit	ld	(mouseIsRight+1),hl
0013++ 9887 ED 53 31 99 		ld	(mouseIsDown+1),de
0014++ 988B C9          		ret
0015++ 988C             ;---------------------------------------
0016++ 988C CD BA 98    _mouseUpdate	call	mouseButtons
0017++ 988F CD D5 98    		call	mouseDriver
0018++ 9892 C9          		ret
0019++ 9893             ;---------------------------------------
0020++ 9893 2A 4F 99    _getMouseX	ld	hl,(mouse_X)
0021++ 9896 C9          		ret
0022++ 9897             ;---------------------------------------
0023++ 9897 2A 51 99    _getMouseY	ld	hl,(mouse_Y)
0024++ 989A C9          		ret
0025++ 989B             ;---------------------------------------
0026++ 989B 2A 4B 99    _getMouseDeltaX	ld	hl,(mouseDeltaX)
0027++ 989E C9          		ret
0028++ 989F             ;---------------------------------------
0029++ 989F 2A 4D 99    _getMouseDeltaY	ld	hl,(mouseDeltaY)
0030++ 98A2 C9          		ret
0031++ 98A3             ;---------------------------------------
0032++ 98A3 2A 49 99    _getMouseRawX	ld	hl,(mouseRawDataX)
0033++ 98A6 26 00       		ld	h,#00
0034++ 98A8 C9          		ret
0035++ 98A9             ;---------------------------------------
0036++ 98A9 2A 49 99    _getMouseRawY	ld	hl,(mouseRawDataX)
0037++ 98AC 6C          		ld	l,h
0038++ 98AD 26 00       		ld	h,#00
0039++ 98AF C9          		ret
0040++ 98B0             ;---------------------------------------
0041++ 98B0 2A 53 99    _getMouseWheel	ld	hl,(mouse_W)
0042++ 98B3 26 00       		ld	h,#00
0043++ 98B5 C9          		ret	
0044++ 98B6             ;---------------------------------------
0045++ 98B6             _getMouseButtons
0046++ 98B6 3A 54 99    		ld	a,(mouse_B)
0047++ 98B9 C9          		ret
0048++ 98BA             ;---------------------------------------
0049++ 98BA 01 DF FA    mouseButtons	ld	bc,mBPort		; порт кнопок
0050++ 98BD ED 78       		in	a,(c)			; читаем значение		
0051++ 98BF             		
0052++ 98BF F5          		push	af
0053++ 98C0             
0054++ 98C0 E6 F0       		and	%11110000
0055++ 98C2 CB 3F       		srl	a
0056++ 98C4 CB 3F       		srl	a
0057++ 98C6 CB 3F       		srl	a
0058++ 98C8 CB 3F       		srl	a
0059++ 98CA 32 53 99    		ld	(mouse_W),a
0060++ 98CD             
0061++ 98CD F1          		pop	af
0062++ 98CE             
0063++ 98CE E6 0F       		and	%00001111
0064++ 98D0 2F          		cpl				; инвертируем значение
0065++ 98D1 32 54 99    		ld	(mouse_B),a
0066++ 98D4             		
0067++ 98D4 C9          		ret
0068++ 98D5             ;---------------------------------------
0069++ 98D5 ED 5B 49 99 mouseDriver	ld	de,(mouseRawDataX)	; последние координаты 8bit (в e=X, d=Y)
0070++ 98D9             
0071++ 98D9 26 00       mouseGetX	ld	h,#00			; изначально положительное значение
0072++ 98DB             
0073++ 98DB 01 DF FB    		ld	bc,mXPort		; порт координат X
0074++ 98DE ED 78       		in	a,(c)			; читаем значение
0075++ 98E0 32 49 99    		ld	(mouseRawDataX),a	; cохраняем Raw значение из порта X
0076++ 98E3             		
0077++ 98E3 93          		sub	e			; вычитаем последний сохранёный Raw X
0078++ 98E4 28 2A       		jr	z,mouseGetY		; если 0, перемещения не было переходим к получению данных Y	
0079++ 98E6 F2 EB 98    		jp	p,mouseGetXPlus		; если положительное значение сохраняем дельту X
0080++ 98E9 26 FF       		ld	h,#ff			; в противном случает изменяем знак с + на -
0081++ 98EB             
0082++ 98EB 6F          mouseGetXPlus	ld	l,a
0083++ 98EC 22 4B 99    		ld	(mouseDeltaX),hl
0084++ 98EF ED 4B 4F 99 		ld	bc,(mouse_X)		; предыдущие координаты X 16bit
0085++ 98F3             ;---------------
0086++ 98F3             ; Thx 4 psndcj
0087++ 98F3             ;  bc - coords
0088++ 98F3             ;  hl - delta
0089++ 98F3 7C          		ld	a,h
0090++ 98F4 09          		add	hl,bc
0091++ 98F5 17          		rla
0092++ 98F6 38 0E       		jr	c,mouseIsLeft
0093++ 98F8             
0094++ 98F8 01 68 01    mouseIsRight	ld	bc,360
0095++ 98FB A7          		and	a
0096++ 98FC ED 42       		sbc	hl,bc
0097++ 98FE 38 03       		jr	c,$+2+3
0098++ 9900 21 00 00    		ld	hl,0
0099++ 9903 09          		add	hl,bc
0100++ 9904 18 07       		jr	mouseXStore
0101++ 9906             
0102++ 9906 CB 7C       mouseIsLeft	bit	7,h
0103++ 9908 28 03       		jr	z,$+2+3
0104++ 990A 21 00 00    		ld	hl,0
0105++ 990D             ;---------------
0106++ 990D 22 4F 99    mouseXStore	ld	(mouse_X),hl		; сохраняем новые значения
0107++ 9910             
0108++ 9910             ;---------------
0109++ 9910 26 00       mouseGetY	ld	h,#00			; изначально положительное значение
0110++ 9912             
0111++ 9912 01 DF FF    		ld	bc,mYPort		; порт координат Y
0112++ 9915 ED 78       		in	a,(c)			; читаем значение
0113++ 9917 32 4A 99    		ld	(mouseRawDataY),a	; cохраняем Raw значение из порта Y
0114++ 991A             		
0115++ 991A 92          		sub	d			; вычитаем последний сохранёный Raw Y
0116++ 991B C8          		ret	z			; если 0, перемещения не было - выход
0117++ 991C             
0118++ 991C ED 44       		neg				; меняем положение Y Up<->Down
0119++ 991E             
0120++ 991E F2 23 99    		jp	p,mouseGetYPlus		; если положительное значение сохраняем дельту Y
0121++ 9921 26 FF       		ld	h,#ff			; в противном случает изменяем знак с + на -
0122++ 9923             
0123++ 9923 6F          mouseGetYPlus	ld	l,a
0124++ 9924 22 4D 99    		ld	(mouseDeltaY),hl
0125++ 9927 ED 4B 51 99 		ld	bc,(mouse_Y)		; предыдущие координаты Y 16bit
0126++ 992B             ;---------------
0127++ 992B             ; Thx 4 psndcj
0128++ 992B             ;  bc - coords
0129++ 992B             ;  hl - delta
0130++ 992B 7C          		ld	a,h
0131++ 992C 09          		add	hl,bc
0132++ 992D 17          		rla
0133++ 992E 38 0E       		jr	c,mouseIsUp
0134++ 9930             
0135++ 9930 01 20 01    mouseIsDown	ld	bc,288
0136++ 9933 A7          		and	a
0137++ 9934 ED 42       		sbc	hl,bc
0138++ 9936 38 03       		jr	c,$+2+3
0139++ 9938 21 00 00    		ld	hl,0
0140++ 993B 09          		add	hl,bc
0141++ 993C 18 07       		jr	mouseYStore
0142++ 993E             
0143++ 993E CB 7C       mouseIsUp	bit	7,h
0144++ 9940 28 03       		jr	z,$+2+3
0145++ 9942 21 00 00    		ld	hl,0
0146++ 9945             ;---------------
0147++ 9945 22 51 99    mouseYStore	ld	(mouse_Y),hl		; сохраняем новые значения
0148++ 9948 C9          		ret
0149++ 9949             ;---------------------------------------
0150++ 9949             
0151++ 9949 00          mouseRawDataX	db	#00			; cохранённое Raw значение из порта X
0152++ 994A 00          mouseRawDataY	db	#00			; cохранённое Raw значение из порта Y
0153++ 994B             
0154++ 994B 00 00       mouseDeltaX	dw	#0000			; дельта смещения X ±127 (16bit)
0155++ 994D 00 00       mouseDeltaY	dw	#0000			; дельта смещения Y ±127 (16bit)
0156++ 994F             
0157++ 994F 00 00       mouse_X		dw	#0000			; текущая координата X
0158++ 9951 00 00       mouse_Y		dw	#0000			; текущая координата Y
0159++ 9953             
0160++ 9953 00          mouse_W		db	#00			; значение колёсика
0161++ 9954 00          mouse_B		db	#00			; текущее состяние кнопок
0162++ 9955             
1445+  9955             		include "gli.asm"
0001++ 9955             ;---------------------------------------
0002++ 9955             ; GLi - Graphics Library interface
0003++ 9955             ;---------------------------------------
0004++ 9955 F5          _createSprite	push	af			
0005++ 9956 CD 08 9A    		call	setSpriteSize		; ширина / 8 px , высота /8 px
0006++ 9959             
0007++ 9959 7C          		ld	a,h			; l = (#01+1) * ~20 = 40ms на 1 кадр, h - #08 кадров анимации
0008++ 995A 32 52 9A    		ld	(sprAnim),a
0009++ 995D AF          		xor	a
0010++ 995E 32 53 9A    		ld	(sprAnimPos),a
0011++ 9961 7D          		ld	a,l
0012++ 9962 32 54 9A    		ld	(sprWait),a
0013++ 9965 32 55 9A    		ld	(sprTimeout),a
0014++ 9968             
0015++ 9968 CD 20 81    		call	updateSprite		
0016++ 996B F1          		pop	af
0017++ 996C CD DD 99    		call	setYBitMap
0018++ 996F C9          		ret
0019++ 9970             
0020++ 9970 3A 55 9A    _updateSprite	ld	a,(sprTimeout)
0021++ 9973 3D          		dec	a
0022++ 9974 FE 00       		cp	#00
0023++ 9976 20 2B       		jr	nz,updSprite_02
0024++ 9978             		
0025++ 9978 3A 52 9A    		ld	a,(sprAnim)
0026++ 997B 4F          		ld	c,a
0027++ 997C 3A 53 9A    		ld	a,(sprAnimPos)
0028++ 997F 3C          		inc	a
0029++ 9980 B9          		cp	c
0030++ 9981 20 01       		jr	nz,updSprite_00
0031++ 9983             		
0032++ 9983 AF          		xor	a
0033++ 9984 32 53 9A    updSprite_00	ld	(sprAnimPos),a
0034++ 9987             		
0035++ 9987 47          		ld	b,a
0036++ 9988 3A 59 9A    		ld	a,(sprX1)
0037++ 998B E6 0E       		and	%00001110
0038++ 998D CB 3F       		srl	a
0039++ 998F 3C          		inc	a
0040++ 9990 4F          		ld	c,a
0041++ 9991 81          updSprite_01	add	a,c
0042++ 9992 10 FD       		djnz	updSprite_01
0043++ 9994 E6 1F       		and	%00011111
0044++ 9996 4F          		ld	c,a
0045++ 9997 3A 5A 9A    		ld	a,(sprPX)
0046++ 999A E6 E0       		and	%11100000
0047++ 999C B1          		or	c
0048++ 999D 32 5A 9A    		ld	(sprPX),a
0049++ 99A0             
0050++ 99A0 3A 54 9A    		ld	a,(sprWait)
0051++ 99A3 32 55 9A    updSprite_02	ld	(sprTimeout),a
0052++ 99A6             
0053++ 99A6 01 AF 15    		ld	bc,FMAddr
0054++ 99A9 3E 10       		ld 	a,%00010000		; Разрешить приём данных (?) Bit 4 - FM_EN установлен
0055++ 99AB ED 79       		out	(c),a
0056++ 99AD             
0057++ 99AD 21 56 9A    		ld	hl,sFile
0058++ 99B0 11 00 02    		ld 	de,#0000+512		; Память с палитрой замапливается на адрес #0000
0059++ 99B3 01 06 00    		ld	bc,6
0060++ 99B6 ED B0       		ldir
0061++ 99B8             
0062++ 99B8 01 AF 15    		ld	bc,FMAddr
0063++ 99BB AF          		xor	a			; Запретить, Bit 4 - FM_EN сброшен
0064++ 99BC ED 79       		out	(c),a
0065++ 99BE C9          		ret
0066++ 99BF             
0067++ 99BF 3E 01       _enableSprites	ld	a,#01
0068++ 99C1 32 4D 9A    		ld	(showSprEnable),a
0069++ 99C4 C3 23 81    		jp	showSprites
0070++ 99C7             
0071++ 99C7 AF          _disableSprites	xor	a
0072++ 99C8 32 4D 9A    		ld	(showSprEnable),a
0073++ 99CB             			; S_EN	T1_EN	T0_EN	Z80_LP	T1Z_EN	T0Z_EN	T1YS_EN	T0YS_EN
0074++ 99CB 3E 00       _hideSprites	ld	a,%00000000		; запрещаем отображение спрайтов
0075++ 99CD 18 08       		jr	setTSConfig
0076++ 99CF             
0077++ 99CF 3A 4D 9A    _showSprites	ld	a,(showSprEnable)
0078++ 99D2 FE 00       		cp	#00
0079++ 99D4 C8          		ret	z
0080++ 99D5 3E 80       		ld	a,%10000000		; разрешаем отображение спрайтов
0081++ 99D7 01 AF 06    setTSConfig	ld	bc,TSConfig
0082++ 99DA ED 79       		out	(c),a
0083++ 99DC C9          		ret
0084++ 99DD             
0085++ 99DD F5          setYBitMap	push	af
0086++ 99DE E6 03       		and	%00000011
0087++ 99E0 CB 27       		sla	a
0088++ 99E2 CB 27       		sla	a
0089++ 99E4 CB 27       		sla	a
0090++ 99E6 CB 27       		sla	a
0091++ 99E8 CB 27       		sla	a
0092++ 99EA CB 27       		sla	a
0093++ 99EC 4F          		ld	c,a
0094++ 99ED 3A 5A 9A    		ld	a,(sprPY0)
0095++ 99F0 E6 3F       		and	%00111111
0096++ 99F2 B1          		or	c
0097++ 99F3 32 5A 9A    		ld	(sprPY0),a
0098++ 99F6 F1          		pop	af
0099++ 99F7 CB 3F       		srl	a
0100++ 99F9 CB 3F       		srl	a
0101++ 99FB E6 0F       		and	%00001111
0102++ 99FD 4F          		ld	c,a
0103++ 99FE 3A 5B 9A    		ld	a,(sprPY1)
0104++ 9A01 E6 F0       		and	%11110000
0105++ 9A03 B1          		or	c
0106++ 9A04 32 5B 9A    		ld	(sprPY1),a
0107++ 9A07 C9          		ret
0108++ 9A08             
0109++ 9A08 7B          setSpriteSize	ld	a,e			; ширина ?
0110++ 9A09 3D          		dec	a
0111++ 9A0A E6 07       		and	%00000111
0112++ 9A0C CB 27       		sla	a
0113++ 9A0E 5F          		ld	e,a
0114++ 9A0F 3A 59 9A    		ld	a,(sprX1)
0115++ 9A12 E6 F1       		and	%11110001
0116++ 9A14 B3          		or	e
0117++ 9A15 32 59 9A    		ld	(sprX1),a
0118++ 9A18             
0119++ 9A18 7A          		ld	a,d			; высота ?
0120++ 9A19 3D          		dec	a
0121++ 9A1A E6 07       		and	%00000111
0122++ 9A1C CB 27       		sla	a
0123++ 9A1E 57          		ld	d,a
0124++ 9A1F 3A 57 9A    		ld	a,(sprY1)
0125++ 9A22 E6 F1       		and	%11110001
0126++ 9A24 B2          		or	d
0127++ 9A25 32 57 9A    		ld	(sprY1),a
0128++ 9A28 C9          		ret
0129++ 9A29             
0130++ 9A29 7B          _setSpriteX	ld	a,e			; координата X
0131++ 9A2A 32 58 9A    		ld	(sprX0),a
0132++ 9A2D             
0133++ 9A2D 7A          		ld	a,d
0134++ 9A2E E6 01       		and	%00000001
0135++ 9A30 57          		ld	d,a
0136++ 9A31 3A 59 9A    		ld	a,(sprX1)
0137++ 9A34 E6 FE       		and	%11111110
0138++ 9A36 B2          		or	d
0139++ 9A37 32 59 9A    		ld	(sprX1),a
0140++ 9A3A C9          		ret
0141++ 9A3B             
0142++ 9A3B 7B          _setSpriteY	ld	a,e			; координата Y
0143++ 9A3C 32 56 9A    		ld	(sprY0),a
0144++ 9A3F             
0145++ 9A3F 7A          		ld	a,d
0146++ 9A40 E6 01       		and	%00000001
0147++ 9A42 57          		ld	d,a
0148++ 9A43 3A 57 9A    		ld	a,(sprY1)
0149++ 9A46 E6 FE       		and	%11111110
0150++ 9A48 B2          		or	d
0151++ 9A49 32 57 9A    		ld	(sprY1),a
0152++ 9A4C C9          		ret
0153++ 9A4D             
0154++ 9A4D 00          showSprEnable	db	#00
0155++ 9A4E             
0156++ 9A4E 20 20 20 00 sprType		db	"   ",#00
0157++ 9A52             
0158++ 9A52 00          sprAnim		db	#00			; количество кадров анимации
0159++ 9A53 00          sprAnimPos	db	#00			; текущий кадр 
0160++ 9A54 00          sprWait		db	#00			; сколько отображать 1 кадр * ~20ms
0161++ 9A55 00          sprTimeout	db	#00			; сколько осталось до смены кадра
0162++ 9A56             
0163++ 9A56             sFile		;	структура SFILE
0164++ 9A56 00          sprY0		db	#00			; Y0-7     | 8 bit младшие даные Y координаты (0-255px)
0165++ 9A57             			;FLAR S Y8
0166++ 9A57 26          sprY1		db	%00100110		; Y8       | 0й бит - старшие данные Y координаты (256px >)
0167++ 9A58             						; YS       | 1,2,3 бит - высота в блоках по 8 px
0168++ 9A58             						; RESERVED | 4й бит - зарезервирован
0169++ 9A58             						; ACT      | 5й бит - спрайт активен (показывается)
0170++ 9A58             						; LEAP     | 6й бит - указывает, что данный спрайт последний в текущем слое.
0171++ 9A58             						; YF       | 7й бит - указывает, что данный спрайт нужно отобразить зеркально по вертикали
0172++ 9A58             		
0173++ 9A58 00          sprX0		db	#00			; X0-7     | 8 bit младшие даные X координаты (0-255px)
0174++ 9A59             			;F  R S X8
0175++ 9A59 06          sprX1		db	%00000110		; X8       | 0й бит - старшие данные X координаты (256px >)
0176++ 9A5A             						; XS       | 1,2,3 бит - ширина в блоках по 8 px
0177++ 9A5A             						; RESERVED | 4й бит - зарезервирован
0178++ 9A5A             						; -        | 5,6й бит - не используются
0179++ 9A5A             						; XF       | 7й бит - указывает, что данный спрайт нужно отобразить зеркально по горизонтали
0180++ 9A5A             sprPX			;TNUM
0181++ 9A5A 00          sprPY0		db	%00000000		; TNUM	   | Номер тайла для левого верхнего угла.
0182++ 9A5B             						;          | 0,1,2,3,4,5й бит - Х координата в битмап
0183++ 9A5B             			;SPALTNUM		;          | 6,7й бит +
0184++ 9A5B F0          sprPY1		db	%11110000		; TNUM     | 0,1,2,3 бит - Y координата в битмап
0185++ 9A5C             						; SPAL     | 4,5,6,7й биты номер палитры (?)
1446+  9A5C             ;---------------------------------------
1447+  9A5C             		include "messages.asm"
0001++ 9A5C             ;---------------------------------------
0002++ 9A5C             ; CLi System messages
0003++ 9A5C             ;---------------------------------------
0004++ 9A5C             ;                                     ,
0005++ 9A5C             ;              ,.        _,---._ __  / \
0006++ 9A5C             ;             /  )    .-'       `./ /   \
0007++ 9A5C             ;            (  (   ,'            `/    /|
0008++ 9A5C             ;             \  `-"             \'\   / |
0009++ 9A5C             ;              `.              ,  \ \ /  |
0010++ 9A5C             ;               /`.          ,'-`----Y   |
0011++ 9A5C             ;              (            ;        |   '
0012++ 9A5C             ;              |  ,-.    ,-'         |  /
0013++ 9A5C             ;              |  | (   |        hjw | /
0014++ 9A5C             ;              )  |  \  `.___________|/
0015++ 9A5C             ;              `--'   `--'
0016++ 9A5C             
0017++ 9A5C             versionMsg	db	16,6,"Command Line Interface for WildCommander v0.14",#0d
0017++ 9A5C 1006436F6D6D616E64204C696E6520496E7465726661636520666F722057696C
0017++ 9A7C 64436F6D6D616E6465722076302E31340D
0018++ 9A8D             		db	16,7,"2012,2013 ",127," Breeze\\\\Fishbone Crew",#0d
0018++ 9A8D 1007323031322C32303133207F20427265657A655C5C46697368626F6E652043
0018++ 9AAD 7265770D
0019++ 9AB1 00          		db	#00
0020++ 9AB2             
0021++ 9AB2 0D          typeHelpMsg	db	#0d
0022++ 9AB3             		db	16,colorInfo,"Type ",20," help ",20," to display the full list of commands.",#0d,#0d
0022++ 9AB3 100D5479706520142068656C70201420746F20646973706C6179207468652066
0022++ 9AD3 756C6C206C697374206F6620636F6D6D616E64732E0D0D
0023++ 9AEA 10 10       		db	16,16
0024++ 9AEC 00          		db	#00
0025++ 9AED             
0026++ 9AED 31 3E       readyMsg	db	"1>"
0027++ 9AEF 00          		db	#00
0028++ 9AF0             
0029++ 9AF0             errorMsg	db	16,colorError,"Error! Unknown command.",#0d
0029++ 9AF0 100A4572726F722120556E6B6E6F776E20636F6D6D616E642E0D
0030++ 9B0A 10 10       		db	16,16
0031++ 9B0C 00          		db	#00
0032++ 9B0D             
0033++ 9B0D             errorParMsg	db	16,colorError,"Error! Wrong parameters.",#0d
0033++ 9B0D 100A4572726F72212057726F6E6720706172616D65746572732E0D
0034++ 9B28 10 10       		db	16,16
0035++ 9B2A 00          		db	#00
0036++ 9B2B             
0037++ 9B2B             anyKeyMsg	db	16,7,"Press any key to continue.",#0d
0037++ 9B2B 1007507265737320616E79206B657920746F20636F6E74696E75652E0D
0038++ 9B48 10 10       		db	16,16
0039++ 9B4A 00          		db	#00
0040++ 9B4B             
0041++ 9B4B 10 10 11 10 restoreMsg	db	16,16,17,16
0042++ 9B4F 0D 00       		db	#0d,#00
0043++ 9B51             
0044++ 9B51             wrongDevMsg	db	16,colorError,"Error! Wrong device ID.",#0d
0044++ 9B51 100A4572726F72212057726F6E67206465766963652049442E0D
0045++ 9B6B 10 10       		db	16,16
0046++ 9B6D 00          		db	#00
0047++ 9B6E             
0048++ 9B6E             dirNotFoundMsg	db	16,colorError,"Error! Directory not found.",#0d
0048++ 9B6E 100A4572726F7221204469726563746F7279206E6F7420666F756E642E0D
0049++ 9B8C 10 10       		db	16,16
0050++ 9B8E 00          		db	#00
0051++ 9B8F             
0052++ 9B8F             fileNotFoundMsg	db	16,colorError,"Error! File not found.",#0d
0052++ 9B8F 100A4572726F72212046696C65206E6F7420666F756E642E0D
0053++ 9BA8 10 10       		db	16,16
0054++ 9BAA 00          		db	#00
0055++ 9BAB             
0056++ 9BAB             cantReadDirMsg	db	16,colorError,"Error! Can't read directory.",#0d
0056++ 9BAB 100A4572726F72212043616E27742072656164206469726563746F72792E0D
0057++ 9BCA 10 10       		db	16,16
0058++ 9BCC 00          		db	#00
0059++ 9BCD             
0060++ 9BCD             helpMsg		db	16,colorOk,"Available commands(embedded):",16,16
0060++ 9BCD 100C417661696C61626C6520636F6D6D616E647328656D626564646564293A10
0060++ 9BED 10
0061++ 9BEE 10 10       		db	16,16
0062++ 9BF0 0D 00       		db	#0d,#00
0063++ 9BF2             
0064++ 9BF2             helpMsg2	db	#0d,16,colorOk,"Available commands(external):",16,16
0064++ 9BF2 0D100C417661696C61626C6520636F6D6D616E64732865787465726E616C293A
0064++ 9C12 1010
0065++ 9C14 10 10       		db	16,16
0066++ 9C16 0D 00       		db	#0d,#00
0067++ 9C18             
0068++ 9C18             wrongPathMsg	db	16,colorError,"Error! Wrong path.",#0d
0068++ 9C18 100A4572726F72212057726F6E6720706174682E0D
0069++ 9C2D 10 10       		db	16,16
0070++ 9C2F 00          		db	#00
0071++ 9C30             
0072++ 9C30             wrongQuote	db	16,colorError,"Error! Unmatched \".",#0d
0072++ 9C30 100A4572726F722120556E6D61746368656420222E0D
0073++ 9C46 10 10       		db	16,16
0074++ 9C48 00          		db	#00
0075++ 9C49             
0076++ 9C49             wrongAppMsg	db	16,colorError,"Error! Wrong application file format.",#0d
0076++ 9C49 100A4572726F72212057726F6E67206170706C69636174696F6E2066696C6520
0076++ 9C69 666F726D61742E0D
0077++ 9C71 10 10       		db	16,16
0078++ 9C73 00          		db	#00
0079++ 9C74             
0080++ 9C74             wrongPalMsg	db	16,colorError,"Error! Wrong palette file format.",#0d
0080++ 9C74 100A4572726F72212057726F6E672070616C657474652066696C6520666F726D
0080++ 9C94 61742E0D
0081++ 9C98 10 10       		db	16,16
0082++ 9C9A 00          		db	#00
0083++ 9C9B             
0084++ 9C9B             wrongFileSizeMsg
0085++ 9C9B             		db	16,colorError,"Error! Wrong file size.",#0d
0085++ 9C9B 100A4572726F72212057726F6E672066696C652073697A652E0D
0086++ 9CB5 10 10       		db	16,16
0087++ 9CB7 00          		db	#00
0088++ 9CB8             
0089++ 9CB8             unknownParamsMsg
0090++ 9CB8             		db	16,colorError,"Error! Unknown parameter ",#00
0090++ 9CB8 100A4572726F722120556E6B6E6F776E20706172616D657465722000
0091++ 9CD4             
0092++ 9CD4             clearingMsg	db	16,colorInfo,"Clearing...",#0d
0092++ 9CD4 100D436C656172696E672E2E2E0D
0093++ 9CE2 10 10       		db	16,16
0094++ 9CE4 00          		db	#00
0095++ 9CE5             
0096++ 9CE5             initMsg	db	16,colorInfo,"Initializing...",#09
0096++ 9CE5 100D496E697469616C697A696E672E2E2E09
0097++ 9CF7 10 10       		db	16,16
0098++ 9CF9 00          		db	#00
0099++ 9CFA             
0100++ 9CFA             loadingMsg	db	16,colorInfo,"Loading...",#09,#00
0100++ 9CFA 100D4C6F6164696E672E2E2E0900
0101++ 9D08             
0102++ 9D08 0C 7C 00    waitStep_01	db	#0c,"|",#00
0103++ 9D0B 0C 2F 00    waitStep_02	db	#0c,"/",#00
0104++ 9D0E 0C 2D 00    waitStep_03	db	#0c,"-",#00
0105++ 9D11 0C 5C 5C 00 waitStep_04	db	#0c,"\\\\",#00
0106++ 9D15 0C 20 00    waitEnd		db	#0c," ",#00
0107++ 9D18             
0108++ 9D18 10 0F       brokenMsg	db	16,15
0109++ 9D1A 0D          		ds	6,#0d
0110++ 9D20             		include	"brokenLogo.asm"
0001+++9D20             ;---------------------------------------
0002+++9D20             ; Warning! Codepage CP866
0003+++9D20             ;---------------------------------------
0004+++9D20             
0005+++9D20             	db	#09,#09,#09,#09,"          ",#0d
0005+++9D20 090909092020DC20DC202020202020DC20DC0D
0006+++9D33             	db	#09,#09,#09,#09,"        ",#0d
0006+++9D33 090909092020DCDFDC202020202020DCDFDC0D
0007+++9D46 0D                  db	#0d
0008+++9D47 0D                  db	#0d
0009+++9D48             	db	#09,#09,#09,#09,"  ",#0d
0009+++9D48 090909092020DCDFDFDFDFDFDBDFDFDBDFDC0D
0010+++9D5B             	db	#09,#09,#09,#09,"        ",#0d
0010+++9D5B 090909092020202020202020DFDCDCDF0D
0011+++9D6C 0D          	db	#0d
0012+++9D6D 10 0A       	db	16,colorError
0013+++9D6F             	db	#09,#09,#09,"     ",#0d
0013+++9D6F 0909092020202020DCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDC0D
0014+++9D8E             	db	#09,#09,#09,"     ",17,15,20,"  SYSTEM IS BROKEN  ",20,17,11,"",#0d
0014+++9D8E 0909092020202020DB110F14202053595354454D2049532042524F4B454E2020
0014+++9DAE 14110BDB0D
0015+++9DB3             	db    	#09,#09,#09,"     ",#0d
0015+++9DB3 0909092020202020DFDFDFDFDFDFDFDFDFDFDFDFDFDFDFDFDFDFDFDFDFDF0D
0016+++9DD2             
0111++ 9DD2 0D          		db	#0d
0112++ 9DD3             		db	16,6,#09,"       CLi couldn't find the following system directories:",#0d
0112++ 9DD3 10060920202020202020434C6920636F756C646E27742066696E642074686520
0112++ 9DF3 666F6C6C6F77696E672073797374656D206469726563746F726965733A0D
0113++ 9E11             		db	16,colorWarning,#09,#09,"       bin, fonts, libs, locale or system!",#0d,#0d,#0d
0113++ 9E11 100E09092020202020202062696E2C20666F6E74732C206C6962732C206C6F63
0113++ 9E31 616C65206F722073797374656D210D0D0D
0114++ 9E42             		db	16,2,#09,#09,"     Get fresh copy at http://bit.ly/Cli4WC",#0d,#0d,#0d
0114++ 9E42 10020909202020202047657420667265736820636F707920617420687474703A
0114++ 9E62 2F2F6269742E6C792F436C693457430D0D0D
0115++ 9E74             		db	16,15,#09,#09,#09,"    Press ",20," any key ",20," to exit.",#0d
0115++ 9E74 100F090909202020205072657373201420616E79206B6579201420746F206578
0115++ 9E94 69742E0D
0116++ 9E98 00          		db	#00
0117++ 9E99             
0118++ 9E99             statusOkMsg	db	16,16,"[ ",16,colorOk,"  OK  ",16,16," ]",#0d,#00
0118++ 9E99 10105B20100C20204F4B20201010205D0D00
0119++ 9EAB             statusErrorMsg	db	16,16,"[ ",16,colorError,"ERROR!",16,16," ]",#0d,#00
0119++ 9EAB 10105B20100A4552524F52211010205D0D00
0120++ 9EBD             
1448+  9EBD             		include "commands.asm"
0001++ 9EBD             ;---------------------------------------------
0002++ 9EBD             ; Command's table below with all jump vectors
0003++ 9EBD             ;---------------------------------------------
0004++ 9EBD             cmdTable
0005++ 9EBD             ;--- A ---
0006++ 9EBD             
0007++ 9EBD             ;--- B ---
0008++ 9EBD             
0009++ 9EBD             ;--- C ---
0010++ 9EBD 63 64       	db	"cd"
0011++ 9EBF 2A          	db	"*"
0012++ 9EC0 85 92       	dw	changeDir
0013++ 9EC2             
0014++ 9EC2 63 6C 73    	db	"cls"
0015++ 9EC5 2A          	db	"*"
0016++ 9EC6 54 86       	dw	clearScreen
0017++ 9EC8             ;--- D ---
0018++ 9EC8 64 69 72    	db	"dir"
0019++ 9ECB 2A          	db	"*"
0020++ 9ECC 40 91       	dw	listDir
0021++ 9ECE             ;--- E ---
0022++ 9ECE 65 63 68 6F 	db	"echo"
0023++ 9ED2 2A          	db	"*"
0024++ 9ED3 59 86       	dw	echoString
0025++ 9ED5             
0026++ 9ED5 65 78 65 63 	db	"exec"
0027++ 9ED9 2A          	db	"*"
0028++ 9EDA 24 94       	dw	executeApp
0029++ 9EDC             
0030++ 9EDC 65 78 69 74 	db	"exit"
0031++ 9EE0 2A          	db	"*"
0032++ 9EE1 4E 86       	dw	closeCli
0033++ 9EE3             ;--- F ---
0034++ 9EE3             
0035++ 9EE3             ;--- G ---
0036++ 9EE3             	db	"gfxborder"
0036++ 9EE3 676678626F72646572
0037++ 9EEC 2A          	db	"*"
0038++ 9EED E7 89       	dw	gfxBorder
0039++ 9EEF             
0040++ 9EEF             	db	"gfxcls"
0040++ 9EEF 676678636C73
0041++ 9EF5 2A          	db	"*"
0042++ 9EF6 DA 83       	dw	gfxCls
0043++ 9EF8             
0044++ 9EF8             	db	"gfxloadpal"
0044++ 9EF8 6766786C6F616470616C
0045++ 9F02 2A          	db	"*"
0046++ 9F03 A4 94       	dw	loadGfxPal
0047++ 9F05             
0048++ 9F05             ;--- H ---
0049++ 9F05 68 65 6C 70 	db	"help"
0050++ 9F09 2A          	db	"*"
0051++ 9F0A 14 87       	dw	showHelp
0052++ 9F0C             ;--- I ---
0053++ 9F0C             
0054++ 9F0C             ;--- J ---
0055++ 9F0C             
0056++ 9F0C             ;--- K ---
0057++ 9F0C             
0058++ 9F0C             ;--- L ---
0059++ 9F0C             	db	"loadfnt"
0059++ 9F0C 6C6F6164666E74
0060++ 9F13 2A          	db	"*"
0061++ 9F14 D6 95       	dw	loadTxtFnt
0062++ 9F16             
0063++ 9F16             	db	"loadpal"
0063++ 9F16 6C6F616470616C
0064++ 9F1D 2A          	db	"*"
0065++ 9F1E BD 94       	dw	loadTxtPal
0066++ 9F20             
0067++ 9F20 6C 73       	db	"ls"
0068++ 9F22 2A          	db	"*"
0069++ 9F23 40 91       	dw	listDir
0070++ 9F25             
0071++ 9F25             ;	db	"loadmod"
0072++ 9F25             ;	db	"*"
0073++ 9F25             ;	dw	modLoad
0074++ 9F25             ;--- M ---
0075++ 9F25             ;	db	"modload"
0076++ 9F25             ;	db	"*"
0077++ 9F25             ;	dw	modLoad
0078++ 9F25             
0079++ 9F25             ;	db	"modplay"
0080++ 9F25             ;	db	"*"
0081++ 9F25             ;	dw	playModule
0082++ 9F25             
0083++ 9F25             ;	db	"modstop"
0084++ 9F25             ;	db	"*"
0085++ 9F25             ;	dw	stopModule
0086++ 9F25             
0087++ 9F25             ;--- N ---
0088++ 9F25             	;db	"gsreset"
0089++ 9F25             	;db	"*"
0090++ 9F25             	;dw	resetGS
0091++ 9F25             ;--- O ---
0092++ 9F25             
0093++ 9F25             ;--- P ---
0094++ 9F25 70 77 64    	db	"pwd"
0095++ 9F28 2A          	db	"*"
0096++ 9F29 F1 87       	dw	pathWorkDir
0097++ 9F2B             ;--- Q ---
0098++ 9F2B             
0099++ 9F2B             ;--- R ---
0100++ 9F2B             	db	"rehash"
0100++ 9F2B 726568617368
0101++ 9F31 2A          	db	"*"
0102++ 9F32 6B 88       	dw	scopeBinary
0103++ 9F34             ;--- S ---
0104++ 9F34             	db	"screen"
0104++ 9F34 73637265656E
0105++ 9F3A 2A          	db	"*"
0106++ 9F3B CF 89       	dw	switchScreen
0107++ 9F3D             
0108++ 9F3D 73 68       	db	"sh"
0109++ 9F3F 2A          	db	"*"
0110++ 9F40 72 93       	dw	shellExecute
0111++ 9F42             
0112++ 9F42 736C656570  	db	"sleep"
0113++ 9F47 2A          	db	"*"
0114++ 9F48 0B 91       	dw	sleepSeconds
0115++ 9F4A             ;--- T ---
0116++ 9F4A             ;	db	"test"
0117++ 9F4A             ;	db	"*"
0118++ 9F4A             ;	dw	testCmd
0119++ 9F4A             ;--- U ---
0120++ 9F4A             
0121++ 9F4A             ;--- V ---
0122++ 9F4A             
0123++ 9F4A             ;--- W ---
0124++ 9F4A             
0125++ 9F4A             ;--- X ---
0126++ 9F4A             
0127++ 9F4A             ;--- Y ---
0128++ 9F4A             
0129++ 9F4A             ;--- Z ---
0130++ 9F4A             
0131++ 9F4A             ;--- table end marker ---
0132++ 9F4A 00          	db	#00
0133++ 9F4B             
1449+  9F4B             
1450+  9F4B             		include "binData.asm"
0001++ 9F4B             ;---------------------------------------------
0002++ 9F4B             ; Binary Data
0003++ 9F4B             ;---------------------------------------------
0004++ 9F4B 2F 00       rootPath	db	"/",#00
0005++ 9F4D 2F62696E00  binPath		db	"/bin",#00
0006++ 9F52             fontsPath	db	"/fonts",#00
0006++ 9F52 2F666F6E747300
0007++ 9F59             libsPath	db	"/libs",#00
0007++ 9F59 2F6C69627300
0008++ 9F5F             localePath	db	"/locale",#00
0008++ 9F5F 2F6C6F63616C6500
0009++ 9F67             systemPath	db	"/system",#00
0009++ 9F67 2F73797374656D00
0010++ 9F6F             
0011++ 9F6F 2F62696E2F  cdBinPath	db	"/bin/"
0012++ 9F74 2020202020  cibPath		db	"     "
0013++ 9F79 00          cibFile		ds	8,0
0014++ 9F81 00          		db	#00
0015++ 9F82             
0016++ 9F82 00          progressWPos	db	#00
0017++ 9F83             progressWData	dw	waitStep_01,waitStep_02,waitStep_03,waitStep_04
0017++ 9F83 089D0B9D0E9D119D
0018++ 9F8B 00 00       		dw	#0000
0019++ 9F8D             
0020++ 9F8D             tabSize		equ	#08				; tab size
0021++ 9F8D 0008101820  tabTable	db	tabSize*0, tabSize*1, tabSize*2, tabSize*3, tabSize*4
0022++ 9F92 2830384048  		db	tabSize*5, tabSize*6, tabSize*7, tabSize*8, tabSize*9
0023++ 9F97             
0024++ 9F97 20 20 00    codeBuff	db	"  ",#00
0025++ 9F9A             fileLength
0026++ 9F9A 00 00 00 00 		dw	#0000,#0000
0027++ 9F9E 00          storeKey	db	#00
0028++ 9F9F             
0029++ 9F9F             
0030++ 9F9F 00          iBufferPos	db	#00
0031++ 9FA0 00          iBuffer		ds	iBufferSize,#00
0032++ A09F             
0033++ A09F 5F          curColor	db	defaultCol			; paper | ink
0034++ A0A0             ;curEColor	db	defaultCol			; paper | ink
0035++ A0A0             
0036++ A0A0 00          curGfxBorder	db	#00				; graphics mode border color
0037++ A0A1             
0038++ A0A1             zxPal		dw	#0000,#0010,#4000,#4010
0038++ A0A1 0000100000401040
0039++ A0A9             		dw	#0200,#0210,#4200,#4210
0039++ A0A9 0002100200421042
0040++ A0B1             		dw	#0000,#0018,#6000,#6018
0040++ A0B1 0000180000601860
0041++ A0B9             		dw	#0300,#0318,#6300,#6318
0041++ A0B9 0003180300631863
0042++ A0C1             		
0043++ A0C1             		;         rR   gG   bB
0044++ A0C1             		;         RRrrrGGgggBBbbb
0045++ A0C1 00 00       cliPal		dw	%0000000000000000		; 0.black
0046++ A0C3 10 00       		dw	%0000000000010000		; 1.navy 
0047++ A0C5             ;		dw	%0100000000000000		; 2.maroon
0048++ A0C5 10 61       		dw	%0110000100010000		; 2.amiga pink
0049++ A0C7             ;		dw	%0100000000010000		; 3.purple
0050++ A0C7 18 62       		dw	%0110001000011000		; 3.light violet
0051++ A0C9 00 02       		dw	%0000001000000000		; 4.green
0052++ A0CB             ;		dw	%0000001000010000		; 5.teal
0053++ A0CB 10 01       		dw	%0000000100010000		; 5.dark teal
0054++ A0CD             ;		dw	%0100001000000000		; 6.olive
0055++ A0CD 00 61       		dw	%0110000100000000		; 6.orange
0056++ A0CF 10 62       		dw	%0110001000010000		; 7.light beige
0057++ A0D1             		;         rR   gG   bB
0058++ A0D1             		;         RRrrrGGgggBBbbb
0059++ A0D1             ;		dw	%0010000100001000		; 8.gray
0060++ A0D1 10 42       		dw	%0100001000010000		; 8.silver
0061++ A0D3 18 00       		dw	%0000000000011000		; 9.blue
0062++ A0D5 00 60       		dw	%0110000000000000		;10.red
0063++ A0D7             		;dw	%0100000000010000		;11.fuchsia
0064++ A0D7 08 61       		dw	%0110000100001000		;11.dark pink
0065++ A0D9 00 03       		dw	%0000001100000000		;12.lime
0066++ A0DB             ;		dw	%0000001100011000		;13.aqua
0067++ A0DB 18 02       		dw	%0000001000011000		;13.teal
0068++ A0DD             		;dw	%0110001100000000		;14.yellow
0069++ A0DD 10 63       		dw	%0110001100010000		;14.light yellow
0070++ A0DF 18 63       		dw	%0110001100011000		;15.white
0071++ A0E1             
0072++ A0E1             nameEmpty	db	"             "
0072++ A0E1 20202020202020202020202020
0073++ A0EE             
0074++ A0EE             fileOneLine	db	16,15,"             "
0074++ A0EE 100F20202020202020202020202020
0075++ A0FD             		db	16,15,"             "
0075++ A0FD 100F20202020202020202020202020
0076++ A10C             		db	16,15,"             "
0076++ A10C 100F20202020202020202020202020
0077++ A11B             		db	16,15,"             "
0077++ A11B 100F20202020202020202020202020
0078++ A12A             		db	16,15,"             "
0078++ A12A 100F20202020202020202020202020
0079++ A139             		db	16,15,"             "
0079++ A139 100F20202020202020202020202020
0080++ A148 0D 00       		db	#0d,#00				; end
0081++ A14A             
0082++ A14A             helpOneLine	db	"             "
0082++ A14A 20202020202020202020202020
0083++ A157             		db	"             "
0083++ A157 20202020202020202020202020
0084++ A164             		db	"             "
0084++ A164 20202020202020202020202020
0085++ A171             		db	"             "
0085++ A171 20202020202020202020202020
0086++ A17E             		db	"             "
0086++ A17E 20202020202020202020202020
0087++ A18B             		db	"             "
0087++ A18B 20202020202020202020202020
0088++ A198 0D 00       		db	#0d,#00				; end
0089++ A19A             
0090++ A19A 00          entrySearch	ds	255,#00
0091++ A299             
0092++ A299 10 2E 00    rootSearch	db	flagDir,".",#00
0093++ A29C             
0094++ A29C 00          curAnimPos	db	#00
0095++ A29D 0E 0F       curAnim		db	14,15				; timeout,color
0096++ A29F 05 08       		db	5,8				; timeout,color
0097++ A2A1 07 05       		db	7,5				; timeout,color
0098++ A2A3 05 08       		db	5,8				; timeout,color
0099++ A2A5 00          		db	#00
0100++ A2A6             
0101++ A2A6 00          hCount		db	#00
0102++ A2A7 00          historyPos	db	#00
0103++ A2A8             cliHistory	DUP	historySize
0104++ A2A8 00          >		ds	iBufferSize, #00
0104++ A3A7 00          >		ds	iBufferSize, #00
0104++ A4A6 00          >		ds	iBufferSize, #00
0104++ A5A5 00          >		ds	iBufferSize, #00
0104++ A6A4 00          >		ds	iBufferSize, #00
0104++ A7A3 00          >		ds	iBufferSize, #00
0104++ A8A2 00          >		ds	iBufferSize, #00
0104++ A9A1 00          >		ds	iBufferSize, #00
0104++ AAA0 00          >		ds	iBufferSize, #00
0104++ AB9F 00          >		ds	iBufferSize, #00
0106++ AC9E             
0107++ AC9E 00 00       pathStrPos	dw	#0000
0108++ ACA0 00          pathString	ds	pathStrSize,#00
0109++ B09C 00          		db	#00
0110++ B09D             
0111++ B09D 00          pathBString	ds	pathStrSize,#00
0112++ B499 00          		db	#00
0113++ B49A             
0114++ B49A 00          pathCString	ds	pathStrSize,#00
0115++ B896 00          		db	#00
0116++ B897             
0117++ B897 00          pathHomeString	ds	pathStrSize,#00
0118++ BC93 00          		db	#00
0119++ BC94             
0120++ BC94 00          echoBuffer	ds	eBufferSize, #00
0121++ BD93             
0122++ BD93 00          entry		ds	32
0123++ BDB3 53 48 20    extSh		db	"SH "
0124++ BDB6 20 20 20    extSpace	db	"   "
0125++ BDB9             
0126++ BDB9 82          currentVMode	db	%10000010			; включение видео режима (разрешение+тип)
0127++ BDBA             							; i:A' - видео режим
0128++ BDBA             							;   [7-6]: %00 - 256x192
0129++ BDBA             							;          %01 - 320x200
0130++ BDBA             							;          %10 - 320x240
0131++ BDBA             							;          %11 - 360x288
0132++ BDBA             							;   [5-2]: %0000
0133++ BDBA             							;   [1-0]: %00 - ZX
0134++ BDBA             							;          %01 - 16c
0135++ BDBA             							;          %10 - 256c
0136++ BDBA             							;          %11 - txt
0137++ BDBA             
1451+  BDBA             
1452+  BDBA 00 00       storeIx		dw	#0000
1453+  BDBC             pluginEnd
1454+  BDBC             ;---------------------------------------
1455+  BDBC             	ENT
1456+  9FBC 00          endCode		nop
1457+  9FBD             
0067   9FBD             
0068   9FBD             		;include "helloworld.asm"
0069   9FBD             		;include "test1.asm"
0070   9FBD             		;include "boing.asm"
0071   9FBD             		;include "test2.asm"
0072   9FBD             		;include "test3.asm"
0073   9FBD             		;include "test4.asm"
0074   9FBD             		;include "type.asm"
0075   9FBD             		;include "loadMod.asm"
0076   9FBD             		include "miceTest.asm"
0001+  9FBD             ;-------------------------------------------------
0002+  9FBD             ; micetest - application for test kempstone mouse
0003+  9FBD             ;-------------------------------------------------
0004+  9FBD             
0005+  9FBD             		org	#c000-4
0006+  BFFC             
0007+  BFFC             miceTestStart
0008+  BFFC 7F 43 4C 41 		db	#7f,"CLA"		; Command Line Application
0009+  C000             
0010+  C000 21 72 C1    		ld	hl,miceInfoMsg
0011+  C003 CD 60 80    		call	printString
0012+  C006             
0013+  C006 CD 66 80    		call	clearGfxScreen
0014+  C009             
0015+  C009 21 B1 C1    		ld	hl,miceRunMsg
0016+  C00C CD 60 80    		call	printString
0017+  C00F             
0018+  C00F 76          		halt
0019+  C010 CD 72 80    		call	printWW			; печать
0020+  C013             
0021+  C013 CD 18 C1    		call	prepareCursor
0022+  C016             
0023+  C016 21 3F 01    		ld	hl,319			; txt-mode
0024+  C019 11 EF 00    		ld	de,239
0025+  C01C CD 53 81    		call	mouseInit
0026+  C01F             
0027+  C01F 76          miceLoop	halt
0028+  C020             
0029+  C020 CD 52 C1    		call	updateCursor
0030+  C023 CD 56 81    		call	mouseUpdate
0031+  C026 CD 72 80    		call	printWW
0032+  C029             
0033+  C029 CD 59 81    		call	getMouseX
0034+  C02C 7D          		ld	a,l
0035+  C02D 32 6D C2    		ld	(cursorSFileX),a
0036+  C030 7C          		ld	a,h
0037+  C031 E6 01       		and	%00000001
0038+  C033 F6 22       		or	%00100010
0039+  C035 32 6E C2    		ld	(cursorSFileX+1),a
0040+  C038             
0041+  C038 CD 5C 81    		call	getMouseY
0042+  C03B 7D          		ld	a,l
0043+  C03C 32 6B C2    		ld	(cursorSFile),a
0044+  C03F 7C          		ld	a,h
0045+  C040 E6 01       		and	%00000001
0046+  C042 F6 22       		or	%00100010
0047+  C044 32 6C C2    		ld	(cursorSFile+1),a
0048+  C047             
0049+  C047 2A 69 C2    		ld	hl,(timeCount)
0050+  C04A 23          		inc	hl
0051+  C04B 22 69 C2    		ld	(timeCount),hl
0052+  C04E 11 63 C2    		ld	de,timeCountMsg
0053+  C051 CD 78 80    		call	int2str
0054+  C054             
0055+  C054 CD 1E 80    		call	checkKeyEsc
0056+  C057 C2 00 C1    		jp	nz,miceStop		
0057+  C05A             ;---------------
0058+  C05A 06 2B       		ld	b,"+"
0059+  C05C 0E 2D       		ld	c,"-"
0060+  C05E CD 5F 81    		call	getMouseDeltaX
0061+  C061 CB 7C       		bit	7,h
0062+  C063 78          		ld	a,b
0063+  C064 32 FA C1    		ld	(rawXMsg-1),a
0064+  C067 28 0C       		jr	z,micePlusXSkip
0065+  C069 79          		ld	a,c
0066+  C06A             
0067+  C06A 32 FA C1    		ld	(rawXMsg-1),a
0068+  C06D 26 00       		ld	h,#00
0069+  C06F 3E FF       		ld	a,255
0070+  C071 95          		sub	l
0071+  C072 E6 7F       		and	%01111111
0072+  C074 6F          		ld	l,a
0073+  C075             
0074+  C075 11 FB C1    micePlusXSkip	ld	de,rawXMsg
0075+  C078 CD 7B 80    		call	char2str
0076+  C07B             ;---------------
0077+  C07B CD 65 81    		call	getMouseRawX
0078+  C07E 11 FF C1    		ld	de,rawXMsg+4
0079+  C081 CD 7B 80    		call	char2str
0080+  C084             ;---------------
0081+  C084 06 2B       		ld	b,"+"
0082+  C086 0E 2D       		ld	c,"-"
0083+  C088 CD 62 81    		call	getMouseDeltaY
0084+  C08B CB 7C       		bit	7,h
0085+  C08D 78          		ld	a,b
0086+  C08E 32 0D C2    		ld	(rawYMsg-1),a
0087+  C091 28 0C       		jr	z,micePlusYSkip
0088+  C093 79          		ld	a,c
0089+  C094             
0090+  C094 32 0D C2    		ld	(rawYMsg-1),a
0091+  C097 26 00       		ld	h,#00
0092+  C099 3E FF       		ld	a,255
0093+  C09B 95          		sub	l
0094+  C09C E6 7F       		and	%01111111
0095+  C09E 6F          		ld	l,a
0096+  C09F             
0097+  C09F 11 0E C2    micePlusYSkip	ld	de,rawYMsg
0098+  C0A2 CD 7B 80    		call	char2str
0099+  C0A5             ;---------------
0100+  C0A5 CD 68 81    		call	getMouseRawY
0101+  C0A8 11 12 C2    		ld	de,rawYMsg+4
0102+  C0AB CD 7B 80    		call	char2str
0103+  C0AE             ;---------------
0104+  C0AE CD 59 81    		call	getMouseX
0105+  C0B1 11 44 C2    		ld	de,posXMsg
0106+  C0B4 CD 78 80    		call	int2str
0107+  C0B7             ;---------------		
0108+  C0B7 CD 5C 81    		call	getMouseY
0109+  C0BA 11 53 C2    		ld	de,posYMsg
0110+  C0BD CD 78 80    		call	int2str
0111+  C0C0             ;---------------
0112+  C0C0 CD 6B 81    		call	getMouseWheel
0113+  C0C3 11 24 C2    		ld	de,posWheelMsg
0114+  C0C6 CD 7E 80    		call	fourbit2str
0115+  C0C9             ;---------------
0116+  C0C9 06 0D       		ld	b,colorInfo
0117+  C0CB 0E 10       		ld	c,16
0118+  C0CD CD 6E 81    		call	getMouseButtons
0119+  C0D0 E6 01       		and	%00000001
0120+  C0D2 FE 01       		cp	%00000001
0121+  C0D4 78          		ld	a,b
0122+  C0D5 20 01       		jr	nz,miceLSet
0123+  C0D7 79          		ld	a,c
0124+  C0D8 32 2C C2    miceLSet	ld	(leftButtonMsg),a
0125+  C0DB             
0126+  C0DB CD 6E 81    		call	getMouseButtons
0127+  C0DE E6 02       		and	%00000010
0128+  C0E0 FE 02       		cp	%00000010
0129+  C0E2 78          		ld	a,b
0130+  C0E3 20 01       		jr	nz,miceRSet
0131+  C0E5 79          		ld	a,c
0132+  C0E6 32 32 C2    miceRSet	ld	(rightButtonMsg),a
0133+  C0E9             
0134+  C0E9 CD 6E 81    		call	getMouseButtons
0135+  C0EC E6 04       		and	%00000100
0136+  C0EE FE 04       		cp	%00000100
0137+  C0F0 78          		ld	a,b
0138+  C0F1 20 01       		jr	nz,miceMSet
0139+  C0F3 79          		ld	a,c
0140+  C0F4 32 2F C2    miceMSet	ld	(middleButtonMsg),a
0141+  C0F7             
0142+  C0F7 21 EF C1    		ld 	hl,micePosMsg
0143+  C0FA CD 75 80    		call	printInLine
0144+  C0FD             
0145+  C0FD C3 1F C0    		jp	miceLoop
0146+  C100             
0147+  C100 CD 6F 80    miceStop	call	editInit
0148+  C103             
0149+  C103 CD 2C 81    		call	disableSprites
0150+  C106             
0151+  C106 AF          		xor	a
0152+  C107 CD 63 80    		call	setScreen
0153+  C10A             		;call	clearGfxScreen
0154+  C10A             		
0155+  C10A 21 E4 C1    		ld	hl,miceExitMsg
0156+  C10D CD 60 80    		call	printString
0157+  C110             
0158+  C110 21 4B 9B    		ld	hl,restoreMsg
0159+  C113 CD 60 80    		call	printString
0160+  C116             
0161+  C116 AF          		xor	a			; no error, clean exit!
0162+  C117 C9          		ret
0163+  C118             ;-----------------------------------------------------------------------------------------------------------------------------------------------------------
0164+  C118 01 AF 10    prepareCursor	ld	bc,RAMPage0		; Подключаем страницу sprBank адреса #0000
0165+  C11B 3E 08       		ld	a,sprBank
0166+  C11D ED 79       		out	(c),a
0167+  C11F             
0168+  C11F 21 00 00    		ld	hl,#0000
0169+  C122 11 01 00    		ld	de,#0001
0170+  C125 01 FF 3F    		ld	bc,#3fff
0171+  C128 AF          		xor	a
0172+  C129 77          		ld	(hl),a
0173+  C12A ED B0       		ldir
0174+  C12C             
0175+  C12C 21 71 C2    		ld	hl,miceCursor
0176+  C12F 11 00 00    		ld	de,#0000
0177+  C132 06 0B       		ld	b,11
0178+  C134 C5          prepareLoop	push	bc
0179+  C135 01 06 00    		ld	bc,6
0180+  C138 ED B0       		ldir
0181+  C13A EB          		ex	de,hl
0182+  C13B 01 FA 00    		ld	bc,250
0183+  C13E 09          		add	hl,bc
0184+  C13F EB          		ex	de,hl
0185+  C140 C1          		pop	bc
0186+  C141 10 F1       		djnz	prepareLoop
0187+  C143             
0188+  C143 01 AF 19    		ld	bc,SGPage		; Указываем страницу для спрайтов
0189+  C146 3E 08       		ld	a,sprBank
0190+  C148 ED 79       		out	(c),a
0191+  C14A             
0192+  C14A 01 AF 10    		ld	bc,RAMPage0		; Подключаем страницу sprBank адреса #0000
0193+  C14D 3A 00 60    		ld	a,(_PAGE0)		; Восстанавливаем банку для WildCommander
0194+  C150 ED 79       		out	(c),a
0195+  C152             
0196+  C152 01 AF 15    updateCursor	ld	bc,FMAddr
0197+  C155 3E 10       		ld 	a,%00010000		; Разрешить приём данных (?) Bit 4 - FM_EN установлен
0198+  C157 ED 79       		out	(c),a
0199+  C159             
0200+  C159 21 6B C2    		ld	hl,cursorSFile
0201+  C15C 11 00 02    		ld 	de,#0000+512		; Память с палитрой замапливается на адрес #0000
0202+  C15F 01 06 00    		ld	bc,6
0203+  C162 ED B0       		ldir
0204+  C164             
0205+  C164 01 AF 15    		ld	bc,FMAddr
0206+  C167 AF          		xor	a			; Запретить, Bit 4 - FM_EN сброшен
0207+  C168 ED 79       		out	(c),a
0208+  C16A             
0209+  C16A 01 AF 06    		ld	bc,TSConfig		; Включаем отображение спрайта
0210+  C16D             			  ;76543210
0211+  C16D 3E 80       		ld	a,%10000000		; bit 7 - S_EN Sprite Layers Enable
0212+  C16F ED 79       		out	(c),a
0213+  C171             
0214+  C171 C9          		ret
0215+  C172             ;---------------------------------------
0216+  C172             miceInfoMsg	db	16,2,"Kempstone mouse test v 0.01",#0d
0216+  C172 10024B656D7073746F6E65206D6F7573652074657374207620302E30310D
0217+  C190             		db	16,3,"2013 ",#7f," Breeze\\\\Fishbone Crew",#0d,#0d,#00
0217+  C190 100332303133207F20427265657A655C5C46697368626F6E6520437265770D0D
0217+  C1B0 00
0218+  C1B1             
0219+  C1B1 10 0D       miceRunMsg	db	16,colorInfo
0220+  C1B3             		db	"(\\\\/)",#0d
0220+  C1B3 285C5C2F290D
0221+  C1B9             		db	" \\\\/\\\\",#0d
0221+  C1B9 205C5C2F5C5C0D
0222+  C1C0             		db	" /__)",#0d
0222+  C1C0 202F5F5F290D
0223+  C1C6             		db	"   (_  Move your mouse...",#0d,#0d
0223+  C1C6 202020285F20204D6F766520796F7572206D6F7573652E2E2E0D0D
0224+  C1E1 10 10       		db	16,16
0225+  C1E3 00          		db	#00
0226+  C1E4             
0227+  C1E4             miceExitMsg	db	16,colorInfo,"Exit.",#0d
0227+  C1E4 100D457869742E0D
0228+  C1EC 10 10       		db	16,16
0229+  C1EE 00          		db	#00
0230+  C1EF             
0231+  C1EF             micePosMsg	db	16,colorOk,"Raw: X=",16,16,"+"
0231+  C1EF 100C5261773A20583D10102B
0232+  C1FB             rawXMsg		db	"---[---]"
0232+  C1FB 2D2D2D5B2D2D2D5D
0233+  C203             
0234+  C203             		db	16,14,", ",16,colorOk,"Y=",16,16,"+"
0234+  C203 100E2C20100C593D10102B
0235+  C20E             rawYMsg		db	"---[---]"
0235+  C20E 2D2D2D5B2D2D2D5D
0236+  C216             
0237+  C216             		db	16,14,", ",16,colorOk,"wheel=",16,16
0237+  C216 100E2C20100C776865656C3D1010
0238+  C224 2D 2D       posWheelMsg	db	"--"
0239+  C226             
0240+  C226 100E207C20  		db	16,14," | "
0241+  C22B 10          		db	16
0242+  C22C 0D 4C       leftButtonMsg	db	colorInfo,"L"
0243+  C22E 10          		db	16
0244+  C22F 0D 4D       middleButtonMsg	db	colorInfo,"M"
0245+  C231 10          		db	16
0246+  C232 0D 42       rightButtonMsg	db	colorInfo,"B"
0247+  C234             
0248+  C234             		db	16,14," | ",16,colorOk,"Pos: X=",16,16
0248+  C234 100E207C20100C506F733A20583D1010
0249+  C244 2D2D2D2D2D  posXMsg		db	"-----"
0250+  C249             
0251+  C249             		db	16,14,", ",16,colorOk,"Y=",16,16
0251+  C249 100E2C20100C593D1010
0252+  C253 2D2D2D2D2D  posYMsg		db	"-----"
0253+  C258             		
0254+  C258             		db	16,14," | ",16,colorOk,"T=",16,16
0254+  C258 100E207C20100C543D1010
0255+  C263 2D2D2D2D2D  timeCountMsg	db	"-----"
0256+  C268 00          		db	#00
0257+  C269             
0258+  C269             ;---------------
0259+  C269 00 00       timeCount	dw	#0000
0260+  C26B             ;---------------
0261+  C26B 00          cursorSFile	db	#00			; Y0-7     | 8 bit младшие даные Y координаты (0-255px)
0262+  C26C             			;FLAR S Y8
0263+  C26C 22          		db	%00100010		; Y8       | 0й бит - старшие данные Y координаты (256px >)
0264+  C26D             						; YS       | 1,2,3 бит - высота в блоках по 8 px
0265+  C26D             						; RESERVED | 4й бит - зарезервирован
0266+  C26D             						; ACT      | 5й бит - спрайт активен (показывается)
0267+  C26D             						; LEAP     | 6й бит - указывает, что данный спрайт последний в текущем слое. (для перехода по слоям)
0268+  C26D             						; YF       | 7й бит - указывает, что данный спрайт нужно отобразить зеркально по вертикали
0269+  C26D             		
0270+  C26D 00          cursorSFileX	db	#00			; X0-7     | 8 bit младшие даные X координаты (0-255px)
0271+  C26E             			;F  R S X8
0272+  C26E 02          		db	%00000010		; X8       | 0й бит - старшие данные X координаты (256px >)
0273+  C26F             						; XS       | 1,2,3 бит - ширина в блоках по 8 px
0274+  C26F             						; RESERVED | 4й бит - зарезервирован
0275+  C26F             						; -        | 5,6й бит - не используются
0276+  C26F             						; XF       | 7й бит - указывает, что данный спрайт нужно отобразить зеркально по горизонтали
0277+  C26F             			;TNUM
0278+  C26F 00          		db	%00000000		; TNUM	   | Номер тайла для левого верхнего угла.
0279+  C270             						;          | 0,1,2,3,4,5й бит - Х координата в битмап
0280+  C270             			;SPALTNUM		;          | 6,7й бит +
0281+  C270 10          		db	%00010000		; TNUM     | 0,1,2,3 бит - Y координата в битмап
0282+  C271             						; SPAL     | 4,5,6,7й биты номер палитры (?)
0283+  C271             
0284+  C271             miceCursor	db	#be,#00,#00,#00,#00,#00
0284+  C271 BE0000000000
0285+  C277             		db	#1b,#ee,#00,#00,#00,#00
0285+  C277 1BEE00000000
0286+  C27D             		db	#01,#bb,#ee,#00,#00,#00
0286+  C27D 01BBEE000000
0287+  C283             		db	#01,#bb,#bb,#ee,#00,#00
0287+  C283 01BBBBEE0000
0288+  C289             		db	#00,#1b,#bb,#bb,#ee,#00
0288+  C289 001BBBBBEE00
0289+  C28F             		db	#00,#1b,#bb,#bb,#bb,#00
0289+  C28F 001BBBBBBB00
0290+  C295             		db	#00,#01,#bb,#be,#00,#00
0290+  C295 0001BBBE0000
0291+  C29B             		db	#00,#01,#bb,#1b,#e0,#00
0291+  C29B 0001BB1BE000
0292+  C2A1             		db	#00,#00,#1b,#01,#be,#00
0292+  C2A1 00001B01BE00
0293+  C2A7             		db	#00,#00,#1b,#00,#1b,#e0
0293+  C2A7 00001B001BE0
0294+  C2AD             		db	#00,#00,#00,#00,#01,#b0
0294+  C2AD 0000000001B0
0295+  C2B3             		db	#00,#00,#00,#00,#00,#00
0295+  C2B3 000000000000
0296+  C2B9              		db	#00,#00,#00,#00,#00,#00
0296+  C2B9 000000000000
0297+  C2BF              		db	#00,#00,#00,#00,#00,#00
0297+  C2BF 000000000000
0298+  C2C5              		db	#00,#00,#00,#00,#00,#00
0298+  C2C5 000000000000
0299+  C2CB              		db	#00,#00,#00,#00,#00,#00
0299+  C2CB 000000000000
0300+  C2D1             
0301+  C2D1 00          miceTestEnd	nop
0302+  C2D2             
0077   C2D2             
0078   C2D2             		;include "zx.pal.asm"
0079   C2D2             		;include "cli.pal.asm"
0080   C2D2             		;include "boing.pal.asm"
0081   C2D2             
0082   C2D2             	;DISPLAY "code size:",/A,endCode-startCode
0083   C2D2             	;DISPLAY "waitResponse addr:",/A,waitResponse
0084   C2D2             	;DISPLAY "ttt addr:",/A,ttt
0085   C2D2             	;DISPLAY "executeApp addr:",/A,executeApp
0086   C2D2             	;DISPLAY "checkIsBin addr:",/A,checkIsBin
0087   C2D2             	;DISPLAY "pathString addr:",/A,pathString
0088   C2D2             	;DISPLAY "checkCallLoop addr:",/A,checkCallLoop
0089   C2D2             	
0090   C2D2             
0091   C2D2             	SAVEBIN "bin/wc/CLI.WMF", startCode, endCode-startCode
0092   C2D2             	;SAVEBIN "bin/bin/hello", appStart, appEnd-appStart
0093   C2D2             	;SAVEBIN "bin/bin/test1", test1Start, test1End-test1Start
0094   C2D2             	;SAVEBIN "bin/demo/boing/boing", BoingStart, BoingEnd-BoingStart
0095   C2D2             	;SAVEBIN "bin/bin/test2", test2Start, test2End-test2Start
0096   C2D2             	;SAVEBIN "bin/bin/test3", t3Start, t3End-t3Start
0097   C2D2             	;SAVEBIN "bin/bin/test4", t4Start, t4End-t4Start
0098   C2D2             	;SAVEBIN "bin/bin/type", typeStart, typeEnd-typeStart
0099   C2D2             	;SAVEBIN "bin/bin/loadMod", loadModStart, loadModEnd-loadModStart
0100   C2D2             	SAVEBIN "bin/bin/miceTest", miceTestStart, miceTestEnd-miceTestStart
0101   C2D2             	
0102   C2D2             
0103   C2D2             	;SAVEBIN "bin/system/pal/zx.pal", zxPalStart, zxPalEnd-zxPalStart
0104   C2D2             	;SAVEBIN "bin/system/pal/cli.pal", cliPalStart, cliPalEnd-cliPalStart
0105   C2D2             	;SAVEBIN "bin/demo/boing/boing.pal", boingPalStart, boingPalEnd-boingPalStart
0106   C2D2             
0107   C2D2             
